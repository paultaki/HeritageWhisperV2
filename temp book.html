<html lang="en"><head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Premium Book Mockup</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&amp;display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link id="all-fonts-link-font-geist" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Geist:wght@300;400;500;600;700&amp;display=swap"><style id="all-fonts-style-font-geist">.font-geist { font-family: 'Geist', sans-serif !important; }</style><link id="all-fonts-link-font-roboto" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&amp;display=swap"><style id="all-fonts-style-font-roboto">.font-roboto { font-family: 'Roboto', sans-serif !important; }</style><link id="all-fonts-link-font-montserrat" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&amp;display=swap"><style id="all-fonts-style-font-montserrat">.font-montserrat { font-family: 'Montserrat', sans-serif !important; }</style><link id="all-fonts-link-font-poppins" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&amp;display=swap"><style id="all-fonts-style-font-poppins">.font-poppins { font-family: 'Poppins', sans-serif !important; }</style><link id="all-fonts-link-font-playfair" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700;900&amp;display=swap"><style id="all-fonts-style-font-playfair">.font-playfair { font-family: 'Playfair Display', serif !important; }</style><link id="all-fonts-link-font-instrument-serif" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Instrument+Serif:wght@400;500;600;700&amp;display=swap"><style id="all-fonts-style-font-instrument-serif">.font-instrument-serif { font-family: 'Instrument Serif', serif !important; }</style><link id="all-fonts-link-font-merriweather" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700;900&amp;display=swap"><style id="all-fonts-style-font-merriweather">.font-merriweather { font-family: 'Merriweather', serif !important; }</style><link id="all-fonts-link-font-bricolage" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:wght@300;400;500;600;700&amp;display=swap"><style id="all-fonts-style-font-bricolage">.font-bricolage { font-family: 'Bricolage Grotesque', sans-serif !important; }</style><link id="all-fonts-link-font-jakarta" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&amp;display=swap"><style id="all-fonts-style-font-jakarta">.font-jakarta { font-family: 'Plus Jakarta Sans', sans-serif !important; }</style><link id="all-fonts-link-font-manrope" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&amp;display=swap"><style id="all-fonts-style-font-manrope">.font-manrope { font-family: 'Manrope', sans-serif !important; }</style><link id="all-fonts-link-font-space-grotesk" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&amp;display=swap"><style id="all-fonts-style-font-space-grotesk">.font-space-grotesk { font-family: 'Space Grotesk', sans-serif !important; }</style><link id="all-fonts-link-font-work-sans" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@300;400;500;600;700;800&amp;display=swap"><style id="all-fonts-style-font-work-sans">.font-work-sans { font-family: 'Work Sans', sans-serif !important; }</style><link id="all-fonts-link-font-pt-serif" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=PT+Serif:wght@400;700&amp;display=swap"><style id="all-fonts-style-font-pt-serif">.font-pt-serif { font-family: 'PT Serif', serif !important; }</style><link id="all-fonts-link-font-geist-mono" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Geist+Mono:wght@300;400;500;600;700&amp;display=swap"><style id="all-fonts-style-font-geist-mono">.font-geist-mono { font-family: 'Geist Mono', monospace !important; }</style><link id="all-fonts-link-font-space-mono" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&amp;display=swap"><style id="all-fonts-style-font-space-mono">.font-space-mono { font-family: 'Space Mono', monospace !important; }</style><link id="all-fonts-link-font-quicksand" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&amp;display=swap"><style id="all-fonts-style-font-quicksand">.font-quicksand { font-family: 'Quicksand', sans-serif !important; }</style><link id="all-fonts-link-font-nunito" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;500;600;700;800&amp;display=swap"><style id="all-fonts-style-font-nunito">.font-nunito { font-family: 'Nunito', sans-serif !important; }</style></head>
    <body class="min-h-screen antialiased selection:bg-indigo-500/30 selection:text-indigo-100 text-slate-200 bg-[#0b0d12]">
      <!-- Top progress bar -->
      <div id="progressBar" class="fixed top-0 left-0 right-0 z-50">
        <div class="mx-auto max-w-[1800px] px-6">
          <div class="relative h-8 flex items-center">
            <div id="progressTrack" class="h-1.5 w-full rounded-full bg-white/10 overflow-hidden ring-1 ring-white/10 cursor-pointer" title="">
              <div id="progressFill" class="h-full w-0 bg-indigo-400/70" style="width:0%"></div>
            </div>
            <div id="progressTooltip" class="absolute top-8 left-0 translate-x-[-50%] whitespace-nowrap rounded-md bg-white/95 text-slate-900 text-xs px-2 py-1 shadow-lg ring-1 ring-black/10 hidden"></div>
          </div>
        </div>
      </div>
    
      <div class="md:py-12 max-w-[1800px] mr-auto ml-auto pt-12 pr-6 pb-8 pl-6">
        <!-- Header -->
        <div class="mx-auto max-w-[1600px] mb-8 md:mb-10">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="h-8 w-8 grid place-items-center rounded-md ring-1 bg-white/5 ring-white/10">
                <span class="text-xs font-semibold tracking-tight">BK</span>
              </div>
              <div>
                <h1 class="text-2xl md:text-3xl tracking-tight font-semibold text-white">Premium Book Mockup</h1>
                <p class="text-sm text-slate-400">Editable pages • True-to-life layering • 5.5×8.5 per page (8.5×11 spread)</p>
              </div>
            </div>
            <div class="hidden md:flex items-center gap-2 text-sm text-slate-300">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4.5 w-4.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4Z"></path>
              </svg>
              <span class="text-slate-400">Click and type to edit</span>
            </div>
          </div>
    
          <!-- Tools -->
          <div class="mt-4 flex items-center gap-2">
            <button id="btnToc" class="inline-flex items-center gap-2 rounded-md bg-white/5 px-3 py-2 text-sm ring-1 ring-white/10 hover:bg-white/10 hover:ring-white/20">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4.5 w-4.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 6h16"></path><path d="M4 12h16"></path><path d="M4 18h16"></path></svg>
              <span>Table of contents</span>
            </button>
            <button id="btnImage" class="inline-flex items-center gap-2 rounded-md bg-white/5 px-3 py-2 text-sm ring-1 ring-white/10 hover:bg-white/10 hover:ring-white/20">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4.5 w-4.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><path d="m21 15-5-5L5 21"></path></svg>
              <span>Insert photo</span>
            </button>
            <input id="imageInput" type="file" accept="image/*" class="hidden">
          </div>
        </div>
    
        <!-- Desktop: Dual-page spread -->
        <div class="relative mx-auto hidden lg:block" style="max-width: min(95vw, 1600px);">
          <!-- Stage and book container -->
          <div id="stage" class="relative mx-auto w-full aspect-[110/85] [perspective:2000px]">
            <!-- Ambient shadow/vignette -->
            <div class="pointer-events-none absolute -inset-8 rounded-2xl bg-[radial-gradient(1000px_400px_at_50%_30%,rgba(59,130,246,0.08)_0%,rgba(59,130,246,0.04)_35%,transparent_70%)]"></div>
            <div class="pointer-events-none absolute inset-0 rounded-2xl shadow-[0_40px_120px_-30px_rgba(0,0,0,0.6)]"></div>
    
            <!-- Outer book cover/border -->
            <div aria-hidden="true" class="pointer-events-none absolute rounded-[28px]" style="inset:-14px; background: linear-gradient(180deg, #2e1f14 0%, #1f150d 100%); box-shadow: 0 20px 60px rgba(0,0,0,0.5), inset 0 0 0 1px rgba(255,255,255,0.04);"></div>
    
            <!-- Left page stack -->
            <div class="absolute inset-y-0 left-0 w-1/2 [transform-style:preserve-3d]">
              <!-- Page stack layers (thin offset sheets) -->
              <div class="absolute inset-0 translate-y-0.5 -translate-x-0.5 scale-[0.998] rounded-[18px] ring-1 shadow-[inset_0_0_0_1px_rgba(255,255,255,0.4)] opacity-70 bg-neutral-50 ring-black/10"></div>
              <div class="absolute inset-0 translate-y-1 -translate-x-[3px] scale-[0.996] rounded-[18px] ring-1 shadow-[inset_0_0_0_1px_rgba(255,255,255,0.35)] opacity-55 bg-neutral-50 ring-black/10"></div>
              <div class="-translate-x-[6px] bg-neutral-50 opacity-35 ring-black/10 ring-1 rounded-[18px] absolute top-0 right-0 bottom-0 left-0 shadow-[inset_0_0_0_1px_rgba(255,255,255,0.3)] translate-y-[6px] scale-[0.992]"></div>
    
              <!-- Main page -->
              <div class="relative h-full w-full rounded-[20px] ring-1 shadow-2xl overflow-hidden [transform:rotateY(3deg)_translateZ(0.001px)] ring-black/15 bg-neutral-50">
                <!-- Paper texture/vignette -->
                <div class="absolute inset-0 pointer-events-none" style="background-image:
                     radial-gradient(160% 85% at 110% 50%, rgba(0,0,0,0.07) 0%, rgba(0,0,0,0) 55%),
                     radial-gradient(120% 60% at -10% 50%, rgba(0,0,0,0.08) 0%, rgba(0,0,0,0) 58%),
                     linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.85));">
                </div>
                <!-- Inner gutter shadow -->
                <div class="absolute inset-y-0 right-0 w-10 pointer-events-none bg-gradient-to-l to-transparent from-black/12 via-black/6"></div>
                <!-- Outer edge lines -->
                <div class="absolute inset-y-0 left-0 w-3 pointer-events-none" style="background-image:repeating-linear-gradient(90deg, rgba(0,0,0,0.1) 0px, rgba(0,0,0,0.1) 1px, transparent 1px, transparent 2px); opacity:.25"></div>
    
                <!-- Keep original content structure -->
                <div class="md:p-8 lg:p-10 w-full h-full pt-7 pr-7 pb-7 pl-7 relative">
                  <div class="h-full w-full rounded-[14px] ring-1 backdrop-blur-[0.5px] ring-black/5 bg-white/60"></div>
                  <div class="absolute bottom-3 left-0 right-0 flex justify-between px-8 text-[12px] text-neutral-500/80">
                    <span id="pageNumLeft" class="tracking-tight">1</span>
                  </div>
                </div>
              </div>
            </div>
    
            <!-- Right page stack -->
            <div class="absolute inset-y-0 right-0 w-1/2 [transform-style:preserve-3d]">
              <!-- Page stack layers -->
              <div class="absolute inset-0 translate-y-0.5 translate-x-0.5 scale-[0.998] rounded-[18px] ring-1 shadow-[inset_0_0_0_1px_rgba(255,255,255,0.4)] opacity-70 bg-neutral-50 ring-black/10"></div>
              <div class="absolute inset-0 translate-y-1 translate-x-[3px] scale-[0.996] rounded-[18px] ring-1 shadow-[inset_0_0_0_1px_rgba(255,255,255,0.35)] opacity-55 bg-neutral-50 ring-black/10"></div>
              <div class="absolute inset-0 translate-y-[6px] translate-x-[6px] scale-[0.992] rounded-[18px] ring-1 shadow-[inset_0_0_0_1px_rgba(255,255,255,0.3)] opacity-35 bg-neutral-50 ring-black/10"></div>
    
              <!-- Main page -->
              <div class="relative h-full w-full rounded-[20px] ring-1 shadow-2xl overflow-hidden [transform:rotateY(-3deg)_translateZ(0.001px)] ring-black/15 bg-neutral-50">
                <!-- Paper texture/vignette -->
                <div class="absolute inset-0 pointer-events-none" style="background-image:
                     radial-gradient(160% 85% at -10% 50%, rgba(0,0,0,0.07) 0%, rgba(0,0,0,0) 55%),
                     radial-gradient(120% 60% at 110% 50%, rgba(0,0,0,0.08) 0%, rgba(0,0,0,0) 58%),
                     linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.85));">
                </div>
                <!-- Inner gutter shadow -->
                <div class="absolute inset-y-0 left-0 w-10 pointer-events-none bg-gradient-to-r to-transparent from-black/12 via-black/6"></div>
                <!-- Outer edge lines -->
                <div class="absolute inset-y-0 right-0 w-3 pointer-events-none" style="background-image:repeating-linear-gradient(270deg, rgba(0,0,0,0.1) 0px, rgba(0,0,0,0.1) 1px, transparent 1px, transparent 2px); opacity:.25"></div>
    
                <!-- Keep original content structure -->
                <div class="relative h-full w-full p-7 md:p-8 lg:p-10">
                  <div class="h-full w-full rounded-[14px] ring-1 backdrop-blur-[0.5px] ring-black/5 bg-white/60"></div>
                  <div class="absolute bottom-3 left-0 right-0 flex justify-between px-8 text-[12px] text-neutral-500/80">
                    <span class="tracking-tight"></span>
                    <span id="pageNumRight" class="tracking-tight">2</span>
                  </div>
                </div>
              </div>
            </div>
    
            <!-- Refined spine -->
            <div class="pointer-events-none absolute inset-y-0 left-1/2 -translate-x-1/2 w-12 md:w-14 lg:w-16">
              <div class="absolute inset-y-6 left-0 w-1/2 bg-gradient-to-r from-black/30 via-black/10 to-transparent opacity-20"></div>
              <div class="absolute inset-y-6 right-0 w-1/2 bg-gradient-to-l from-black/30 via-black/10 to-transparent opacity-20"></div>
              <div class="absolute inset-y-6 left-1/2 -translate-x-1/2 w-px bg-white/70 opacity-60"></div>
              <div class="absolute inset-y-6 left-1/2 -translate-x-1/2 w-0.5 opacity-20 shadow-[inset_1px_0_0_rgba(0,0,0,0.35),0_0_0_1px_rgba(255,255,255,0.45)]"></div>
              <div class="absolute left-1/2 -translate-x-1/2 top-3 h-1.5 w-14 rounded-sm ring-1 ring-black/10 shadow-sm" style="background: repeating-linear-gradient(90deg, rgba(59,130,246,0.25) 0 6px, rgba(99,102,241,0.25) 6px 12px, rgba(16,185,129,0.25) 12px 18px, rgba(253,186,116,0.25) 18px 24px, rgba(244,63,94,0.25) 24px 30px);"></div>
              <div class="absolute left-1/2 -translate-x-1/2 bottom-3 h-1.5 w-14 rounded-sm ring-1 ring-black/10 shadow-sm" style="background: repeating-linear-gradient(90deg, rgba(59,130,246,0.25) 0 6px, rgba(99,102,241,0.25) 6px 12px, rgba(16,185,129,0.25) 12px 18px, rgba(253,186,116,0.25) 18px 24px, rgba(244,63,94,0.25) 24px 30px);"></div>
            </div>
    
            <!-- Separate page editors (single-page scrolling per side) -->
            <div id="flowWrap" class="absolute inset-0 z-10 pointer-events-none">
              <!-- Left page content area -->
              <div id="flowMaskLeft" class="absolute pointer-events-none overflow-hidden" style="left:2.6%; right:52.6%; top:6.5%; bottom:10%;">
                <div id="flowLeft" contenteditable="true" spellcheck="false" class="js-flow h-full w-full rounded-[12px] ring-1 ring-black/5 bg-white/0 text-neutral-900 pointer-events-auto outline-none p-6 overflow-y-auto" style="scrollbar-width: none; -ms-overflow-style: none; scroll-behavior: smooth;">
                  <h2 class="text-2xl tracking-tight font-semibold mb-3">Chapter 1 — Arrival</h2>
                  <p class="text-[15.5px] leading-7 text-neutral-800/95 mb-3">
                    Start writing here. This page now scrolls internally, so the entire chapter stays on a single page. The scrollbar is hidden and only appears as a subtle indicator while scrolling.
                  </p>
                  <p class="text-[15.5px] leading-7 text-neutral-800/95 mb-3">
                    You can insert images and the text will wrap around them. Use the Insert photo tool above—caption is editable too.
                  </p>
                  <p class="text-[15.5px] leading-7 text-neutral-800/95 mb-3">
                    Keep paragraphs concise for readability. Add more content to see the auto-hiding scroll indicator appear on scroll.
                  </p>
                  <p class="text-[15.5px] leading-7 text-neutral-800/95 mb-3">
                    Lorem ipsum dolor sit amet, consectetur adipiscing elit. Phasellus porttitor, augue in rhoncus bibendum, justo nisl maximus lectus, sed accumsan justo nisi in massa. Donec venenatis, mauris at blandit porta, ipsum nunc varius nibh, vitae pharetra odio tortor vitae velit. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia curae; Sed fringilla posuere nibh, id gravida enim aliquet et. Vivamus laoreet blandit tellus, vitae porta urna aliquet at.
                  </p>
                  <p class="text-[15.5px] leading-7 text-neutral-800/95 mb-3">
                    Integer ultricies, nulla a mattis efficitur, lectus tortor sagittis velit, nec volutpat erat erat et mi. Proin commodo molestie arcu at congue. Aenean congue hendrerit urna, eu aliquet arcu facilisis ut. In hac habitasse platea dictumst. Suspendisse potenti. Donec non semper nibh.
                  </p>
                  <p class="text-[15.5px] leading-7 text-neutral-800/95 mb-3">
                    Curabitur sit amet ipsum pharetra, finibus lorem ac, accumsan orci. Vestibulum congue nunc ac nunc vulputate, sed laoreet urna vestibulum. Suspendisse tristique augue id sem sollicitudin, id pulvinar felis tincidunt.
                  </p>
                </div>
                <!-- Conditional fade + prompt (injected/controlled by JS) -->
              </div>
    
              <!-- Right page content area -->
              <div id="flowMaskRight" class="absolute pointer-events-none overflow-hidden" style="left:52.6%; right:2.6%; top:6.5%; bottom:10%;">
                <div id="flowRight" contenteditable="true" spellcheck="false" class="js-flow h-full w-full rounded-[12px] ring-1 ring-black/5 bg-white/0 text-neutral-900 pointer-events-auto outline-none p-6 overflow-y-auto" style="scrollbar-width: none; -ms-overflow-style: none; scroll-behavior: smooth;">
                  <h2 class="text-2xl tracking-tight font-semibold mb-3">Chapter 2 — Crossing</h2>
                  <p class="text-[15.5px] leading-7 text-neutral-800/95 mb-3">
                    This page is also a single, scrolling chapter. Use the TOC to jump to sections within the chapter.
                  </p>
                  <p class="text-[15.5px] leading-7 text-neutral-800/95 mb-3">
                    Tip: press Enter to add paragraphs; use Shift+Enter for soft line breaks; paste images or use the Insert photo tool for wrapping behavior.
                  </p>
                  <p class="text-[15.5px] leading-7 text-neutral-800/95 mb-3">
                    Add more content to test the scroll indicator. It appears only during active scrolling and fades out automatically.
                  </p>
                  <p class="text-[15.5px] leading-7 text-neutral-800/95 mb-3">
                    Lorem ipsum dolor sit amet, consectetur adipisicing elit. Omnis, totam aliquid. Saepe vitae sed consectetur, eligendi laborum a iusto impedit sunt optio fugiat, quas harum? Laboriosam veritatis, quos nihil praesentium.
                  </p>
                  <p class="text-[15.5px] leading-7 text-neutral-800/95 mb-3">
                    Lorem ipsum dolor sit amet, consectetur adipiscing elit. Phasellus porttitor, augue in rhoncus bibendum, justo nisl maximus lectus, sed accumsan justo nisi in massa. Donec venenatis, mauris at blandit porta, ipsum nunc varius nibh, vitae pharetra odio tortor vitae velit.
                  </p>
                </div>
                <!-- Conditional fade + prompt (injected/controlled by JS) -->
              </div>
    
              <!-- Offscreen page pool (unused now) -->
              <div id="pagePool" class="hidden"></div>
            </div>
    
            <!-- Margin click navigation -->
            <button id="navPrev" class="absolute inset-y-0 left-0 w-[8%] z-20 bg-transparent hover:bg-black/5 transition-colors" title="Previous pages"></button>
            <button id="navNext" class="absolute inset-y-0 right-0 w-[8%] z-20 bg-transparent hover:bg-black/5 transition-colors" title="Next pages"></button>
    
            <!-- Ground shadow -->
            <div class="pointer-events-none absolute -bottom-10 left-1/2 -translate-x-1/2 h-16 w-[80%] rounded-[100%] blur-2xl bg-black/60"></div>
          </div>
        </div>
    
        <!-- Mobile & Tablet: Single page with horizontal swipe to advance -->
        <div class="lg:hidden">
          <div class="mb-4 flex items-center justify-between">
            <div class="flex items-center gap-2 text-sm text-slate-300">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4.5 w-4.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4Z"></path>
              </svg>
              <span class="text-slate-400">Tap and type to edit</span>
            </div>
            <div class="text-xs text-slate-400">Swipe left/right to advance</div>
          </div>
    
          <div class="relative -mx-2 px-2">
            <!-- Mobile prev/next controls -->
            <button id="mobilePrev" class="absolute left-0 top-1/2 -translate-y-1/2 z-10 ml-1 h-9 w-9 rounded-full bg-white/10 ring-1 ring-white/15 hover:bg-white/15 active:bg-white/20 grid place-items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4.5 w-4.5 text-white/90" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="m15 18-6-6 6-6"></path></svg>
            </button>
            <button id="mobileNext" class="absolute right-0 top-1/2 -translate-y-1/2 z-10 mr-1 h-9 w-9 rounded-full bg-white/10 ring-1 ring-white/15 hover:bg-white/15 active:bg-white/20 grid place-items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4.5 w-4.5 text-white/90" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="m9 18 6-6-6-6"></path></svg>
            </button>
    
            <div id="mobileScroller" class="flex snap-x snap-mandatory overflow-x-auto gap-6 pb-4">
              <!-- Single Page (template 1) -->
              <div class="mobile-page relative mx-auto w-[min(92vw,520px)] aspect-[55/85] snap-center shrink-0 [perspective:1600px]">
                <!-- Outer book cover/border -->
                <div aria-hidden="true" class="pointer-events-none absolute rounded-[24px]" style="inset:-12px; background: linear-gradient(180deg, #2e1f14 0%, #1f150d 100%); box-shadow: 0 18px 50px rgba(0,0,0,0.45), inset 0 0 0 1px rgba(255,255,255,0.04);"></div>
    
                <div class="absolute inset-0 translate-y-[5px] -translate-x-[5px] scale-[0.994] rounded-[18px] ring-1 opacity-35 bg-neutral-50 ring-black/10"></div>
                <div class="relative h-full w-full rounded-[20px] ring-1 shadow-2xl overflow-hidden [transform:rotateY(2.2deg)_translateZ(0.001px)] ring-black/15 bg-neutral-50">
                  <div class="absolute inset-0" style="background-image:
                       radial-gradient(120% 65% at 110% 50%, rgba(0,0,0,0.08) 0%, rgba(0,0,0,0) 60%),
                       linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.9));">
                  </div>
                  <div class="absolute inset-y-0 right-0 w-8 pointer-events-none bg-gradient-to-l to-transparent from-black/10 via-black/5"></div>
                  <div class="absolute inset-y-0 left-0 w-3 pointer-events-none" style="background-image:repeating-linear-gradient(90deg, rgba(0,0,0,0.1) 0px, rgba(0,0,0,0.1) 1px, transparent 1px, transparent 2px); opacity:.22"></div>
    
                  <div class="relative h-full w-full p-6">
                    <div class="js-mask h-full w-full rounded-[14px] ring-1 ring-black/5 bg-white/60">
                      <div id="mobileFlow1" contenteditable="true" spellcheck="false" tabindex="0" class="js-flow h-full w-full rounded-[12px] text-neutral-900 outline-none p-5 overflow-y-auto" style="scrollbar-width: none; -ms-overflow-style: none; scroll-behavior: smooth;">
                        <h2 class="mb-2.5 text-[19px] tracking-tight font-semibold text-neutral-900">
                          Page 1 — Title
                        </h2>
                        <p class="text-[14.5px] leading-6 text-neutral-800/95 mb-2.5">
                          Write your content here. This page scrolls internally and supports images with captions.
                        </p>
                        <p class="text-[14.5px] leading-6 text-neutral-800/95 mb-2.5">
                          Tip: Use the button above to insert a photo. You can float it left/right or center it.
                        </p>
                      </div>
                    </div>
                    <div class="absolute bottom-3 left-0 right-0 px-6 text-right text-[12px] text-neutral-500/80 mobilePageNum">1</div>
                  </div>
                </div>
              </div>
    
              <!-- Single Page (template 2) -->
              <div class="mobile-page relative mx-auto w-[min(92vw,520px)] aspect-[55/85] snap-center shrink-0 [perspective:1600px]">
                <!-- Outer book cover/border -->
                <div aria-hidden="true" class="pointer-events-none absolute rounded-[24px]" style="inset:-12px; background: linear-gradient(180deg, #2e1f14 0%, #1f150d 100%); box-shadow: 0 18px 50px rgba(0,0,0,0.45), inset 0 0 0 1px rgba(255,255,255,0.04);"></div>
    
                <div class="absolute inset-0 translate-y-[5px] translate-x-[5px] scale-[0.994] rounded-[18px] ring-1 opacity-35 bg-neutral-50 ring-black/10"></div>
                <div class="relative h-full w-full rounded-[20px] ring-1 shadow-2xl overflow-hidden [transform:rotateY(-2.2deg)_translateZ(0.001px)] ring-black/15 bg-neutral-50">
                  <div class="absolute inset-0" style="background-image:
                       radial-gradient(120% 65% at -10% 50%, rgba(0,0,0,0.08) 0%, rgba(0,0,0,0) 60%),
                       linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.9));">
                  </div>
                  <div class="absolute inset-y-0 left-0 w-8 pointer-events-none bg-gradient-to-r to-transparent from-black/10 via-black/5"></div>
                  <div class="absolute inset-y-0 right-0 w-3 pointer-events-none" style="background-image:repeating-linear-gradient(270deg, rgba(0,0,0,0.1) 0px, rgba(0,0,0,0.1) 1px, transparent 1px, transparent 2px); opacity:.22"></div>
    
                  <div class="relative h-full w-full p-6">
                    <div class="js-mask h-full w-full rounded-[14px] ring-1 ring-black/5 bg-white/60">
                      <div id="mobileFlow2" contenteditable="true" spellcheck="false" tabindex="0" class="js-flow h-full w-full rounded-[12px] text-neutral-900 outline-none p-5 overflow-y-auto" style="scrollbar-width: none; -ms-overflow-style: none; scroll-behavior: smooth;">
                        <h2 class="mb-2.5 text-[19px] tracking-tight font-semibold text-neutral-900">
                          Page 2 — Title
                        </h2>
                        <p class="text-[14.5px] leading-6 text-neutral-800/95 mb-2.5">
                          Add content here. Swipe horizontally to move between pages. Each page is a single, rounded sheet.
                        </p>
                      </div>
                    </div>
                    <div class="absolute bottom-3 left-0 right-0 px-6 text-left text-[12px] text-neutral-500/80 mobilePageNum">2</div>
                  </div>
                </div>
              </div>
            </div>
    
            <!-- Mobile page indicators -->
            <div class="mt-3 flex justify-center gap-1.5">
              <span class="h-1.5 w-6 rounded-full bg-white/30"></span>
              <span class="h-1.5 w-1.5 rounded-full bg-white/20"></span>
            </div>
          </div>
        </div>
    
        <!-- TOC Drawer -->
        <div id="tocDrawer" class="fixed top-[64px] left-0 z-40 w-[320px] max-w-[80vw] translate-x-[-100%] transition-transform duration-300">
          <div class="m-3 rounded-lg border border-white/10 bg-white/5 backdrop-blur px-4 py-3 text-sm text-slate-200">
            <div class="mb-2 flex items-center justify-between">
              <div class="font-medium tracking-tight">Table of Contents</div>
              <button id="closeToc" class="p-1 rounded-md hover:bg-white/10">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4.5 w-4.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>
              </button>
            </div>
            <ul id="tocList" class="space-y-1.5"></ul>
          </div>
        </div>
    
        <!-- Helper footer -->
        <div class="mx-auto mt-8 max-w-3xl">
          <div class="rounded-lg border px-4 py-3 text-sm border-white/10 bg-white/5 text-slate-300">
            <div class="flex items-start gap-3">
              <svg xmlns="http://www.w3.org/2000/svg" class="mt-0.5 h-4.5 w-4.5 shrink-0 text-slate-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <circle cx="12" cy="12" r="10"></circle><path d="M12 8v8"></path><path d="M8 12h8"></path>
              </svg>
              <div>
                <div class="font-medium">Tips</div>
                <ul class="mt-1 list-disc pl-5 text-slate-400">
                  <li>Each chapter scrolls within a single page. Use the margin areas or the top bar to navigate quickly.</li>
                  <li>The scrollbar is hidden and only appears subtly during scroll as an overlay indicator.</li>
                  <li>Use headings (H2) to populate the table of contents for in-page navigation.</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    
      <!-- Image Editor Overlay -->
      <div id="imageEditor" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
        <div class="relative mx-auto my-10 max-w-2xl rounded-xl border border-white/10 bg-[#0e1117] p-4 shadow-2xl">
          <div class="flex items-center justify-between px-2 py-1 mb-3">
            <div class="text-sm text-slate-300">Photo editor</div>
            <button id="editorClose" class="p-1 rounded-md hover:bg-white/10">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4.5 w-4.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>
            </button>
          </div>
          
          <!-- Preview with drag -->
          <div class="rounded-lg overflow-hidden ring-1 ring-white/10 bg-white/5 relative mb-4" id="editorFrame" style="aspect-ratio: 4 / 3; cursor: grab;">
            <img id="editorPreview" class="absolute inset-0 h-full w-full object-cover select-none pointer-events-none" src="" alt="" style="transform: translate(0px, 0px) scale(1);">
          </div>
    
          <!-- Controls -->
          <div class="rounded-lg ring-1 ring-white/10 bg-white/5 p-3 mb-3">
            <div class="space-y-3 text-sm text-slate-300">
              <label class="block">
                <span class="text-xs text-slate-400">Zoom</span>
                <input id="ctrlScale" type="range" min="0.6" max="2.5" step="0.02" value="1" class="w-full accent-indigo-400">
              </label>
              <label class="block">
                <span class="text-xs text-slate-400">Width (px)</span>
                <input id="ctrlW" type="range" min="140" max="360" step="2" value="240" class="w-full accent-indigo-400">
              </label>
              <div class="flex gap-2">
                <button id="floatLeft" class="flex-1 inline-flex items-center justify-center gap-2 rounded-md bg-white/5 px-3 py-2 ring-1 ring-white/10 hover:bg-white/10">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4.5 w-4.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M15 12H3"></path><path d="m8 5-5 7 5 7"></path></svg>
                  Left
                </button>
                <button id="floatCenter" class="flex-1 inline-flex items-center justify-center gap-2 rounded-md bg-white/5 px-3 py-2 ring-1 ring-white/10 hover:bg-white/10">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4.5 w-4.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M4 6h16"></path><path d="M6 12h12"></path><path d="M8 18h8"></path>
                  </svg>
                  Center
                </button>
                <button id="floatRight" class="flex-1 inline-flex items-center justify-center gap-2 rounded-md bg-white/5 px-3 py-2 ring-1 ring-white/10 hover:bg-white/10">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4.5 w-4.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 12h12"></path><path d="m16 19 5-7-5-7"></path></svg>
                  Right
                </button>
              </div>
              <div class="text-xs text-slate-500">Drag the image to reposition • Caption can be added after inserting</div>
            </div>
          </div>
    
          <div class="flex justify-end gap-2 px-2">
            <button id="editorCancel" class="rounded-md px-3 py-2 text-sm ring-1 ring-white/10 hover:bg-white/10">Cancel</button>
            <button id="editorInsert" class="rounded-md px-3 py-2 text-sm bg-indigo-500/80 hover:bg-indigo-500 text-white">Insert</button>
          </div>
        </div>
      </div>
    
      <script>
        // Utilities
        const $ = (s, r=document) => r.querySelector(s);
        const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
        const on = (el, ev, fn) => el && el.addEventListener(ev, fn);
    
        // Elements
        const flowLeft = $('#flowLeft');
        const flowRight = $('#flowRight');
        const flowMaskLeft = $('#flowMaskLeft');
        const flowMaskRight = $('#flowMaskRight');
        const pageNumLeft = $('#pageNumLeft');
        const pageNumRight = $('#pageNumRight');
    
        const progressTrack = $('#progressTrack');
        const progressFill = $('#progressFill');
        const progressTooltip = $('#progressTooltip');
    
        const tocDrawer = $('#tocDrawer');
        const tocList = $('#tocList');
        const btnToc = $('#btnToc');
        const closeToc = $('#closeToc');
    
        const btnImage = $('#btnImage');
        const imageInput = $('#imageInput');
        const imageEditor = $('#imageEditor');
        const editorPreview = $('#editorPreview');
        const editorFrame = $('#editorFrame');
        const ctrlScale = $('#ctrlScale');
        const ctrlW = $('#ctrlW');
        const floatLeftBtn = $('#floatLeft');
        const floatCenterBtn = $('#floatCenter');
        const floatRightBtn = $('#floatRight');
        const editorInsert = $('#editorInsert');
        const editorCancel = $('#editorCancel');
        const editorClose = $('#editorClose');
    
        const navPrev = $('#navPrev');
        const navNext = $('#navNext');
    
        const mobileScroller = $('#mobileScroller');
        const mobilePrev = $('#mobilePrev');
        const mobileNext = $('#mobileNext');
    
        // Maintain a list of all scrollable flows (desktop + mobile)
        const pages = [];
        let currentFlow = null;
    
        // Image drag state
        let dragX = 0, dragY = 0;
        let isDragging = false;
        let startX = 0, startY = 0;
    
        function updateImageTransform() {
          const scale = parseFloat(ctrlScale.value) || 1;
          editorPreview.style.transform = `translate(${dragX}px, ${dragY}px) scale(${scale})`;
        }
    
        // Dragging on the preview frame
        on(editorFrame, 'mousedown', (e) => {
          isDragging = true;
          startX = e.clientX - dragX;
          startY = e.clientY - dragY;
          editorFrame.style.cursor = 'grabbing';
          e.preventDefault();
        });
    
        on(document, 'mousemove', (e) => {
          if (!isDragging) return;
          dragX = e.clientX - startX;
          dragY = e.clientY - startY;
          updateImageTransform();
        });
    
        on(document, 'mouseup', () => {
          if (isDragging) {
            isDragging = false;
            editorFrame.style.cursor = 'grab';
          }
        });
    
        on(ctrlScale, 'input', updateImageTransform);
    
        // Overlay scrollbar
        function attachOverlayScrollbar(scroller, mask){
          const track = document.createElement('div');
          track.className = 'pointer-events-none absolute right-2 top-5 bottom-6 w-1.5 rounded-full bg-white/5 ring-1 ring-white/10 opacity-0 transition-opacity';
          const thumb = document.createElement('div');
          thumb.className = 'absolute right-0 w-1.5 rounded-full bg-white/70 shadow';
          thumb.style.top = '0px';
          thumb.style.height = '24px';
          track.appendChild(thumb);
          mask.appendChild(track);
    
          let hideTO = null;
          function update(){
            const h = scroller.clientHeight, sh = scroller.scrollHeight;
            const trackH = track.clientHeight || 1;
            const ratio = Math.min(1, h / (sh || 1));
            const minH = 24;
            const thumbH = Math.max(minH, Math.floor(trackH * ratio));
            const maxTop = Math.max(0, trackH - thumbH);
            const top = (sh > h) ? Math.min(maxTop, Math.floor((scroller.scrollTop / (sh - h)) * maxTop)) : 0;
            thumb.style.height = thumbH + 'px';
            thumb.style.transform = 'translateY(' + top + 'px)';
          }
          function show(){
            track.classList.add('opacity-100');
            clearTimeout(hideTO);
            hideTO = setTimeout(()=>track.classList.remove('opacity-100'), 700);
          }
    
          on(scroller, 'scroll', ()=>{ update(); updateProgress(); });
          on(scroller, 'mouseenter', update);
          on(scroller, 'input', update);
          window.addEventListener('resize', update);
    
          // Initial
          update();
          return { update, show, track, thumb };
        }
    
        // Scroll callout (fade + prompt)
        function attachScrollCallout(scroller, mask){
          const fade = document.createElement('div');
          fade.className = 'pointer-events-none absolute left-0 right-0 bottom-6 h-16 bg-gradient-to-t from-white via-white/60 to-transparent rounded-b-[12px] opacity-0 transition-opacity';
          const prompt = document.createElement('div');
          prompt.className = 'pointer-events-none absolute left-1/2 -translate-x-1/2 bottom-[3.75rem] text-[12px] tracking-tight text-neutral-600 bg-white/80 backdrop-blur px-2.5 py-1 rounded-full ring-1 ring-black/5 shadow-sm opacity-0 transition-opacity';
          prompt.textContent = '↓ Scroll to continue reading ↓';
          mask.appendChild(fade);
          mask.appendChild(prompt);
    
          let promptShownOnce = false;
          let promptHideTO = null;
    
          function setVisible(el, v){
            el.style.opacity = v ? '1' : '0';
          }
    
          function hidePromptSoon(delay=1400){
            clearTimeout(promptHideTO);
            promptHideTO = setTimeout(()=> setVisible(prompt, false), delay);
          }
    
          function update(){
            const overflow = scroller.scrollHeight > scroller.clientHeight + 1;
            const atBottom = Math.ceil(scroller.scrollTop + scroller.clientHeight) >= scroller.scrollHeight - 1;
            const nearTop = scroller.scrollTop < 12;
    
            setVisible(fade, overflow && !atBottom);
    
            if (overflow && nearTop && !promptShownOnce){
              setVisible(prompt, true);
              hidePromptSoon(1800);
              promptShownOnce = true;
            } else if (!nearTop || atBottom || !overflow){
              setVisible(prompt, false);
            }
          }
    
          on(scroller, 'scroll', update);
          on(scroller, 'input', update);
          window.addEventListener('resize', update);
    
          update();
          return { update, fade, prompt };
        }
    
        let overlayLeft = null, overlayRight = null;
        let calloutLeft = null, calloutRight = null;
    
        function updateProgress(){
          const el = currentFlow || getFirstVisibleFlow() || pages[0];
          if (!el) return;
          const max = Math.max(1, el.scrollHeight - el.clientHeight);
          const pct = Math.max(0, Math.min(100, (el.scrollTop / max) * 100));
          progressFill.style.width = pct + '%';
          progressTrack.title = 'Scrolled ' + Math.round(pct) + '%';
        }
    
        // Compute and render desktop page numbers by spread (1–2, 3–4, ...)
        function getDesktopSpreadIndex(){
          if (!flowLeft) return 0;
          const h = flowLeft.clientHeight || 1;
          return Math.max(0, Math.floor((flowLeft.scrollTop + 1) / h));
        }
        function setDesktopPageNumbers(){
          const n = getDesktopSpreadIndex();
          if (pageNumLeft) pageNumLeft.textContent = String(1 + 2*n);
          if (pageNumRight) pageNumRight.textContent = String(2 + 2*n);
        }
    
        // TOC
        function buildTOC(){
          tocList.innerHTML = '';
          const items = pages.flatMap((root) => {
            if (!root || !document.body.contains(root)) return [];
            return $$('h2', root).map(h=>({h, root}));
          });
          items.forEach((it,i)=>{
            const li = document.createElement('li');
            const a = document.createElement('button');
            a.className = 'w-full text-left px-2 py-1.5 rounded-md hover:bg-white/10';
            a.textContent = it.h.textContent.trim() || ('Chapter ' + (i+1));
            a.addEventListener('click', ()=>{
              currentFlow = it.root;
              it.root.scrollTo({ top: it.h.offsetTop - 8, behavior: 'smooth' });
              tocDrawer.style.transform = 'translateX(-100%)';
            });
            li.appendChild(a);
            tocList.appendChild(li);
          });
        }
    
        on(progressTrack, 'mousemove', (e)=>{
          const rect = progressTrack.getBoundingClientRect();
          const xRatio = Math.min(0.999, Math.max(0, (e.clientX - rect.left) / rect.width));
          const pct = Math.round(xRatio * 100);
          progressTooltip.textContent = 'Jump to ' + pct + '%';
          progressTooltip.style.left = e.clientX + 'px';
          progressTooltip.classList.remove('hidden');
        });
        on(progressTrack, 'mouseleave', ()=>progressTooltip.classList.add('hidden'));
        on(progressTrack, 'click', (e)=>{
          const el = currentFlow || getFirstVisibleFlow() || pages[0];
          if (!el) return;
          const rect = progressTrack.getBoundingClientRect();
          const xRatio = Math.min(0.999, Math.max(0, (e.clientX - rect.left) / rect.width));
          const max = Math.max(0, el.scrollHeight - el.clientHeight);
          el.scrollTo({ top: xRatio * max, behavior: 'smooth' });
        });
    
        on(btnToc, 'click', ()=>{
          const open = !tocDrawer.style.transform || tocDrawer.style.transform.includes('-100%');
          tocDrawer.style.transform = open ? 'translateX(0)' : 'translateX(-100%)';
        });
        on(closeToc, 'click', ()=> tocDrawer.style.transform = 'translateX(-100%)');
    
        // Desktop spread stepping: jump a full viewport to show next pair (3–4, 5–6, ...)
        function scrollDesktopSpread(delta){
          if (!flowLeft || !flowRight) return;
          const hL = flowLeft.clientHeight || 1;
          const hR = flowRight.clientHeight || 1;
          const curN = Math.round(flowLeft.scrollTop / hL);
          const maxNLeft = Math.max(0, Math.floor((flowLeft.scrollHeight - hL) / hL));
          const maxNRight = Math.max(0, Math.floor((flowRight.scrollHeight - hR) / hR));
          const maxN = Math.max(maxNLeft, maxNRight);
          const nextN = Math.max(0, Math.min(maxN, curN + delta));
          const targetTopLeft = Math.min(nextN * hL, Math.max(0, flowLeft.scrollHeight - hL));
          const targetTopRight = Math.min(nextN * hR, Math.max(0, flowRight.scrollHeight - hR));
          flowLeft.scrollTo({ top: targetTopLeft, behavior: 'smooth' });
          flowRight.scrollTo({ top: targetTopRight, behavior: 'smooth' });
          setTimeout(()=>{ setDesktopPageNumbers(); updateProgress(); }, 50);
        }
    
        on(navPrev, 'click', ()=> scrollDesktopSpread(-1));
        on(navNext, 'click', ()=> scrollDesktopSpread(1));
    
        on(flowLeft, 'pointerdown', ()=> currentFlow = flowLeft);
        on(flowRight, 'pointerdown', ()=> currentFlow = flowRight);
    
        // Track focus to know where to insert on mobile/tablet
        document.addEventListener('focusin', (e)=>{
          if (e.target && e.target.isContentEditable) {
            currentFlow = e.target;
            updateProgress();
          }
        });
    
        // Image picker
        on(btnImage, 'click', ()=> imageInput.click());
        on(imageInput, 'change', (e)=>{
          const file = e.target.files && e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (ev)=>{
            editorPreview.src = ev.target.result;
            dragX = 0;
            dragY = 0;
            ctrlScale.value = 1;
            updateImageTransform();
            imageEditor.classList.remove('hidden');
          };
          reader.readAsDataURL(file);
          // reset input to allow re-picking the same file later
          e.target.value = '';
        });
        on(editorClose, 'click', ()=> imageEditor.classList.add('hidden'));
        on(editorCancel, 'click', ()=> imageEditor.classList.add('hidden'));
        on(editorInsert, 'click', ()=>{
          if (!editorPreview.src) return imageEditor.classList.add('hidden');
    
          const baseW = parseInt(ctrlW.value, 10) || 240;
          const finalW = baseW;
    
          const figure = document.createElement('figure');
          figure.className = 'my-3';
    
          const img = document.createElement('img');
          img.src = editorPreview.src;
          img.alt = '';
          img.className = 'rounded-md shadow ring-1 ring-black/5';
          img.style.width = finalW + 'px';
          img.style.objectFit = 'cover';
          img.style.objectPosition = 'center';
          img.style.transform = `translate(${dragX}px, ${dragY}px) scale(${ctrlScale.value})`;
    
          // Float selection (default: right)
          const float = (document.activeElement === floatLeftBtn && 'left') || (document.activeElement === floatRightBtn && 'right') || (document.activeElement === floatCenterBtn && 'center') || 'right';
          if (float === 'left') {
            img.style.cssFloat = 'left';
            img.style.margin = '0 14px 6px 0';
            img.style.display = '';
          } else if (float === 'right') {
            img.style.cssFloat = 'right';
            img.style.margin = '0 0 6px 14px';
            img.style.display = '';
          } else {
            img.style.cssFloat = 'none';
            img.style.margin = '0 auto 10px auto';
            img.style.display = 'block';
          }
    
          const cap = document.createElement('figcaption');
          cap.contentEditable = 'true';
          cap.spellcheck = false;
          cap.className = 'text-[12px] text-neutral-600 mt-1';
          cap.textContent = 'Caption';
    
          figure.appendChild(img);
          figure.appendChild(cap);
    
          // Choose target flow: current focused, else first visible
          const target = (currentFlow && document.body.contains(currentFlow) ? currentFlow : getFirstVisibleFlow()) || flowLeft;
          target.appendChild(figure);
          // Try to insert at caret if selection is inside the target flow
          const sel = window.getSelection && window.getSelection();
          if (sel && sel.rangeCount) {
            const range = sel.getRangeAt(0);
            if (target.contains(range.startContainer)) {
              range.collapse(false);
              range.insertNode(figure); // Moves the node if already appended
            }
          }
    
          // Ensure there's a paragraph after the figure so typing can continue naturally
          if (!figure.nextSibling || !(figure.nextSibling.nodeType === 1 && figure.nextSibling.tagName.toLowerCase() === 'p')) {
            const p = document.createElement('p');
            p.className = target === flowLeft || target === flowRight
              ? 'text-[15.5px] leading-7 text-neutral-800/95 mb-3'
              : 'text-[14.5px] leading-6 text-neutral-800/95 mb-2.5';
            p.innerHTML = '<br>';
            figure.after(p);
          }
    
          // Place the caret after the inserted figure
          try {
            const range = document.createRange();
            range.setStartAfter(figure);
            range.setEndAfter(figure);
            sel.removeAllRanges();
            sel.addRange(range);
          } catch {}
    
          // Focus and finalize
          target.focus();
          imageEditor.classList.add('hidden');
          buildTOC();
          updateProgress();
        });
    
        // Float selection UI state for the editor
        function setFloatActive(which){
          [floatLeftBtn, floatCenterBtn, floatRightBtn].forEach(b=>{
            b.classList.remove('bg-white/10','ring-indigo-400/60');
            b.classList.add('ring-white/10');
          });
          if (which === 'left') {
            floatLeftBtn.classList.add('bg-white/10','ring-indigo-400/60');
            floatLeftBtn.focus();
          } else if (which === 'center') {
            floatCenterBtn.classList.add('bg-white/10','ring-indigo-400/60');
            floatCenterBtn.focus();
          } else {
            floatRightBtn.classList.add('bg-white/10','ring-indigo-400/60');
            floatRightBtn.focus();
          }
        }
        on(floatLeftBtn, 'click', ()=> setFloatActive('left'));
        on(floatCenterBtn, 'click', ()=> setFloatActive('center'));
        on(floatRightBtn, 'click', ()=> setFloatActive('right'));
        // Default selection
        setFloatActive('right');
    
        // Helpers
        function getFirstVisibleFlow(){
          // Choose the most visible editable flow in the viewport
          const flows = pages.filter(el => el && document.body.contains(el));
          let best = null, bestScore = 0;
          const vw = Math.max(1, window.innerWidth);
          const vh = Math.max(1, window.innerHeight);
          for (const el of flows){
            const r = el.getBoundingClientRect();
            const iw = Math.max(0, Math.min(r.right, vw) - Math.max(r.left, 0));
            const ih = Math.max(0, Math.min(r.bottom, vh) - Math.max(r.top, 0));
            const area = iw * ih;
            if (area > bestScore){ bestScore = area; best = el; }
          }
          return best || flows[0];
        }
    
        // Register a scrollable content flow: overlay scrollbar + callout + events
        function registerFlow(flowEl, maskEl){
          if (!flowEl) return null;
          if (!pages.includes(flowEl)) pages.push(flowEl);
    
          const mask = maskEl || flowEl.closest('.js-mask') || flowEl.parentElement || flowEl;
    
          const overlay = attachOverlayScrollbar(flowEl, mask);
          const callout = attachScrollCallout(flowEl, mask);
    
          on(flowEl, 'scroll', ()=> {
            overlay.update();
            callout.update();
            setDesktopPageNumbers();
            overlay.show && overlay.show();
          });
          on(flowEl, 'input', ()=> {
            overlay.update();
            callout.update();
            buildTOC();
            updateProgress();
          });
          on(flowEl, 'pointerdown', ()=> {
            currentFlow = flowEl;
            updateProgress();
          });
    
          return { overlay, callout };
        }
    
        // Initialize desktop flows
        const regsLeft = registerFlow(flowLeft, flowMaskLeft);
        overlayLeft = regsLeft && regsLeft.overlay;
        calloutLeft = regsLeft && regsLeft.callout;
    
        const regsRight = registerFlow(flowRight, flowMaskRight);
        overlayRight = regsRight && regsRight.overlay;
        calloutRight = regsRight && regsRight.callout;
    
        // Initialize existing mobile flows
        const initialMobileFlows = $$('#mobileScroller .js-flow');
        initialMobileFlows.forEach(f => registerFlow(f));
    
        // Sync progress/current with mobile scroll position
        function syncCurrentFromMobile(){
          if (!mobileScroller) return;
          const centerX = mobileScroller.scrollLeft + mobileScroller.clientWidth / 2;
          let best = null, bestDist = Infinity;
          $$('.mobile-page', mobileScroller).forEach(page=>{
            const left = page.offsetLeft;
            const width = page.offsetWidth;
            const mid = left + width/2;
            const d = Math.abs(mid - centerX);
            if (d < bestDist){ bestDist = d; best = page; }
          });
          if (best){
            const flow = $('.js-flow', best);
            if (flow && document.body.contains(flow)) {
              currentFlow = flow;
              updateProgress();
            }
          }
        }
    
        // Bind mobile controls and sync
        on(mobileScroller, 'scroll', syncCurrentFromMobile);
        on(mobilePrev, 'click', ()=> {
          if (!mobileScroller) return;
          mobileScroller.scrollBy({ left: -mobileScroller.clientWidth - 24, behavior: 'smooth' });
        });
        on(mobileNext, 'click', ()=> {
          if (!mobileScroller) return;
          mobileScroller.scrollBy({ left: mobileScroller.clientWidth + 24, behavior: 'smooth' });
        });
    
        // Initial render
        function init(){
          buildTOC();
          setDesktopPageNumbers();
          updateProgress();
        }
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', init);
        } else {
          init();
        }
    
        // Keep numbers/progress in sync on resize
        window.addEventListener('resize', ()=>{
          setDesktopPageNumbers();
          updateProgress();
        });
      </script>
    </body></html>