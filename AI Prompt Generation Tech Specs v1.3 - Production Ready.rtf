{\rtf1\ansi\ansicpg1252\cocoartf2865
\cocoatextscaling0\cocoaplatform0{\fonttbl\f0\fswiss\fcharset0 Arial-BoldMT;\f1\froman\fcharset0 Times-Bold;\f2\froman\fcharset0 Times-Roman;
\f3\fswiss\fcharset0 ArialMT;\f4\fswiss\fcharset0 Arial-BoldItalicMT;\f5\fswiss\fcharset0 Arial-ItalicMT;
}
{\colortbl;\red255\green255\blue255;\red0\green0\blue0;\red155\green162\blue177;\red137\green144\blue161;
\red74\green80\blue93;\red184\green93\blue213;\red81\green157\blue235;\red136\green185\blue102;\red197\green136\blue83;
\red58\green62\blue75;\red167\green64\blue203;\red66\green137\blue230;\red183\green117\blue66;\red119\green174\blue83;
\red214\green85\blue98;\red202\green62\blue80;}
{\*\expandedcolortbl;;\cssrgb\c0\c0\c0;\cssrgb\c67059\c69804\c74902;\cssrgb\c60784\c63529\c69412;
\cssrgb\c36078\c38824\c43922;\cssrgb\c77647\c47059\c86667;\cssrgb\c38039\c68627\c93725;\cssrgb\c59608\c76471\c47451;\cssrgb\c81961\c60392\c40000;
\cssrgb\c29020\c31373\c36471;\cssrgb\c72157\c36471\c83529;\cssrgb\c31765\c61569\c92157;\cssrgb\c77255\c53333\c32549;\cssrgb\c53333\c72549\c40000;
\cssrgb\c87843\c42353\c45882;\cssrgb\c83922\c33333\c38431;}
{\*\listtable{\list\listtemplateid1\listhybrid{\listlevel\levelnfc0\levelnfcn0\leveljc0\leveljcn0\levelfollow0\levelstartat1\levelspace360\levelindent0{\*\levelmarker \{decimal\}}{\leveltext\leveltemplateid1\'01\'00;}{\levelnumbers\'01;}\fi-360\li720\lin720 }{\listname ;}\listid1}
{\list\listtemplateid2\listhybrid{\listlevel\levelnfc0\levelnfcn0\leveljc0\leveljcn0\levelfollow0\levelstartat1\levelspace360\levelindent0{\*\levelmarker \{decimal\}}{\leveltext\leveltemplateid101\'01\'00;}{\levelnumbers\'01;}\fi-360\li720\lin720 }{\listname ;}\listid2}
{\list\listtemplateid3\listhybrid{\listlevel\levelnfc0\levelnfcn0\leveljc0\leveljcn0\levelfollow0\levelstartat1\levelspace360\levelindent0{\*\levelmarker \{decimal\}}{\leveltext\leveltemplateid201\'01\'00;}{\levelnumbers\'01;}\fi-360\li720\lin720 }{\listname ;}\listid3}
{\list\listtemplateid4\listhybrid{\listlevel\levelnfc23\levelnfcn23\leveljc0\leveljcn0\levelfollow0\levelstartat1\levelspace360\levelindent0{\*\levelmarker \{disc\}}{\leveltext\leveltemplateid301\'01\uc0\u8226 ;}{\levelnumbers;}\fi-360\li720\lin720 }{\listname ;}\listid4}
{\list\listtemplateid5\listhybrid{\listlevel\levelnfc23\levelnfcn23\leveljc0\leveljcn0\levelfollow0\levelstartat1\levelspace360\levelindent0{\*\levelmarker \{disc\}}{\leveltext\leveltemplateid401\'01\uc0\u8226 ;}{\levelnumbers;}\fi-360\li720\lin720 }{\listname ;}\listid5}
{\list\listtemplateid6\listhybrid{\listlevel\levelnfc23\levelnfcn23\leveljc0\leveljcn0\levelfollow0\levelstartat1\levelspace360\levelindent0{\*\levelmarker \{disc\}}{\leveltext\leveltemplateid501\'01\uc0\u8226 ;}{\levelnumbers;}\fi-360\li720\lin720 }{\listname ;}\listid6}
{\list\listtemplateid7\listhybrid{\listlevel\levelnfc23\levelnfcn23\leveljc0\leveljcn0\levelfollow0\levelstartat1\levelspace360\levelindent0{\*\levelmarker \{disc\}}{\leveltext\leveltemplateid601\'01\uc0\u8226 ;}{\levelnumbers;}\fi-360\li720\lin720 }{\listname ;}\listid7}
{\list\listtemplateid8\listhybrid{\listlevel\levelnfc0\levelnfcn0\leveljc0\leveljcn0\levelfollow0\levelstartat1\levelspace360\levelindent0{\*\levelmarker \{decimal\}}{\leveltext\leveltemplateid701\'01\'00;}{\levelnumbers\'01;}\fi-360\li720\lin720 }{\listname ;}\listid8}
{\list\listtemplateid9\listhybrid{\listlevel\levelnfc23\levelnfcn23\leveljc0\leveljcn0\levelfollow0\levelstartat1\levelspace360\levelindent0{\*\levelmarker \{disc\}}{\leveltext\leveltemplateid801\'01\uc0\u8226 ;}{\levelnumbers;}\fi-360\li720\lin720 }{\listname ;}\listid9}
{\list\listtemplateid10\listhybrid{\listlevel\levelnfc23\levelnfcn23\leveljc0\leveljcn0\levelfollow0\levelstartat1\levelspace360\levelindent0{\*\levelmarker \{disc\}}{\leveltext\leveltemplateid901\'01\uc0\u8226 ;}{\levelnumbers;}\fi-360\li720\lin720 }{\listname ;}\listid10}
{\list\listtemplateid11\listhybrid{\listlevel\levelnfc0\levelnfcn0\leveljc0\leveljcn0\levelfollow0\levelstartat1\levelspace360\levelindent0{\*\levelmarker \{decimal\}}{\leveltext\leveltemplateid1001\'01\'00;}{\levelnumbers\'01;}\fi-360\li720\lin720 }{\listlevel\levelnfc23\levelnfcn23\leveljc0\leveljcn0\levelfollow0\levelstartat1\levelspace360\levelindent0{\*\levelmarker \{circle\}}{\leveltext\leveltemplateid1002\'01\uc0\u9702 ;}{\levelnumbers;}\fi-360\li1440\lin1440 }{\listname ;}\listid11}
{\list\listtemplateid12\listhybrid{\listlevel\levelnfc23\levelnfcn23\leveljc0\leveljcn0\levelfollow0\levelstartat1\levelspace360\levelindent0{\*\levelmarker \{disc\}}{\leveltext\leveltemplateid1101\'01\uc0\u8226 ;}{\levelnumbers;}\fi-360\li720\lin720 }{\listname ;}\listid12}
{\list\listtemplateid13\listhybrid{\listlevel\levelnfc23\levelnfcn23\leveljc0\leveljcn0\levelfollow0\levelstartat1\levelspace360\levelindent0{\*\levelmarker \{disc\}}{\leveltext\leveltemplateid1201\'01\uc0\u8226 ;}{\levelnumbers;}\fi-360\li720\lin720 }{\listname ;}\listid13}
{\list\listtemplateid14\listhybrid{\listlevel\levelnfc23\levelnfcn23\leveljc0\leveljcn0\levelfollow0\levelstartat1\levelspace360\levelindent0{\*\levelmarker \{disc\}}{\leveltext\leveltemplateid1301\'01\uc0\u8226 ;}{\levelnumbers;}\fi-360\li720\lin720 }{\listname ;}\listid14}
{\list\listtemplateid15\listhybrid{\listlevel\levelnfc23\levelnfcn23\leveljc0\leveljcn0\levelfollow0\levelstartat1\levelspace360\levelindent0{\*\levelmarker \{disc\}}{\leveltext\leveltemplateid1401\'01\uc0\u8226 ;}{\levelnumbers;}\fi-360\li720\lin720 }{\listname ;}\listid15}
{\list\listtemplateid16\listhybrid{\listlevel\levelnfc23\levelnfcn23\leveljc0\leveljcn0\levelfollow0\levelstartat1\levelspace360\levelindent0{\*\levelmarker \{disc\}}{\leveltext\leveltemplateid1501\'01\uc0\u8226 ;}{\levelnumbers;}\fi-360\li720\lin720 }{\listname ;}\listid16}
{\list\listtemplateid17\listhybrid{\listlevel\levelnfc23\levelnfcn23\leveljc0\leveljcn0\levelfollow0\levelstartat1\levelspace360\levelindent0{\*\levelmarker \{disc\}}{\leveltext\leveltemplateid1601\'01\uc0\u8226 ;}{\levelnumbers;}\fi-360\li720\lin720 }{\listname ;}\listid17}
{\list\listtemplateid18\listhybrid{\listlevel\levelnfc23\levelnfcn23\leveljc0\leveljcn0\levelfollow0\levelstartat1\levelspace360\levelindent0{\*\levelmarker \{disc\}}{\leveltext\leveltemplateid1701\'01\uc0\u8226 ;}{\levelnumbers;}\fi-360\li720\lin720 }{\listname ;}\listid18}
{\list\listtemplateid19\listhybrid{\listlevel\levelnfc23\levelnfcn23\leveljc0\leveljcn0\levelfollow0\levelstartat1\levelspace360\levelindent0{\*\levelmarker \{disc\}}{\leveltext\leveltemplateid1801\'01\uc0\u8226 ;}{\levelnumbers;}\fi-360\li720\lin720 }{\listname ;}\listid19}
{\list\listtemplateid20\listhybrid{\listlevel\levelnfc23\levelnfcn23\leveljc0\leveljcn0\levelfollow0\levelstartat1\levelspace360\levelindent0{\*\levelmarker \{disc\}}{\leveltext\leveltemplateid1901\'01\uc0\u8226 ;}{\levelnumbers;}\fi-360\li720\lin720 }{\listname ;}\listid20}
{\list\listtemplateid21\listhybrid{\listlevel\levelnfc23\levelnfcn23\leveljc0\leveljcn0\levelfollow0\levelstartat1\levelspace360\levelindent0{\*\levelmarker \{disc\}}{\leveltext\leveltemplateid2001\'01\uc0\u8226 ;}{\levelnumbers;}\fi-360\li720\lin720 }{\listname ;}\listid21}
{\list\listtemplateid22\listhybrid{\listlevel\levelnfc23\levelnfcn23\leveljc0\leveljcn0\levelfollow0\levelstartat1\levelspace360\levelindent0{\*\levelmarker \{disc\}}{\leveltext\leveltemplateid2101\'01\uc0\u8226 ;}{\levelnumbers;}\fi-360\li720\lin720 }{\listname ;}\listid22}
{\list\listtemplateid23\listhybrid{\listlevel\levelnfc23\levelnfcn23\leveljc0\leveljcn0\levelfollow0\levelstartat1\levelspace360\levelindent0{\*\levelmarker \{disc\}}{\leveltext\leveltemplateid2201\'01\uc0\u8226 ;}{\levelnumbers;}\fi-360\li720\lin720 }{\listname ;}\listid23}
{\list\listtemplateid24\listhybrid{\listlevel\levelnfc23\levelnfcn23\leveljc0\leveljcn0\levelfollow0\levelstartat1\levelspace360\levelindent0{\*\levelmarker \{disc\}}{\leveltext\leveltemplateid2301\'01\uc0\u8226 ;}{\levelnumbers;}\fi-360\li720\lin720 }{\listname ;}\listid24}
{\list\listtemplateid25\listhybrid{\listlevel\levelnfc23\levelnfcn23\leveljc0\leveljcn0\levelfollow0\levelstartat1\levelspace360\levelindent0{\*\levelmarker \{disc\}}{\leveltext\leveltemplateid2401\'01\uc0\u8226 ;}{\levelnumbers;}\fi-360\li720\lin720 }{\listname ;}\listid25}
{\list\listtemplateid26\listhybrid{\listlevel\levelnfc0\levelnfcn0\leveljc0\leveljcn0\levelfollow0\levelstartat1\levelspace360\levelindent0{\*\levelmarker \{decimal\}}{\leveltext\leveltemplateid2501\'01\'00;}{\levelnumbers\'01;}\fi-360\li720\lin720 }{\listname ;}\listid26}}
{\*\listoverridetable{\listoverride\listid1\listoverridecount0\ls1}{\listoverride\listid2\listoverridecount0\ls2}{\listoverride\listid3\listoverridecount0\ls3}{\listoverride\listid4\listoverridecount0\ls4}{\listoverride\listid5\listoverridecount0\ls5}{\listoverride\listid6\listoverridecount0\ls6}{\listoverride\listid7\listoverridecount0\ls7}{\listoverride\listid8\listoverridecount0\ls8}{\listoverride\listid9\listoverridecount0\ls9}{\listoverride\listid10\listoverridecount0\ls10}{\listoverride\listid11\listoverridecount0\ls11}{\listoverride\listid12\listoverridecount0\ls12}{\listoverride\listid13\listoverridecount0\ls13}{\listoverride\listid14\listoverridecount0\ls14}{\listoverride\listid15\listoverridecount0\ls15}{\listoverride\listid16\listoverridecount0\ls16}{\listoverride\listid17\listoverridecount0\ls17}{\listoverride\listid18\listoverridecount0\ls18}{\listoverride\listid19\listoverridecount0\ls19}{\listoverride\listid20\listoverridecount0\ls20}{\listoverride\listid21\listoverridecount0\ls21}{\listoverride\listid22\listoverridecount0\ls22}{\listoverride\listid23\listoverridecount0\ls23}{\listoverride\listid24\listoverridecount0\ls24}{\listoverride\listid25\listoverridecount0\ls25}{\listoverride\listid26\listoverridecount0\ls26}}
\margl1440\margr1440\vieww24420\viewh32140\viewkind0
\deftab720
\pard\pardeftab720\sa160\partightenfactor0

\f0\b\fs61\fsmilli30667 \cf0 \expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 HeritageWhisper AI Prompt Generation & Story Analysis System
\f1\fs48 \
\pard\pardeftab720\sa320\partightenfactor0

\f0\fs24 \cf0 Technical Specification v1.3 - Production Ready Last Updated: October 2025 Owner: Paul Takisaki Purpose: Complete implementation guide for AI-powered memory prompt and lesson extraction system Status: Ready for Development
\f2\b0 \
\pard\pardeftab720\sa106\partightenfactor0

\f0\b\fs45\fsmilli22667 \cf0 TABLE OF CONTENTS
\f1\fs36 \
\pard\tx220\tx720\pardeftab720\li720\fi-720\partightenfactor0
\ls1\ilvl0
\f0\fs24 \cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	1	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Product Context & Business Goals\
\ls1\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	2	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 System Architecture Overview\
\ls1\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	3	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 User Flows\
\ls1\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	4	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Database Schema\
\ls1\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	5	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 API Specifications\
\ls1\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	6	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 AI Prompt Templates\
\ls1\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	7	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Business Logic & Algorithms\
\ls1\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	8	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Edge Cases & Fallbacks\
\ls1\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	9	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Safety & Compliance\
\ls1\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	10	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Metrics & Success Criteria\
\ls1\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	11	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Cost Model & Budget\
\pard\tx220\tx720\pardeftab720\li720\fi-720\sa320\partightenfactor0
\ls1\ilvl0\cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	12	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Implementation Checklist\
\pard\pardeftab720\sa106\partightenfactor0

\fs45\fsmilli22667 \cf0 1. PRODUCT CONTEXT & BUSINESS GOALS
\f1\fs36 \
\pard\pardeftab720\sa106\partightenfactor0

\f0\fs34\fsmilli17333 \cf0 1.1 The Problems
\f1\fs28 \
\pard\tx220\tx720\pardeftab720\li720\fi-720\partightenfactor0
\ls2\ilvl0
\f0\fs24 \cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	1	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Prompt Generation: Seniors struggle to remember what stories to tell. Generic prompts fail to trigger forgotten memories.\
\pard\tx220\tx720\pardeftab720\li720\fi-720\sa320\partightenfactor0
\ls2\ilvl0\cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	2	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Lesson Extraction: Stories lack the crystallized wisdom that makes them valuable to pass down.\
\pard\pardeftab720\sa106\partightenfactor0

\fs34\fsmilli17333 \cf0 1.2 The Solutions
\f1\fs28 \
\pard\tx220\tx720\pardeftab720\li720\fi-720\partightenfactor0
\ls3\ilvl0
\f0\fs24 \cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	1	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 AI Prompts: AI analyzes existing stories to generate personalized prompts that reference what they already shared.\
\pard\tx220\tx720\pardeftab720\li720\fi-720\sa320\partightenfactor0
\ls3\ilvl0\cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	2	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Lesson Learning: Every story gets 2-3 AI-suggested lessons they can edit, making them look wise and articulate.\
\pard\pardeftab720\sa106\partightenfactor0

\fs34\fsmilli17333 \cf0 1.3 The Differentiation
\f1\fs28 \
\pard\tx220\tx720\pardeftab720\li720\fi-720\partightenfactor0
\ls4\ilvl0
\f0\fs24 \cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 StoryWorth: Generic list of 500 prompts (same for everyone)\
\ls4\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 HeritageWhisper: "You mentioned your father's workshop in 1955. Who else spent time there with you?"\
\pard\tx220\tx720\pardeftab720\li720\fi-720\sa320\partightenfactor0
\ls4\ilvl0\cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Plus: Every story ends with a meaningful lesson learned in their voice\
\pard\pardeftab720\sa106\partightenfactor0

\fs34\fsmilli17333 \cf0 1.4 Business Objectives
\f1\fs28 \
\pard\pardeftab720\sa320\partightenfactor0

\f0\fs24 \cf0 Free Tier (Stories 1-3):
\f2\b0 \
\pard\tx220\tx720\pardeftab720\li720\fi-720\partightenfactor0
\ls5\ilvl0
\f0\b \cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Goal: Convert trial users to paid subscribers\
\ls5\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Strategy: Show AI "magic" at Stories 1, 2, and 3\
\pard\tx220\tx720\pardeftab720\li720\fi-720\sa320\partightenfactor0
\ls5\ilvl0\cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Target: 45% trial-to-paid conversion (baseline: 35-40%)\
\pard\pardeftab720\sa320\partightenfactor0
\cf0 Paid Tier (Stories 4+):
\f2\b0 \
\pard\tx220\tx720\pardeftab720\li720\fi-720\partightenfactor0
\ls6\ilvl0
\f0\b \cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Goal: Retain subscribers for 12+ months\
\ls6\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Strategy: Maintain prompt quality through Story 20, then taper\
\pard\tx220\tx720\pardeftab720\li720\fi-720\sa320\partightenfactor0
\ls6\ilvl0\cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Target: 80% annual retention\
\pard\pardeftab720\sa320\partightenfactor0
\cf0 Revenue Impact:
\f2\b0 \
\pard\tx220\tx720\pardeftab720\li720\fi-720\partightenfactor0
\ls7\ilvl0
\f0\b \cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Baseline: 1,000 paid users \'d7 $149 = $149,000/year\
\ls7\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 5% conversion lift: +345 users \'d7 $149 = +$51,405/year\
\ls7\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 AI cost: $2,170/year (includes lesson extraction)\
\pard\tx220\tx720\pardeftab720\li720\fi-720\sa320\partightenfactor0
\ls7\ilvl0\cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Net gain: $49,235/year (ROI: 22x)\
\pard\pardeftab720\sa106\partightenfactor0

\fs45\fsmilli22667 \cf0 2. SYSTEM ARCHITECTURE OVERVIEW
\f1\fs36 \
\pard\pardeftab720\sa106\partightenfactor0

\f0\fs34\fsmilli17333 \cf0 2.1 Two-Phase Processing System
\f1\fs28 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\fs24 \cf3 \strokec3 \uc0\u9484 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9488 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \uc0\u9474  \'a0 \'a0 \'a0 \'a0 \'a0 PHASE 1: IMMEDIATE PROCESSING\'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \u9474 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \uc0\u9474 \'a0 \'95 Trigger: User stops recording \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \u9474 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \uc0\u9474 \'a0 \'95 Parallel: Transcribe + Format + Lesson \'a0 \'a0 \'a0 \'a0 \'a0 \u9474 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \uc0\u9474 \'a0 \'95 Cost: ~$0.002 per story\'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \u9474 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \uc0\u9474 \'a0 \'95 Time: 1.7 seconds\'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \u9474 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \uc0\u9474 \'a0 \'95 Output: Review screen with editable content\'a0 \'a0 \'a0 \u9474 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \uc0\u9492 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9496 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \uc0\u9484 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9488 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \uc0\u9474  \'a0 \'a0 \'a0 \'a0 PHASE 2: BACKGROUND PROCESSING \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \u9474 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \uc0\u9474 \'a0 \'95 Trigger: User saves story (at milestones)\'a0 \'a0 \'a0 \'a0 \u9474 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \uc0\u9474 \'a0 \'95 Combined: Prompts + Character Analysis \'a0 \'a0 \'a0 \'a0 \'a0 \u9474 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \uc0\u9474 \'a0 \'95 Cost: $0.01-0.15 per milestone \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \u9474 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \uc0\u9474 \'a0 \'95 Time: 5-10 seconds (invisible to user) \'a0 \'a0 \'a0 \'a0 \'a0 \u9474 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \uc0\u9474 \'a0 \'95 Output: Prompts + Character insights \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \u9474 
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa160\partightenfactor0

\f0\b \cf3 \strokec3 \uc0\u9492 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9496 
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa106\partightenfactor0

\f0\b\fs34\fsmilli17333 \cf0 2.2 Three-Tier Prompt System
\f1\fs28 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\fs24 \cf3 \strokec3 \uc0\u9484 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9488 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \uc0\u9474 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 TIER 1: TEMPLATES \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \u9474 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \uc0\u9474 \'a0 \'95 Trigger: After every story save (synchronous) \'a0 \'a0 \u9474 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \uc0\u9474 \'a0 \'95 Method: Regex keyword extraction + template match \u9474 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \uc0\u9474 \'a0 \'95 Cost: $0 (no API call) \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \u9474 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \uc0\u9474 \'a0 \'95 Expiry: 7 days \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \u9474 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \uc0\u9474 \'a0 \'95 Coverage: 60-70% of stories\'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \u9474 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \uc0\u9492 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9496 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \uc0\u9484 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9488 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \uc0\u9474  \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 TIER 2: ON-DEMAND AI \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \u9474 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \uc0\u9474 \'a0 \'95 Trigger: When active_prompts is empty\'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \u9474 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \uc0\u9474 \'a0 \'95 Method: GPT-4o analyzes last 3-5 stories \'a0 \'a0 \'a0 \'a0 \u9474 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \uc0\u9474 \'a0 \'95 Cost: ~$0.05 per generation\'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \u9474 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \uc0\u9474 \'a0 \'95 Expiry: 14 days\'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \u9474 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \uc0\u9474 \'a0 \'95 Frequency: 2-3x per month per user \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \u9474 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \uc0\u9492 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9496 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \uc0\u9484 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9488 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \uc0\u9474 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 TIER 3: MILESTONE ANALYSIS\'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \u9474 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \uc0\u9474 \'a0 \'95 Trigger: At stories 1,2,3,4,7,10,15,20,30,50,100 \u9474 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \uc0\u9474 \'a0 \'95 Method: GPT-4o analyzes ALL stories\'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \u9474 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \uc0\u9474 \'a0 \'95 Cost: $0.012-0.15 per analysis \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \u9474 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \uc0\u9474 \'a0 \'95 Expiry: 30 days (60 days for premium seed)\'a0 \'a0 \'a0 \u9474 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \uc0\u9474 \'a0 \'95 Generates: Prompts + Character insights\'a0 \'a0 \'a0 \'a0 \'a0 \u9474 
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa160\partightenfactor0

\f0\b \cf3 \strokec3 \uc0\u9492 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9496 
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa106\partightenfactor0

\f0\b\fs34\fsmilli17333 \cf0 2.3 Processing Flow
\f1\fs28 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\fs24 \cf3 \strokec3 Story Recording Stops
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 IMMEDIATE (1.7s):
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \uc0\u9500 \u9472 \u9472  Whisper \u8594  Transcribe (1s)
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \uc0\u9492 \u9472 \u9472  Parallel GPT-4 calls:
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\uc0\u9500 \u9472 \u9472  Format transcript (0.7s)
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\uc0\u9492 \u9472 \u9472  Generate lessons (0.7s)
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 Review Screen Shows
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 User Edits & Saves
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 Story Saved to DB
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 Check if Milestone
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0YES \uc0\u8594  Background Job:
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u9500 \u9472 \u9472  Generate prompts
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u9500 \u9472 \u9472  Extract character traits
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u9492 \u9472 \u9472  Store insights
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa160\partightenfactor0

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0NO \uc0\u8594  Done\

\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa106\partightenfactor0

\f0\b\fs34\fsmilli17333 \cf0 2.4 Key Design Principles
\f1\fs28 \
\pard\tx220\tx720\pardeftab720\li720\fi-720\partightenfactor0
\ls8\ilvl0
\f0\fs24 \cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	1	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Speed First: Review screen in <2 seconds\
\ls8\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	2	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Generate More, Show Less: Always generate 3-5 candidates, show top 1-2\
\ls8\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	3	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Deduplication: anchor_hash prevents semantic duplicates\
\ls8\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	4	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Safety First: do_not_ask + content classifier before insertion\
\ls8\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	5	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Graceful Degradation: Circuit breaker \uc0\u8594  decade fallback\
\pard\tx220\tx720\pardeftab720\li720\fi-720\sa320\partightenfactor0
\ls8\ilvl0\cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	6	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Cost Efficiency: Templates first (free), AI only when needed\
\pard\pardeftab720\sa106\partightenfactor0

\fs45\fsmilli22667 \cf0 3. USER FLOWS
\f1\fs36 \
\pard\pardeftab720\sa293\partightenfactor0

\f0\fs28 \cf0 3.1 Free Tier Flow (Stories 1-3)
\f2\b0\fs24 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \uc0\u9484 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9488 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9474  \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 STORY 1 FLOW\'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \u9474 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9492 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9496 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 User registers \uc0\u8594  Onboarding (birth year) \u8594  Timeline (empty)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Ghost prompts appear
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0"1955 - The Year I Was Born"
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0User taps prompt \uc0\u8594  Records Story 1
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0POST /api/stories (story 1 data)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u9484 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9524 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9488 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595  \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Save to database\'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 Tier 1: Extract keywords
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Set free_stories_used = 1\'a0 \'a0 \'a0 Generate 1 template prompt
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595  \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 (expires in 7 days)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Tier 3: Story 1 Milestone\'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0GPT-4o generates 5 candidates \'a0 Store in active_prompts
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Score and filter (\uc0\u8805 50)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Store top 2
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Return success to client
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0User sees timeline with Story 1 card
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0"Next Story" card appears:
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0"What happened the morning after you told
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0your father you were quitting?"
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u55357 \u56525  Based on your 1955 story
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0[Record This Story \uc0\u55356 \u57252 ] [Skip]
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9484 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9488 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9474  \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 STORY 2 FLOW\'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \u9474 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9492 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9496 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 User taps "Record This Story" \uc0\u8594  Records Story 2
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0POST /api/stories (story 2 data)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Save to database
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Set free_stories_used = 2
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Mark previous prompt as used
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Tier 1: Generate 1 template
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Tier 3: Story 2 Milestone
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0GPT-4o analyzes both stories
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Generates 4 candidates (2 expansion, 2 connection)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Score and filter
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Store top 2
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0User sees "Next Story" card:
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0"Your father appears in both stories.
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0What's your earliest memory of him?"
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u55357 \u56525  Connecting 1955 and 1982
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9484 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9488 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9474  \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 STORY 3 + PAYWALL FLOW\'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \u9474 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9492 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9496 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 User records Story 3
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0POST /api/stories (story 3 data)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Save to database
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Set free_stories_used = 3
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Tier 1: Generate 1 template
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Tier 3: Story 3 Milestone (SPECIAL)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0GPT-4o analyzes all 3 stories
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Generates 5 candidates
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Score and filter
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Store candidate #1 (highest score):
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0- is_locked = false (show immediately)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0- expires_at = NOW() + 30 days
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Store candidates #2-4 (premium seed):
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0- is_locked = true (hidden until payment)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0- expires_at = NULL (unlocked on payment)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Return success
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9556 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9559 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9553 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 PAYWALL CARD APPEARS \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \u9553 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9553  \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \u9553 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9553 \'a0 \u10024  YOUR STORY 3 INSIGHT \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \u9553 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9553  \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \u9553 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9553 \'a0 "Your father appears in all 3 stories. Tell me about\'a0 \'a0 \'a0 \'a0 \u9553 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9553  \'a0 the first time you disappointed him."\'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \u9553 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9553  \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \u9553 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9553 \'a0 \u55357 \u56525  Based on stories from 1955, 1960, 1982 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \u9553 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9553  \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \u9553 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9553 \'a0 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472  \'a0 \u9553 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9553  \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \u9553 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9553 \'a0 \u55357 \u56481  I've analyzed your first 3 stories and found \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \u9553 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9553  \'a0 \'a0 3 more specific memories you should record.\'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \u9553 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9553  \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \u9553 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9553 \'a0 Ready to unlock your full story?\'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \u9553 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9553  \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \u9553 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9553  \'a0 \'a0 [See What I Found - $149/year] \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \u9553 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9553  \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \u9553 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9553  \'a0 \'a0 [Maybe later]\'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \u9553 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9562 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9552 \u9565 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0User clicks "See What I Found"
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Stripe checkout \uc0\u8594  Payment success
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Webhook: POST /api/webhooks/stripe
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Update users table:
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0subscription_status = 'active'
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Unlock premium seed:
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0UPDATE active_prompts
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0SET is_locked = false,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0expires_at = NOW() + INTERVAL '60 days'
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0WHERE user_id = $1 AND is_locked = true
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0User redirected to timeline
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Sees 4 prompts available (1 original + 3 premium)\

\f2 \cf0 \strokec2 \
\pard\pardeftab720\sa293\partightenfactor0

\f0\b\fs28 \cf0 \strokec2 3.2 Paid Tier Flow (Stories 4+)
\f2\b0\fs24 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \uc0\u9484 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9488 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9474  \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 RECORDING STORY 4-20\'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \u9474 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9492 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9496 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 User records Story N
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0POST /api/stories
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Save to database
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Tier 1: Generate 1 template prompt (always)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Check if milestone (4,7,10,15,20,30,50,100)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0YES \uc0\u8594  Tier 3 Analysis
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0- Stories 4-20: Generate 3 prompts
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0- Stories 30-50: Generate 2 prompts\'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0- Stories 100+: Generate 1 prompt
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0NO \uc0\u8594  Continue
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Return success
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9484 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9488 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9474  \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 EMPTY INVENTORY SCENARIO\'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \u9474 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9492 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9496 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 User opens timeline
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0GET /api/prompts/next
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Query active_prompts WHERE:
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0- user_id = $1
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0- expires_at > NOW()
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0- is_locked = false
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0EMPTY RESULT
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Check last_tier2_attempt timestamp
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0< 24 hours ago \uc0\u8594  Return decade fallback
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8805  24 hours ago \u8594  Generate Tier 2 prompt
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0- Fetch last 5 stories
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0- GPT-4o analysis
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0- Generate 5 candidates
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0- Score and filter
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0- Store top 2
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0- Update last_tier2_attempt
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Return prompt to client\

\f2 \cf0 \strokec2 \
\pard\pardeftab720\sa293\partightenfactor0

\f0\b\fs28 \cf0 \strokec2 3.3 Grace Period Flow (Non-Payer After Story 3)
\f2\b0\fs24 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 Day 0: User records Story 3, sees paywall, clicks "Maybe later"
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0- Can still VIEW timeline and stories
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0- Cannot RECORD Story 4
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0- Email: "Your Story 3 analysis is ready"
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 Day 1-6: User can browse read-only
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0- Timeline shows all 3 stories
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0- "Record" button shows paywall
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0- Prompts visible but locked
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 Day 3: Email: "I found 3 more memories you should record"
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 Day 5: Email: "Last chance - your access expires in 2 days"
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 Day 7: Account goes read-only
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0- Cannot record
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0- Cannot view prompts
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0- Can still see story titles (teaser)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0- Banner: "Subscribe to access your stories and prompts"\

\f2 \cf0 \strokec2 \
\pard\pardeftab720\sa106\partightenfactor0

\f0\b\fs45\fsmilli22667 \cf0 \strokec2 4. DATABASE SCHEMA
\f1\fs36 \
\pard\pardeftab720\sa106\partightenfactor0

\f0\fs34\fsmilli17333 \cf0 4.1 Schema Additions
\f1\fs28 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\fs24 \cf0 sql
\f2\b0 \strokec2 \

\f4\i\b \cf5 \strokec5 -- ============================================================================
\f2\i0\b0 \cf0 \strokec2 \

\f4\i\b \cf5 \strokec5 -- STORIES TABLE ADDITIONS
\f2\i0\b0 \cf0 \strokec2 \

\f4\i\b \cf5 \strokec5 -- ============================================================================
\f2\i0\b0 \cf0 \strokec2 \

\f4\i\b \cf5 \strokec5 -- Add columns for lesson learned functionality
\f2\i0\b0 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0
\cf0 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf6 \strokec6 ALTER\cf3 \strokec3  \cf6 \strokec6 TABLE\cf3 \strokec3  stories \cf6 \strokec6 ADD\cf3 \strokec3  \cf6 \strokec6 COLUMN\cf3 \strokec3  \cf6 \strokec6 IF\cf3 \strokec3  \cf7 \strokec7 NOT\cf3 \strokec3  \cf6 \strokec6 EXISTS\cf3 \strokec3  lesson_learned \cf6 \strokec6 TEXT\cf3 \strokec3 ;
\f2\b0 \cf0 \strokec2 \

\f0\b \cf6 \strokec6 ALTER\cf3 \strokec3  \cf6 \strokec6 TABLE\cf3 \strokec3  stories \cf6 \strokec6 ADD\cf3 \strokec3  \cf6 \strokec6 COLUMN\cf3 \strokec3  \cf6 \strokec6 IF\cf3 \strokec3  \cf7 \strokec7 NOT\cf3 \strokec3  \cf6 \strokec6 EXISTS\cf3 \strokec3  lesson_alternatives JSONB \cf6 \strokec6 DEFAULT\cf3 \strokec3  \cf8 \strokec8 '[]'\cf3 \strokec3 ::jsonb;
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f4\i\b \cf5 \strokec5 -- Stores alternative lesson suggestions user can choose from
\f2\i0\b0 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0
\cf0 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf6 \strokec6 ALTER\cf3 \strokec3  \cf6 \strokec6 TABLE\cf3 \strokec3  stories \cf6 \strokec6 ADD\cf3 \strokec3  \cf6 \strokec6 COLUMN\cf3 \strokec3  \cf6 \strokec6 IF\cf3 \strokec3  \cf7 \strokec7 NOT\cf3 \strokec3  \cf6 \strokec6 EXISTS\cf3 \strokec3  character_insights JSONB;
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f4\i\b \cf5 \strokec5 -- Stores character analysis from milestone processing
\f2\i0\b0 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0
\cf0 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf6 \strokec6 ALTER\cf3 \strokec3  \cf6 \strokec6 TABLE\cf3 \strokec3  stories \cf6 \strokec6 ADD\cf3 \strokec3  \cf6 \strokec6 COLUMN\cf3 \strokec3  \cf6 \strokec6 IF\cf3 \strokec3  \cf7 \strokec7 NOT\cf3 \strokec3  \cf6 \strokec6 EXISTS\cf3 \strokec3  source_prompt_id UUID;
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f4\i\b \cf5 \strokec5 -- References active_prompts.id (but not FK since prompt gets deleted)
\f2\i0\b0 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0
\cf0 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf6 \strokec6 CREATE\cf3 \strokec3  \cf6 \strokec6 INDEX\cf3 \strokec3  idx_stories_source_prompt \cf6 \strokec6 ON\cf3 \strokec3  stories(source_prompt_id)\'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf6 \strokec6 WHERE\cf3 \strokec3  source_prompt_id \cf7 \strokec7 IS\cf3 \strokec3  \cf7 \strokec7 NOT\cf3 \strokec3  \cf9 \strokec9 NULL\cf3 \strokec3 ;
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0
\cf0 \
\pard\pardeftab720\sa240\partightenfactor0

\f4\i\b \cf5 \strokec5 -- ============================================================================
\f2\i0\b0 \cf0 \strokec2 \

\f4\i\b \cf5 \strokec5 -- CHARACTER EVOLUTION TABLE
\f2\i0\b0 \cf0 \strokec2 \

\f4\i\b \cf5 \strokec5 -- ============================================================================
\f2\i0\b0 \cf0 \strokec2 \

\f4\i\b \cf5 \strokec5 -- Tracks character development across stories
\f2\i0\b0 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0
\cf0 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf6 \strokec6 CREATE\cf3 \strokec3  \cf6 \strokec6 TABLE\cf3 \strokec3  character_evolution (
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf3 \strokec3 \'a0\'a0id UUID \cf6 \strokec6 PRIMARY\cf3 \strokec3  \cf6 \strokec6 KEY\cf3 \strokec3  \cf6 \strokec6 DEFAULT\cf3 \strokec3  gen_random_uuid(),
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0user_id UUID \cf7 \strokec7 NOT\cf3 \strokec3  \cf9 \strokec9 NULL\cf3 \strokec3  \cf6 \strokec6 REFERENCES\cf3 \strokec3  users(id) \cf6 \strokec6 ON\cf3 \strokec3  \cf6 \strokec6 DELETE\cf3 \strokec3  \cf6 \strokec6 CASCADE\cf3 \strokec3 ,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0story_count \cf6 \strokec6 INTEGER\cf3 \strokec3  \cf7 \strokec7 NOT\cf3 \strokec3  \cf9 \strokec9 NULL\cf3 \strokec3 ,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f4\i \cf5 \strokec5 -- Character analysis
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0traits JSONB, 
\f4\i \cf5 \strokec5 -- [\{trait: "resilience", confidence: 0.85, evidence: [...]\}]
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0invisible_rules \cf6 \strokec6 TEXT\cf3 \strokec3 [], 
\f4\i \cf5 \strokec5 -- ["Never ask for help twice", "Family first"]
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0contradictions JSONB, 
\f4\i \cf5 \strokec5 -- [\{stated: "...", lived: "...", tension: "..."\}]
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f4\i \cf5 \strokec5 -- Metadata
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0analyzed_at \cf6 \strokec6 TIMESTAMP\cf3 \strokec3  \cf6 \strokec6 DEFAULT\cf3 \strokec3  \cf7 \strokec7 NOW\cf3 \strokec3 (),
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0model_version \cf6 \strokec6 TEXT\cf3 \strokec3  \cf6 \strokec6 DEFAULT\cf3 \strokec3  \cf8 \strokec8 'gpt-4o'\cf3 \strokec3 ,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f4\i \cf5 \strokec5 -- Indexes
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 UNIQUE\cf3 \strokec3 (user_id, story_count)
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 );
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0
\cf0 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf6 \strokec6 CREATE\cf3 \strokec3  \cf6 \strokec6 INDEX\cf3 \strokec3  idx_character_evolution_user \cf6 \strokec6 ON\cf3 \strokec3  character_evolution(user_id, story_count \cf6 \strokec6 DESC\cf3 \strokec3 );
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0
\cf0 \
\
\pard\pardeftab720\partightenfactor0

\f3 \cf0 \strokec2 sql
\f2 \strokec2 \

\f5\i \cf10 \strokec10 -- ============================================================================
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- ACTIVE PROMPTS TABLE
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- ============================================================================
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- Stores currently active prompts (1-5 per user at any time)
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- Prompts expire and are archived to prompt_history
\f2\i0 \cf0 \strokec2 \

\f3 \cf11 \strokec11 CREATE\cf4 \strokec4  \cf11 \strokec11 TABLE\cf4 \strokec4  active_prompts (
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0id UUID \cf11 \strokec11 PRIMARY\cf4 \strokec4  \cf11 \strokec11 KEY\cf4 \strokec4  \cf11 \strokec11 DEFAULT\cf4 \strokec4  gen_random_uuid(),
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0user_id UUID \cf12 \strokec12 NOT\cf4 \strokec4  \cf13 \strokec13 NULL\cf4 \strokec4  \cf11 \strokec11 REFERENCES\cf4 \strokec4  users(id) \cf11 \strokec11 ON\cf4 \strokec4  \cf11 \strokec11 DELETE\cf4 \strokec4  \cf11 \strokec11 CASCADE\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 -- Prompt content
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0prompt_text \cf11 \strokec11 TEXT\cf4 \strokec4  \cf12 \strokec12 NOT\cf4 \strokec4  \cf13 \strokec13 NULL\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0context_note \cf11 \strokec11 TEXT\cf4 \strokec4 , 
\f5\i \cf10 \strokec10 -- e.g., "Based on your 1955 story"
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 -- Deduplication & anchoring
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0anchor_entity \cf11 \strokec11 TEXT\cf4 \strokec4 , 
\f5\i \cf10 \strokec10 -- e.g., "father's workshop", "Mrs. Henderson"
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0anchor_year \cf11 \strokec11 INTEGER\cf4 \strokec4 , 
\f5\i \cf10 \strokec10 -- e.g., 1955 (NULL if not year-specific)
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0anchor_hash \cf11 \strokec11 TEXT\cf4 \strokec4  \cf12 \strokec12 NOT\cf4 \strokec4  \cf13 \strokec13 NULL\cf4 \strokec4 , 
\f5\i \cf10 \strokec10 -- sha1(`$\{type\}|$\{entity\}|$\{year||'NA'\}`)
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 -- Tier & quality
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0tier \cf11 \strokec11 INTEGER\cf4 \strokec4  \cf12 \strokec12 NOT\cf4 \strokec4  \cf13 \strokec13 NULL\cf4 \strokec4 , 
\f5\i \cf10 \strokec10 -- 0=fallback, 1=template, 2=on-demand, 3=milestone
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0memory_type \cf11 \strokec11 TEXT\cf4 \strokec4 , 
\f5\i \cf10 \strokec10 -- person_expansion, object_origin, decade_gap, etc.
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0prompt_score \cf11 \strokec11 INTEGER\cf4 \strokec4 , 
\f5\i \cf10 \strokec10 -- 0-100 (recording likelihood from GPT-4o)
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0score_reason \cf11 \strokec11 TEXT\cf4 \strokec4 , 
\f5\i \cf10 \strokec10 -- 1-sentence explanation for audit
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0model_version \cf11 \strokec11 TEXT\cf4 \strokec4  \cf11 \strokec11 DEFAULT\cf4 \strokec4  \cf14 \strokec14 'gpt-4o'\cf4 \strokec4 , 
\f5\i \cf10 \strokec10 -- Track which model generated it
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 -- Lifecycle
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0created_at \cf11 \strokec11 TIMESTAMP\cf4 \strokec4  \cf11 \strokec11 DEFAULT\cf4 \strokec4  \cf12 \strokec12 NOW\cf4 \strokec4 (),
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0expires_at \cf11 \strokec11 TIMESTAMP\cf4 \strokec4  \cf12 \strokec12 NOT\cf4 \strokec4  \cf13 \strokec13 NULL\cf4 \strokec4 , 
\f5\i \cf10 \strokec10 -- Auto-cleanup after expiry
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0is_locked \cf11 \strokec11 BOOLEAN\cf4 \strokec4  \cf11 \strokec11 DEFAULT\cf4 \strokec4  \cf13 \strokec13 false\cf4 \strokec4 , 
\f5\i \cf10 \strokec10 -- true = hidden until payment
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 -- Engagement tracking
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0shown_count \cf11 \strokec11 INTEGER\cf4 \strokec4  \cf11 \strokec11 DEFAULT\cf4 \strokec4  \cf13 \strokec13 0\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0last_shown_at \cf11 \strokec11 TIMESTAMP\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 -- Constraints
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 UNIQUE\cf4 \strokec4 (user_id, anchor_hash) 
\f5\i \cf10 \strokec10 -- Prevent duplicate prompts
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 );
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f5\i \cf10 \strokec10 -- Indexes
\f2\i0 \cf0 \strokec2 \

\f3 \cf11 \strokec11 CREATE\cf4 \strokec4  \cf11 \strokec11 INDEX\cf4 \strokec4  idx_active_prompts_user \cf11 \strokec11 ON\cf4 \strokec4  active_prompts(user_id, expires_at \cf11 \strokec11 DESC\cf4 \strokec4 );
\f2 \cf0 \strokec2 \

\f3 \cf11 \strokec11 CREATE\cf4 \strokec4  \cf11 \strokec11 INDEX\cf4 \strokec4  idx_active_prompts_tier \cf11 \strokec11 ON\cf4 \strokec4  active_prompts(tier, prompt_score \cf11 \strokec11 DESC\cf4 \strokec4 );
\f2 \cf0 \strokec2 \

\f3 \cf11 \strokec11 CREATE\cf4 \strokec4  \cf11 \strokec11 INDEX\cf4 \strokec4  idx_active_prompts_locked \cf11 \strokec11 ON\cf4 \strokec4  active_prompts(user_id, is_locked);
\f2 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- ============================================================================
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- PROMPT HISTORY TABLE
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- ============================================================================
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- Archives used/skipped/expired prompts for analytics
\f2\i0 \cf0 \strokec2 \

\f3 \cf11 \strokec11 CREATE\cf4 \strokec4  \cf11 \strokec11 TABLE\cf4 \strokec4  prompt_history (
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0id UUID \cf11 \strokec11 PRIMARY\cf4 \strokec4  \cf11 \strokec11 KEY\cf4 \strokec4  \cf11 \strokec11 DEFAULT\cf4 \strokec4  gen_random_uuid(),
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0user_id UUID \cf12 \strokec12 NOT\cf4 \strokec4  \cf13 \strokec13 NULL\cf4 \strokec4  \cf11 \strokec11 REFERENCES\cf4 \strokec4  users(id) \cf11 \strokec11 ON\cf4 \strokec4  \cf11 \strokec11 DELETE\cf4 \strokec4  \cf11 \strokec11 CASCADE\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 -- Original prompt data
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0prompt_text \cf11 \strokec11 TEXT\cf4 \strokec4  \cf12 \strokec12 NOT\cf4 \strokec4  \cf13 \strokec13 NULL\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0anchor_hash \cf11 \strokec11 TEXT\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0anchor_entity \cf11 \strokec11 TEXT\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0anchor_year \cf11 \strokec11 INTEGER\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0tier \cf11 \strokec11 INTEGER\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0memory_type \cf11 \strokec11 TEXT\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0prompt_score \cf11 \strokec11 INTEGER\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 -- Outcome tracking
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0shown_count \cf11 \strokec11 INTEGER\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0outcome \cf11 \strokec11 TEXT\cf4 \strokec4  \cf12 \strokec12 NOT\cf4 \strokec4  \cf13 \strokec13 NULL\cf4 \strokec4 , 
\f5\i \cf10 \strokec10 -- 'used' | 'skipped' | 'expired'
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0story_id UUID, 
\f5\i \cf10 \strokec10 -- NULL if skipped/expired, set if used
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 -- Timestamps
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0created_at \cf11 \strokec11 TIMESTAMP\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0resolved_at \cf11 \strokec11 TIMESTAMP\cf4 \strokec4  \cf11 \strokec11 DEFAULT\cf4 \strokec4  \cf12 \strokec12 NOW\cf4 \strokec4 ()
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 );
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf11 \strokec11 CREATE\cf4 \strokec4  \cf11 \strokec11 INDEX\cf4 \strokec4  idx_prompt_history_outcome \cf11 \strokec11 ON\cf4 \strokec4  prompt_history(user_id, outcome, tier);
\f2 \cf0 \strokec2 \

\f3 \cf11 \strokec11 CREATE\cf4 \strokec4  \cf11 \strokec11 INDEX\cf4 \strokec4  idx_prompt_history_story \cf11 \strokec11 ON\cf4 \strokec4  prompt_history(story_id) \cf11 \strokec11 WHERE\cf4 \strokec4  story_id \cf12 \strokec12 IS\cf4 \strokec4  \cf12 \strokec12 NOT\cf4 \strokec4  \cf13 \strokec13 NULL\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- ============================================================================
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- USERS TABLE ADDITIONS
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- ============================================================================
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- Add columns to existing users table
\f2\i0 \cf0 \strokec2 \

\f3 \cf11 \strokec11 ALTER\cf4 \strokec4  \cf11 \strokec11 TABLE\cf4 \strokec4  users \cf11 \strokec11 ADD\cf4 \strokec4  \cf11 \strokec11 COLUMN\cf4 \strokec4  \cf11 \strokec11 IF\cf4 \strokec4  \cf12 \strokec12 NOT\cf4 \strokec4  \cf11 \strokec11 EXISTS\cf4 \strokec4  free_stories_used \cf11 \strokec11 INTEGER\cf4 \strokec4  \cf11 \strokec11 DEFAULT\cf4 \strokec4  \cf13 \strokec13 0\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf11 \strokec11 ALTER\cf4 \strokec4  \cf11 \strokec11 TABLE\cf4 \strokec4  users \cf11 \strokec11 ADD\cf4 \strokec4  \cf11 \strokec11 COLUMN\cf4 \strokec4  \cf11 \strokec11 IF\cf4 \strokec4  \cf12 \strokec12 NOT\cf4 \strokec4  \cf11 \strokec11 EXISTS\cf4 \strokec4  subscription_status \cf11 \strokec11 TEXT\cf4 \strokec4  \cf11 \strokec11 DEFAULT\cf4 \strokec4  \cf14 \strokec14 'none'\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- Values: 'none', 'active', 'cancelled', 'expired'
\f2\i0 \cf0 \strokec2 \

\f3 \cf11 \strokec11 ALTER\cf4 \strokec4  \cf11 \strokec11 TABLE\cf4 \strokec4  users \cf11 \strokec11 ADD\cf4 \strokec4  \cf11 \strokec11 COLUMN\cf4 \strokec4  \cf11 \strokec11 IF\cf4 \strokec4  \cf12 \strokec12 NOT\cf4 \strokec4  \cf11 \strokec11 EXISTS\cf4 \strokec4  last_tier2_attempt \cf11 \strokec11 TIMESTAMP\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- Rate limit Tier 2 on-demand generation (max 1 per 24 hours)
\f2\i0 \cf0 \strokec2 \

\f3 \cf11 \strokec11 ALTER\cf4 \strokec4  \cf11 \strokec11 TABLE\cf4 \strokec4  users \cf11 \strokec11 ADD\cf4 \strokec4  \cf11 \strokec11 COLUMN\cf4 \strokec4  \cf11 \strokec11 IF\cf4 \strokec4  \cf12 \strokec12 NOT\cf4 \strokec4  \cf11 \strokec11 EXISTS\cf4 \strokec4  do_not_ask JSONB \cf11 \strokec11 DEFAULT\cf4 \strokec4  \cf14 \strokec14 '[]'\cf4 \strokec4 ::jsonb;
\f2 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- Array of topics user doesn't want to be asked about
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- Example: ["divorce", "mother's death", "bankruptcy"]
\f2\i0 \cf0 \strokec2 \

\f3 \cf11 \strokec11 ALTER\cf4 \strokec4  \cf11 \strokec11 TABLE\cf4 \strokec4  users \cf11 \strokec11 ADD\cf4 \strokec4  \cf11 \strokec11 COLUMN\cf4 \strokec4  \cf11 \strokec11 IF\cf4 \strokec4  \cf12 \strokec12 NOT\cf4 \strokec4  \cf11 \strokec11 EXISTS\cf4 \strokec4  onboarding_t3_ran_at \cf11 \strokec11 TIMESTAMP\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- Track when Story 1/2/3 analysis ran (for debugging)
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- ============================================================================
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- STORIES TABLE ADDITIONS
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- ============================================================================
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- Add column to track which prompt generated this story
\f2\i0 \cf0 \strokec2 \

\f3 \cf11 \strokec11 ALTER\cf4 \strokec4  \cf11 \strokec11 TABLE\cf4 \strokec4  stories \cf11 \strokec11 ADD\cf4 \strokec4  \cf11 \strokec11 COLUMN\cf4 \strokec4  \cf11 \strokec11 IF\cf4 \strokec4  \cf12 \strokec12 NOT\cf4 \strokec4  \cf11 \strokec11 EXISTS\cf4 \strokec4  source_prompt_id UUID;
\f2 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- References active_prompts.id (but not FK since prompt gets deleted)
\f2\i0 \cf0 \strokec2 \

\f3 \cf11 \strokec11 CREATE\cf4 \strokec4  \cf11 \strokec11 INDEX\cf4 \strokec4  idx_stories_source_prompt \cf11 \strokec11 ON\cf4 \strokec4  stories(source_prompt_id)\'a0
\f2 \cf0 \strokec2 \

\f3 \cf11 \strokec11 WHERE\cf4 \strokec4  source_prompt_id \cf12 \strokec12 IS\cf4 \strokec4  \cf12 \strokec12 NOT\cf4 \strokec4  \cf13 \strokec13 NULL\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- ============================================================================
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- CLEANUP JOB (Daily)
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- ============================================================================
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- Archive expired prompts and clean up old history
\f2\i0 \cf0 \strokec2 \

\f3 \cf11 \strokec11 CREATE\cf4 \strokec4  \cf12 \strokec12 OR\cf4 \strokec4  \cf11 \strokec11 REPLACE\cf4 \strokec4  \cf11 \strokec11 FUNCTION\cf4 \strokec4  archive_expired_prompts() \cf11 \strokec11 RETURNS\cf4 \strokec4  void \cf11 \strokec11 AS\cf4 \strokec4  $$
\f2 \cf0 \strokec2 \

\f3 \cf11 \strokec11 BEGIN
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 -- Move expired prompts to history
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 INSERT\cf4 \strokec4  \cf11 \strokec11 INTO\cf4 \strokec4  prompt_history (
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0user_id, prompt_text, anchor_hash, anchor_entity, anchor_year,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0tier, memory_type, prompt_score, shown_count, outcome, created_at
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 SELECT\cf4 \strokec4 \'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0user_id, prompt_text, anchor_hash, anchor_entity, anchor_year,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0tier, memory_type, prompt_score, shown_count, \cf14 \strokec14 'expired'\cf4 \strokec4 , created_at
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 FROM\cf4 \strokec4  active_prompts
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 WHERE\cf4 \strokec4  expires_at \cf12 \strokec12 <\cf4 \strokec4  \cf12 \strokec12 NOW\cf4 \strokec4 () \cf12 \strokec12 AND\cf4 \strokec4  is_locked \cf12 \strokec12 =\cf4 \strokec4  \cf13 \strokec13 false\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 -- Delete expired prompts
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 DELETE\cf4 \strokec4  \cf11 \strokec11 FROM\cf4 \strokec4  active_prompts\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 WHERE\cf4 \strokec4  expires_at \cf12 \strokec12 <\cf4 \strokec4  \cf12 \strokec12 NOW\cf4 \strokec4 () \cf12 \strokec12 AND\cf4 \strokec4  is_locked \cf12 \strokec12 =\cf4 \strokec4  \cf13 \strokec13 false\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 -- Delete old history (keep 1 year)
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 DELETE\cf4 \strokec4  \cf11 \strokec11 FROM\cf4 \strokec4  prompt_history\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 WHERE\cf4 \strokec4  resolved_at \cf12 \strokec12 <\cf4 \strokec4  \cf12 \strokec12 NOW\cf4 \strokec4 () \cf12 \strokec12 -\cf4 \strokec4  \cf11 \strokec11 INTERVAL\cf4 \strokec4  \cf14 \strokec14 '365 days'\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf11 \strokec11 END\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 $$ \cf11 \strokec11 LANGUAGE\cf4 \strokec4  plpgsql;
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f5\i \cf10 \strokec10 -- Schedule daily (use pg_cron or external scheduler)\
\pard\pardeftab720\partightenfactor0

\f2\i0 \cf0 \strokec2 \
\
\pard\pardeftab720\sa106\partightenfactor0

\f0\b\fs45\fsmilli22667 \cf0 \strokec2 5. API SPECIFICATIONS
\f1\fs36 \
\pard\pardeftab720\sa106\partightenfactor0

\f0\fs34\fsmilli17333 \cf0 5.1 POST /api/transcribe
\f1\fs28 \
\pard\pardeftab720\sa320\partightenfactor0

\f0\fs24 \cf0 Purpose: Transcribe audio and generate lesson suggestions New endpoint - processes recording immediately
\f2\b0 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 typescript
\f2\b0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf9 \strokec9 POST\cf3 \strokec3  \cf7 \strokec7 /\cf3 \strokec3 api\cf7 \strokec7 /\cf3 \strokec3 transcribe
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf3 \strokec3 Authorization\cf7 \strokec7 :\cf3 \strokec3  Bearer \{jwt_token\}
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 Content\cf7 \strokec7 -\cf3 \strokec3 Type\cf7 \strokec7 :\cf3 \strokec3  application\cf7 \strokec7 /\cf3 \strokec3 json
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0
\cf0 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf3 \strokec3 \{
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf15 \strokec15 "audioBase64"\cf7 \strokec7 :\cf3 \strokec3  \cf8 \strokec8 "..."\cf3 \strokec3 ,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf15 \strokec15 "mimeType"\cf7 \strokec7 :\cf3 \strokec3  \cf8 \strokec8 "audio/webm"
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa160\partightenfactor0

\f0\b \cf3 \strokec3 \}
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa320\partightenfactor0

\f0\b \cf0 Response:
\f2\b0 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 typescript
\f2\b0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf3 \strokec3 \{
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf15 \strokec15 "transcription"\cf7 \strokec7 :\cf3 \strokec3  \cf8 \strokec8 "Formatted story text..."\cf3 \strokec3 ,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf15 \strokec15 "lessonOptions"\cf7 \strokec7 :\cf3 \strokec3  [
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\cf8 \strokec8 "Never let pride cost you a relationship that matters"\cf3 \strokec3 ,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\cf8 \strokec8 "Sometimes love means letting someone be wrong"\cf3 \strokec3 ,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\cf8 \strokec8 "The need to be right can make you very alone"
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0],
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf15 \strokec15 "duration"\cf7 \strokec7 :\cf3 \strokec3  \cf9 \strokec9 120\cf3 \strokec3  
\f4\i \cf5 \strokec5 // estimated seconds
\f2\i0\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa160\partightenfactor0

\f0\b \cf3 \strokec3 \}
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa320\partightenfactor0

\f0\b \cf0 Server-Side Logic:
\f2\b0 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 typescript
\f2\b0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf6 \strokec6 async\cf3 \strokec3  \cf6 \strokec6 function\cf3 \strokec3  \cf7 \strokec7 handleTranscribe\cf3 \strokec3 (req, res) \{
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 const\cf3 \strokec3  \{ audioBase64, mimeType \} \cf7 \strokec7 =\cf3 \strokec3  req.body;
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 const\cf3 \strokec3  audioBuffer \cf7 \strokec7 =\cf3 \strokec3  Buffer.\cf6 \strokec6 from\cf3 \strokec3 (audioBase64, \cf8 \strokec8 'base64'\cf3 \strokec3 );
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f4\i \cf5 \strokec5 // Step 1: Whisper transcription (required first)
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 const\cf3 \strokec3  transcription \cf7 \strokec7 =\cf3 \strokec3  \cf6 \strokec6 await\cf3 \strokec3  openai.audio.transcriptions.\cf7 \strokec7 create\cf3 \strokec3 (\{
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0file\cf7 \strokec7 :\cf3 \strokec3  audioStream,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0model\cf7 \strokec7 :\cf3 \strokec3  \cf8 \strokec8 "whisper-1"
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\});
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f4\i \cf5 \strokec5 // Step 2: Parallel GPT-4 calls for speed
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 const\cf3 \strokec3  [formatted, lessons] \cf7 \strokec7 =\cf3 \strokec3  \cf6 \strokec6 await\cf3 \strokec3  \cf9 \strokec9 Promise\cf3 \strokec3 .\cf7 \strokec7 all\cf3 \strokec3 ([
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0
\f4\i \cf5 \strokec5 // Format the transcription
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0openai.chat.completions.\cf7 \strokec7 create\cf3 \strokec3 (\{
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0model\cf7 \strokec7 :\cf3 \strokec3  \cf8 \strokec8 "gpt-4-turbo-preview"\cf3 \strokec3 , 
\f4\i \cf5 \strokec5 // Fast, good enough for formatting
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0messages\cf7 \strokec7 :\cf3 \strokec3  [\{
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0role\cf7 \strokec7 :\cf3 \strokec3  \cf8 \strokec8 "system"\cf3 \strokec3 ,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0content\cf7 \strokec7 :\cf3 \strokec3  \cf8 \strokec8 "Format this transcribed speech into paragraphs..."
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\}, \{
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0role\cf7 \strokec7 :\cf3 \strokec3  \cf8 \strokec8 "user"\cf3 \strokec3 ,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0content\cf7 \strokec7 :\cf3 \strokec3  transcription.text
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\}],
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0temperature\cf7 \strokec7 :\cf3 \strokec3  \cf9 \strokec9 0.3\cf3 \strokec3 ,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0max_tokens\cf7 \strokec7 :\cf3 \strokec3  \cf9 \strokec9 3000
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\}),
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0
\f4\i \cf5 \strokec5 // Generate lesson options (high quality)
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0openai.chat.completions.\cf7 \strokec7 create\cf3 \strokec3 (\{
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0model\cf7 \strokec7 :\cf3 \strokec3  \cf8 \strokec8 "gpt-4o"\cf3 \strokec3 , 
\f4\i \cf5 \strokec5 // Best model for wisdom extraction
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0messages\cf7 \strokec7 :\cf3 \strokec3  [\{
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0role\cf7 \strokec7 :\cf3 \strokec3  \cf8 \strokec8 "system"\cf3 \strokec3 ,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0content\cf7 \strokec7 :\cf3 \strokec3  \cf8 \strokec8 `Extract 2-3 possible lessons learned from this story.
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Look for:
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0- The turning point where understanding shifted
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0- What they'd tell their younger self
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0- The cost of the experience and what it gave them
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0- Universal truths hidden in personal experience
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Provide 2-3 options (15-20 words each):
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a01. Practical lesson (what to DO)
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a02. Emotional truth (what to FEEL)
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf8 \strokec8 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a03. Character insight (who to BE)`
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\}, \{
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0role\cf7 \strokec7 :\cf3 \strokec3  \cf8 \strokec8 "user"\cf3 \strokec3 ,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0content\cf7 \strokec7 :\cf3 \strokec3  transcription.text
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\}],
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0temperature\cf7 \strokec7 :\cf3 \strokec3  \cf9 \strokec9 0.8\cf3 \strokec3 , 
\f4\i \cf5 \strokec5 // Higher for creative insights
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0max_tokens\cf7 \strokec7 :\cf3 \strokec3  \cf9 \strokec9 200
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\})
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0]);
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f4\i \cf5 \strokec5 // Parse responses
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 const\cf3 \strokec3  formattedText \cf7 \strokec7 =\cf3 \strokec3  formatted.choices[\cf9 \strokec9 0\cf3 \strokec3 ].message.content;
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 const\cf3 \strokec3  lessonOptions \cf7 \strokec7 =\cf3 \strokec3  \cf7 \strokec7 parseLessonOptions\cf3 \strokec3 (lessons.choices[\cf9 \strokec9 0\cf3 \strokec3 ].message.content);
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 return\cf3 \strokec3  res.\cf7 \strokec7 json\cf3 \strokec3 (\{
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0transcription\cf7 \strokec7 :\cf3 \strokec3  formattedText,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0lessonOptions\cf7 \strokec7 :\cf3 \strokec3  lessonOptions,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0duration\cf7 \strokec7 :\cf3 \strokec3  \cf7 \strokec7 estimateDuration\cf3 \strokec3 (audioBuffer.length)
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\});
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa160\partightenfactor0

\f0\b \cf3 \strokec3 \}\

\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa106\partightenfactor0

\f0\b\fs34\fsmilli17333 \cf0 5.2 POST /api/stories
\f1\fs28 \
\pard\pardeftab720\sa320\partightenfactor0

\f0\fs24 \cf0 Purpose: Save a new story and trigger prompt generation Updated to handle lesson learned
\f2\b0 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 typescript
\f2\b0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf9 \strokec9 POST\cf3 \strokec3  \cf7 \strokec7 /\cf3 \strokec3 api\cf7 \strokec7 /\cf3 \strokec3 stories
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf3 \strokec3 Authorization\cf7 \strokec7 :\cf3 \strokec3  Bearer \{jwt_token\}
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 Content\cf7 \strokec7 -\cf3 \strokec3 Type\cf7 \strokec7 :\cf3 \strokec3  application\cf7 \strokec7 /\cf3 \strokec3 json
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0
\cf0 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf3 \strokec3 \{
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf15 \strokec15 "storyYear"\cf7 \strokec7 :\cf3 \strokec3  \cf9 \strokec9 1955\cf3 \strokec3 ,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf15 \strokec15 "transcript"\cf7 \strokec7 :\cf3 \strokec3  \cf8 \strokec8 "I was 23 when I decided to leave medical school..."\cf3 \strokec3 ,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf15 \strokec15 "audioUrl"\cf7 \strokec7 :\cf3 \strokec3  \cf8 \strokec8 "https://supabase.co/storage/..."\cf3 \strokec3 ,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf15 \strokec15 "lessonLearned"\cf7 \strokec7 :\cf3 \strokec3  \cf8 \strokec8 "Sometimes you have to disappoint others to be true to yourself"\cf3 \strokec3 ,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf15 \strokec15 "photos"\cf7 \strokec7 :\cf3 \strokec3  [
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\{ \cf15 \strokec15 "url"\cf7 \strokec7 :\cf3 \strokec3  \cf8 \strokec8 "https://..."\cf3 \strokec3 , \cf15 \strokec15 "heroPhoto"\cf7 \strokec7 :\cf3 \strokec3  \cf9 \strokec9 true\cf3 \strokec3  \}
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0],
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf15 \strokec15 "sourcePromptId"\cf7 \strokec7 :\cf3 \strokec3  \cf8 \strokec8 "uuid-of-prompt-if-applicable"\cf3 \strokec3  
\f4\i \cf5 \strokec5 // Optional
\f2\i0\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa160\partightenfactor0

\f0\b \cf3 \strokec3 \}
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa320\partightenfactor0

\f0\b \cf0 Server-Side Logic:
\f2\b0 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 typescript
\f2\b0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf6 \strokec6 async\cf3 \strokec3  \cf6 \strokec6 function\cf3 \strokec3  \cf7 \strokec7 handleStoryCreate\cf3 \strokec3 (req, res) \{
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 const\cf3 \strokec3  userId \cf7 \strokec7 =\cf3 \strokec3  req.user.id;
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 const\cf3 \strokec3  \{ storyYear, transcript, audioUrl, photos, lessonLearned, sourcePromptId \} \cf7 \strokec7 =\cf3 \strokec3  req.body;
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f4\i \cf5 \strokec5 // 1. Save story to database (includes lesson)
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 const\cf3 \strokec3  story \cf7 \strokec7 =\cf3 \strokec3  \cf6 \strokec6 await\cf3 \strokec3  db.stories.\cf7 \strokec7 create\cf3 \strokec3 (\{
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0userId,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0storyYear,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0transcript,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0audioUrl,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0photos,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0lessonLearned, 
\f4\i \cf5 \strokec5 // Already generated and possibly edited by user
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0sourcePromptId,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0createdAt\cf7 \strokec7 :\cf3 \strokec3  \cf6 \strokec6 new\cf3 \strokec3  \cf9 \strokec9 Date\cf3 \strokec3 ()
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\});
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f4\i \cf5 \strokec5 // 2. Update free_stories_used counter
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 const\cf3 \strokec3  user \cf7 \strokec7 =\cf3 \strokec3  \cf6 \strokec6 await\cf3 \strokec3  db.users.\cf7 \strokec7 findById\cf3 \strokec3 (userId);
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 const\cf3 \strokec3  freeStoriesUsed \cf7 \strokec7 =\cf3 \strokec3  user.free_stories_used \cf7 \strokec7 +\cf3 \strokec3  \cf9 \strokec9 1\cf3 \strokec3 ;
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 await\cf3 \strokec3  db.users.\cf7 \strokec7 update\cf3 \strokec3 (userId, \{ free_stories_used\cf7 \strokec7 :\cf3 \strokec3  freeStoriesUsed \});
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f4\i \cf5 \strokec5 // 3. Mark source prompt as used (if applicable)
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 if\cf3 \strokec3  (sourcePromptId) \{
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\cf6 \strokec6 const\cf3 \strokec3  prompt \cf7 \strokec7 =\cf3 \strokec3  \cf6 \strokec6 await\cf3 \strokec3  db.active_prompts.\cf7 \strokec7 findById\cf3 \strokec3 (sourcePromptId);
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0
\f4\i \cf5 \strokec5 // Archive to history
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\cf6 \strokec6 await\cf3 \strokec3  db.prompt_history.\cf7 \strokec7 create\cf3 \strokec3 (\{
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0userId,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0promptText\cf7 \strokec7 :\cf3 \strokec3  prompt.prompt_text,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0anchorHash\cf7 \strokec7 :\cf3 \strokec3  prompt.anchor_hash,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0anchorEntity\cf7 \strokec7 :\cf3 \strokec3  prompt.anchor_entity,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0tier\cf7 \strokec7 :\cf3 \strokec3  prompt.tier,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0memoryType\cf7 \strokec7 :\cf3 \strokec3  prompt.memory_type,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0promptScore\cf7 \strokec7 :\cf3 \strokec3  prompt.prompt_score,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0shownCount\cf7 \strokec7 :\cf3 \strokec3  prompt.shown_count,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0outcome\cf7 \strokec7 :\cf3 \strokec3  \cf8 \strokec8 'used'\cf3 \strokec3 ,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0storyId\cf7 \strokec7 :\cf3 \strokec3  story.id,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0createdAt\cf7 \strokec7 :\cf3 \strokec3  prompt.created_at
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\});
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0
\f4\i \cf5 \strokec5 // Delete from active
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\cf6 \strokec6 await\cf3 \strokec3  db.active_prompts.\cf7 \strokec7 delete\cf3 \strokec3 (sourcePromptId);
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\}
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f4\i \cf5 \strokec5 // 4. Generate Tier 1 template prompt (synchronous, fast)
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 const\cf3 \strokec3  tier1Prompt \cf7 \strokec7 =\cf3 \strokec3  \cf7 \strokec7 generateTier1Template\cf3 \strokec3 (transcript, storyYear);
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 if\cf3 \strokec3  (tier1Prompt) \{
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\cf6 \strokec6 await\cf3 \strokec3  db.active_prompts.\cf7 \strokec7 create\cf3 \strokec3 (\{
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0userId,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0promptText\cf7 \strokec7 :\cf3 \strokec3  tier1Prompt.text,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0contextNote\cf7 \strokec7 :\cf3 \strokec3  tier1Prompt.context,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0anchorEntity\cf7 \strokec7 :\cf3 \strokec3  tier1Prompt.entity,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0anchorYear\cf7 \strokec7 :\cf3 \strokec3  storyYear,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0anchorHash\cf7 \strokec7 :\cf3 \strokec3  \cf7 \strokec7 generateAnchorHash\cf3 \strokec3 (tier1Prompt),
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0tier\cf7 \strokec7 :\cf3 \strokec3  \cf9 \strokec9 1\cf3 \strokec3 ,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0memoryType\cf7 \strokec7 :\cf3 \strokec3  tier1Prompt.type,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0expiresAt\cf7 \strokec7 :\cf3 \strokec3  \cf6 \strokec6 new\cf3 \strokec3  \cf9 \strokec9 Date\cf3 \strokec3 (\cf9 \strokec9 Date\cf3 \strokec3 .\cf7 \strokec7 now\cf3 \strokec3 () \cf7 \strokec7 +\cf3 \strokec3  \cf9 \strokec9 7\cf3 \strokec3  \cf7 \strokec7 *\cf3 \strokec3  \cf9 \strokec9 24\cf3 \strokec3  \cf7 \strokec7 *\cf3 \strokec3  \cf9 \strokec9 60\cf3 \strokec3  \cf7 \strokec7 *\cf3 \strokec3  \cf9 \strokec9 60\cf3 \strokec3  \cf7 \strokec7 *\cf3 \strokec3  \cf9 \strokec9 1000\cf3 \strokec3 ) 
\f4\i \cf5 \strokec5 // 7 days
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\});
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\}
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f4\i \cf5 \strokec5 // 5. Check for Tier 3 milestone - trigger COMBINED analysis
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 const\cf3 \strokec3  storyCount \cf7 \strokec7 =\cf3 \strokec3  \cf6 \strokec6 await\cf3 \strokec3  db.stories.\cf7 \strokec7 count\cf3 \strokec3 (\{ userId \});
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 const\cf3 \strokec3  milestones \cf7 \strokec7 =\cf3 \strokec3  [\cf9 \strokec9 1\cf3 \strokec3 , \cf9 \strokec9 2\cf3 \strokec3 , \cf9 \strokec9 3\cf3 \strokec3 , \cf9 \strokec9 4\cf3 \strokec3 , \cf9 \strokec9 7\cf3 \strokec3 , \cf9 \strokec9 10\cf3 \strokec3 , \cf9 \strokec9 15\cf3 \strokec3 , \cf9 \strokec9 20\cf3 \strokec3 , \cf9 \strokec9 30\cf3 \strokec3 , \cf9 \strokec9 50\cf3 \strokec3 , \cf9 \strokec9 100\cf3 \strokec3 ];
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 if\cf3 \strokec3  (milestones.\cf7 \strokec7 includes\cf3 \strokec3 (storyCount)) \{
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0
\f4\i \cf5 \strokec5 // Queue background job for combined analysis
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\cf6 \strokec6 await\cf3 \strokec3  queue.\cf7 \strokec7 add\cf3 \strokec3 (\cf8 \strokec8 'analyze-milestone'\cf3 \strokec3 , \{
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0userId,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0storyCount,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0storyId\cf7 \strokec7 :\cf3 \strokec3  story.id,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0isFreeTier\cf7 \strokec7 :\cf3 \strokec3  freeStoriesUsed \cf7 \strokec7 <=\cf3 \strokec3  \cf9 \strokec9 3\cf3 \strokec3 ,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0analysisType\cf7 \strokec7 :\cf3 \strokec3  \cf8 \strokec8 'combined'\cf3 \strokec3  
\f4\i \cf5 \strokec5 // Prompts + Character insights
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\});
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\}
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 return\cf3 \strokec3  res.\cf7 \strokec7 json\cf3 \strokec3 (\{
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0success\cf7 \strokec7 :\cf3 \strokec3  \cf9 \strokec9 true\cf3 \strokec3 ,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0story,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0promptsGenerated\cf7 \strokec7 :\cf3 \strokec3  \{
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0tier1\cf7 \strokec7 :\cf3 \strokec3  tier1Prompt \cf7 \strokec7 ?\cf3 \strokec3  \cf9 \strokec9 1\cf3 \strokec3  \cf7 \strokec7 :\cf3 \strokec3  \cf9 \strokec9 0\cf3 \strokec3 ,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0tier3\cf7 \strokec7 :\cf3 \strokec3  milestones.\cf7 \strokec7 includes\cf3 \strokec3 (storyCount) \cf7 \strokec7 ?\cf3 \strokec3  \cf8 \strokec8 'queued'\cf3 \strokec3  \cf7 \strokec7 :\cf3 \strokec3  \cf9 \strokec9 0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\}
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\});
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa160\partightenfactor0

\f0\b \cf3 \strokec3 \}\

\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa293\partightenfactor0

\f0\b\fs28 \cf0 5.3 POST /api/prompts/skip
\f2\b0\fs24 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 Purpose:
\f3\b0  User clicked "Skip" on a prompt
\f2 \strokec2 \

\f0\b \strokec2 Request:
\f2\b0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf0 \strokec2 typescript
\f2 \strokec2 \

\f3 \cf13 \strokec13 POST\cf4 \strokec4  \cf12 \strokec12 /\cf4 \strokec4 api\cf12 \strokec12 /\cf4 \strokec4 prompts\cf12 \strokec12 /\cf4 \strokec4 skip
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 Authorization\cf12 \strokec12 :\cf4 \strokec4  Bearer \{jwt_token\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 Content\cf12 \strokec12 -\cf4 \strokec4 Type\cf12 \strokec12 :\cf4 \strokec4  application\cf12 \strokec12 /\cf4 \strokec4 json
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf16 \strokec16 "promptId"\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 "prompt-uuid"
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \}
\f2 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 \strokec2 Response:
\f2\b0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf0 \strokec2 typescript
\f2 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf16 \strokec16 "success"\cf12 \strokec12 :\cf4 \strokec4  \cf13 \strokec13 true\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf16 \strokec16 "nextPrompt"\cf12 \strokec12 :\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf16 \strokec16 "id"\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 "next-prompt-uuid"\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf16 \strokec16 "text"\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 "Tell me about your mother..."\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0
\f5\i \cf10 \strokec10 // ... full prompt object
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \}
\f2 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 \strokec2 Server-Side Logic:
\f2\b0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf0 \strokec2 typescript
\f2 \strokec2 \

\f3 \cf11 \strokec11 async\cf4 \strokec4  \cf11 \strokec11 function\cf4 \strokec4  \cf12 \strokec12 handlePromptSkip\cf4 \strokec4 (req, res) \{
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  userId \cf12 \strokec12 =\cf4 \strokec4  req.user.id;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  \{ promptId \} \cf12 \strokec12 =\cf4 \strokec4  req.body;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  prompt \cf12 \strokec12 =\cf4 \strokec4  \cf11 \strokec11 await\cf4 \strokec4  db.active_prompts.\cf12 \strokec12 findById\cf4 \strokec4 (promptId);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 if\cf4 \strokec4  (\cf12 \strokec12 !\cf4 \strokec4 prompt \cf12 \strokec12 ||\cf4 \strokec4  prompt.user_id \cf12 \strokec12 !==\cf4 \strokec4  userId) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 return\cf4 \strokec4  res.\cf12 \strokec12 status\cf4 \strokec4 (\cf13 \strokec13 404\cf4 \strokec4 ).\cf12 \strokec12 json\cf4 \strokec4 (\{ error\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 'Prompt not found'\cf4 \strokec4  \});
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // Increment shown count
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  newShownCount \cf12 \strokec12 =\cf4 \strokec4  prompt.shown_count \cf12 \strokec12 +\cf4 \strokec4  \cf13 \strokec13 1\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // Retire prompt if skipped 3+ times
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 if\cf4 \strokec4  (newShownCount \cf12 \strokec12 >=\cf4 \strokec4  \cf13 \strokec13 3\cf4 \strokec4 ) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0
\f5\i \cf10 \strokec10 // Archive to history
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 await\cf4 \strokec4  db.prompt_history.\cf12 \strokec12 create\cf4 \strokec4 (\{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0userId,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0promptText\cf12 \strokec12 :\cf4 \strokec4  prompt.prompt_text,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0anchorHash\cf12 \strokec12 :\cf4 \strokec4  prompt.anchor_hash,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0tier\cf12 \strokec12 :\cf4 \strokec4  prompt.tier,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0memoryType\cf12 \strokec12 :\cf4 \strokec4  prompt.memory_type,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0promptScore\cf12 \strokec12 :\cf4 \strokec4  prompt.prompt_score,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0shownCount\cf12 \strokec12 :\cf4 \strokec4  newShownCount,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0outcome\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 'skipped'\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0createdAt\cf12 \strokec12 :\cf4 \strokec4  prompt.created_at
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\});
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0
\f5\i \cf10 \strokec10 // Delete from active
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 await\cf4 \strokec4  db.active_prompts.\cf12 \strokec12 delete\cf4 \strokec4 (promptId);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\} \cf11 \strokec11 else\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0
\f5\i \cf10 \strokec10 // Just increment skip count
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 await\cf4 \strokec4  db.active_prompts.\cf12 \strokec12 update\cf4 \strokec4 (promptId, \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0shownCount\cf12 \strokec12 :\cf4 \strokec4  newShownCount,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0lastShownAt\cf12 \strokec12 :\cf4 \strokec4  \cf11 \strokec11 new\cf4 \strokec4  \cf13 \strokec13 Date\cf4 \strokec4 ()
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\});
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // Return next prompt
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  nextPrompt \cf12 \strokec12 =\cf4 \strokec4  \cf11 \strokec11 await\cf4 \strokec4  \cf12 \strokec12 getNextPrompt\cf4 \strokec4 (\{ user\cf12 \strokec12 :\cf4 \strokec4  \{ id\cf12 \strokec12 :\cf4 \strokec4  userId \} \}, res);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 return\cf4 \strokec4  res.\cf12 \strokec12 json\cf4 \strokec4 (\{ success\cf12 \strokec12 :\cf4 \strokec4  \cf13 \strokec13 true\cf4 \strokec4 , nextPrompt \});
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \}\

\f2 \cf0 \strokec2 \
\pard\pardeftab720\sa293\partightenfactor0

\f0\b\fs28 \cf0 \strokec2 5.4 POST /api/webhooks/stripe
\f2\b0\fs24 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 Purpose:
\f3\b0  Handle Stripe subscription webhook (payment success)
\f2 \strokec2 \

\f0\b \strokec2 Request:
\f2\b0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf0 \strokec2 typescript
\f2 \strokec2 \

\f3 \cf13 \strokec13 POST\cf4 \strokec4  \cf12 \strokec12 /\cf4 \strokec4 api\cf12 \strokec12 /\cf4 \strokec4 webhooks\cf12 \strokec12 /\cf4 \strokec4 stripe
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 Stripe\cf12 \strokec12 -\cf4 \strokec4 Signature\cf12 \strokec12 :\cf4 \strokec4  \{signature\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 Content\cf12 \strokec12 -\cf4 \strokec4 Type\cf12 \strokec12 :\cf4 \strokec4  application\cf12 \strokec12 /\cf4 \strokec4 json
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf16 \strokec16 "type"\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 "checkout.session.completed"\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf16 \strokec16 "data"\cf12 \strokec12 :\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf16 \strokec16 "object"\cf12 \strokec12 :\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf16 \strokec16 "customer"\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 "cus_xxx"\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf16 \strokec16 "client_reference_id"\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 "user-uuid"\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf16 \strokec16 "payment_status"\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 "paid"
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \}
\f2 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 \strokec2 Server-Side Logic:
\f2\b0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf0 \strokec2 typescript
\f2 \strokec2 \

\f3 \cf11 \strokec11 async\cf4 \strokec4  \cf11 \strokec11 function\cf4 \strokec4  \cf12 \strokec12 handleStripeWebhook\cf4 \strokec4 (req, res) \{
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  event \cf12 \strokec12 =\cf4 \strokec4  req.body;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 if\cf4 \strokec4  (event.type \cf12 \strokec12 ===\cf4 \strokec4  \cf14 \strokec14 'checkout.session.completed'\cf4 \strokec4 ) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  userId \cf12 \strokec12 =\cf4 \strokec4  event.data.object.client_reference_id;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0
\f5\i \cf10 \strokec10 // 1. Update subscription status
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 await\cf4 \strokec4  db.users.\cf12 \strokec12 update\cf4 \strokec4 (userId, \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0subscription_status\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 'active'\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0subscription_started_at\cf12 \strokec12 :\cf4 \strokec4  \cf11 \strokec11 new\cf4 \strokec4  \cf13 \strokec13 Date\cf4 \strokec4 ()
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\});
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0
\f5\i \cf10 \strokec10 // 2. Unlock premium seed prompts (from Story 3)
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 await\cf4 \strokec4  db.active_prompts.\cf12 \strokec12 updateMany\cf4 \strokec4 (
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0userId,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0isLocked\cf12 \strokec12 :\cf4 \strokec4  \cf13 \strokec13 true
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\},
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0isLocked\cf12 \strokec12 :\cf4 \strokec4  \cf13 \strokec13 false\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0expiresAt\cf12 \strokec12 :\cf4 \strokec4  \cf11 \strokec11 new\cf4 \strokec4  \cf13 \strokec13 Date\cf4 \strokec4 (\cf13 \strokec13 Date\cf4 \strokec4 .\cf12 \strokec12 now\cf4 \strokec4 () \cf12 \strokec12 +\cf4 \strokec4  \cf13 \strokec13 60\cf4 \strokec4  \cf12 \strokec12 *\cf4 \strokec4  \cf13 \strokec13 24\cf4 \strokec4  \cf12 \strokec12 *\cf4 \strokec4  \cf13 \strokec13 60\cf4 \strokec4  \cf12 \strokec12 *\cf4 \strokec4  \cf13 \strokec13 60\cf4 \strokec4  \cf12 \strokec12 *\cf4 \strokec4  \cf13 \strokec13 1000\cf4 \strokec4 ) 
\f5\i \cf10 \strokec10 // 60 days
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0
\f5\i \cf10 \strokec10 // 3. Send welcome email (optional)
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 await\cf4 \strokec4  \cf12 \strokec12 sendEmail\cf4 \strokec4 (\{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0to\cf12 \strokec12 :\cf4 \strokec4  user.email,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0subject\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 "Welcome to HeritageWhisper Premium!"\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0body\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 "Your personalized prompts are now unlocked..."
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\});
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 return\cf4 \strokec4  res.\cf12 \strokec12 json\cf4 \strokec4 (\{ received\cf12 \strokec12 :\cf4 \strokec4  \cf13 \strokec13 true\cf4 \strokec4  \});
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // Handle other events (subscription cancelled, etc.)
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // ...
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \}\

\f2 \cf0 \strokec2 \
\pard\pardeftab720\sa293\partightenfactor0

\f0\b\fs36 \cf0 \strokec2 6. AI PROMPT TEMPLATES
\f2\b0\fs24 \
\pard\pardeftab720\sa293\partightenfactor0

\f0\b\fs28 \cf0 6.1 Story 1 Analysis (Free Tier)
\f2\b0\fs24 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 Purpose:
\f3\b0  Expand a single story to find implied moments
\f2 \strokec2 \

\f0\b \strokec2 OpenAI Request:
\f2\b0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf0 \strokec2 typescript
\f2 \strokec2 \

\f3 \cf11 \strokec11 const\cf4 \strokec4  response \cf12 \strokec12 =\cf4 \strokec4  \cf11 \strokec11 await\cf4 \strokec4  openai.chat.completions.\cf12 \strokec12 create\cf4 \strokec4 (\{
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0model\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 'gpt-4o'\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0temperature\cf12 \strokec12 :\cf4 \strokec4  \cf13 \strokec13 0.7\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0response_format\cf12 \strokec12 :\cf4 \strokec4  \{ type\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 'json_object'\cf4 \strokec4  \},
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0messages\cf12 \strokec12 :\cf4 \strokec4  [
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0role\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 'system'\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0content\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 `You are analyzing the FIRST story someone shared. Your job is to find what was IMPLIED but not fully told in this ONE story.
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 Generate 5 candidate prompts that expand THIS story (not find gaps, there aren't any yet).
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 LOOK FOR:
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 1. THE MOMENT BEFORE
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0- They jumped into the middle. What led up to this?
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0- "I decided to leave" \uc0\u8594  What happened the day before you decided?
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 2. THE MOMENT AFTER
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0- They told the decision, not the aftermath
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0- "I quit medical school" \uc0\u8594  What happened the next morning?
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 3. OTHER PEOPLE IMPLIED
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0- "My father was disappointed" \uc0\u8594  What did your mother say?
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0- "Mrs. Henderson taught me" \uc0\u8594  Who else was in that classroom?
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 4. SENSORY GAPS
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0- They told WHAT happened, not what it felt/looked/smelled like
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0- "The workshop" \uc0\u8594  What did it smell like in there?
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 5. IMPLIED BACKSTORY
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0- They referenced something without explaining it
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0- "That old watch" \uc0\u8594  Where did that watch come from?
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 GENERATE 5 PROMPTS THAT:
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9989  Ask about something SPECIFIC from this story
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9989  Feel like you're genuinely curious (not generic)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9989  Make them think: "Oh wow, it actually read my story"
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9989  Trigger recording (not analysis)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 For EACH prompt, you must also generate:
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 - A recording_likelihood score (0-100)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 - A brief reasoning (1 sentence)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 The scoring criteria:
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 - Specificity: References exact people/places/objects from story
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 - Emotional resonance: Triggers feeling, not just facts
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 - Kindness: Curious, not confrontational
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 - Recording likelihood: Will they hit "Record" or "Skip"?
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 EXAMPLES OF GOOD PROMPTS:
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 Story: "I decided to leave medical school in 1982..."
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 GOOD: "What happened the morning you walked into the dean's office to quit?"
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 Score: 85
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 Reasoning: Asks about specific implied moment with sensory potential
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 BAD: "Tell me about another big decision"
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 Score: 30
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 Reasoning: Too generic, could apply to anyone
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 Story: "My father's workshop was where I learned discipline..."
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 GOOD: "Who else spent time in that workshop with you and your father?"
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 Score: 80
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 Reasoning: Expands on mentioned place, asks about implied people
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 BAD: "What did discipline mean to you?"
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 Score: 40
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 Reasoning: Too abstract for memory recall
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 Return JSON in this exact format:
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0"candidates": [
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0"prompt": "What happened the morning after you told your father?",
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0"trigger": "moment_after",
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0"anchor_entity": "father",
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0"anchor_year": 1955,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0"recording_likelihood": 87,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0"reasoning": "Asks about implied next-day moment with emotional weight"
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\},
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0// ... 4 more candidates
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0]
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \}
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf14 \strokec14 Sort candidates by recording_likelihood DESC.`
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\},
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0role\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 'user'\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0content\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 `Story Year: \cf4 \strokec4 $\{storyYear\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 Transcript:
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 $\{transcript\}
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf14 \strokec14 Generate 5 expansion prompts for this first story.`
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0]
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \});\

\f2 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 \strokec2 Expected Response:
\f2\b0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf0 \strokec2 json
\f2 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf16 \strokec16 "candidates"\cf12 \strokec12 :\cf4 \strokec4  [
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf16 \strokec16 "prompt"\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 "What happened the very next morning after you quit medical school?"\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf16 \strokec16 "trigger"\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 "moment_after"\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf16 \strokec16 "anchor_entity"\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 "medical school"\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf16 \strokec16 "anchor_year"\cf12 \strokec12 :\cf4 \strokec4  \cf13 \strokec13 1982\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf16 \strokec16 "recording_likelihood"\cf12 \strokec12 :\cf4 \strokec4  \cf13 \strokec13 88\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf16 \strokec16 "reasoning"\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 "Immediate aftermath creates strong narrative pull"
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\},
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf16 \strokec16 "prompt"\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 "What was on your father's face when you told him you were quitting?"\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf16 \strokec16 "trigger"\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 "implied_emotion"\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf16 \strokec16 "anchor_entity"\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 "father"\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf16 \strokec16 "anchor_year"\cf12 \strokec12 :\cf4 \strokec4  \cf13 \strokec13 1982\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf16 \strokec16 "recording_likelihood"\cf12 \strokec12 :\cf4 \strokec4  \cf13 \strokec13 85\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf16 \strokec16 "reasoning"\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 "Sensory detail about pivotal emotional moment"
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\},
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf16 \strokec16 "prompt"\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 "Who was the first person you called after making that decision?"\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf16 \strokec16 "trigger"\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 "implied_person"\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf16 \strokec16 "anchor_entity"\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 "decision to quit"\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf16 \strokec16 "anchor_year"\cf12 \strokec12 :\cf4 \strokec4  \cf13 \strokec13 1982\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf16 \strokec16 "recording_likelihood"\cf12 \strokec12 :\cf4 \strokec4  \cf13 \strokec13 78\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf16 \strokec16 "reasoning"\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 "Reveals support system and emotional processing"
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\},
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf16 \strokec16 "prompt"\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 "Where were you standing when you made the final decision to leave?"\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf16 \strokec16 "trigger"\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 "missing_sensory"\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf16 \strokec16 "anchor_entity"\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 "decision moment"\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf16 \strokec16 "anchor_year"\cf12 \strokec12 :\cf4 \strokec4  \cf13 \strokec13 1982\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf16 \strokec16 "recording_likelihood"\cf12 \strokec12 :\cf4 \strokec4  \cf13 \strokec13 72\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf16 \strokec16 "reasoning"\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 "Spatial memory anchors the turning point"
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\},
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf16 \strokec16 "prompt"\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 "What did you almost do instead of quitting?"\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf16 \strokec16 "trigger"\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 "moment_before"\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf16 \strokec16 "anchor_entity"\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 "decision"\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf16 \strokec16 "anchor_year"\cf12 \strokec12 :\cf4 \strokec4  \cf13 \strokec13 1982\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf16 \strokec16 "recording_likelihood"\cf12 \strokec12 :\cf4 \strokec4  \cf13 \strokec13 68\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf16 \strokec16 "reasoning"\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 "Reveals internal conflict and alternatives considered"
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0]
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \}\

\f2 \cf0 \strokec2 \
\pard\pardeftab720\sa293\partightenfactor0

\f0\b\fs28 \cf0 \strokec2 6.2 Story 2 Analysis (Free Tier)
\f2\b0\fs24 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 Purpose:
\f3\b0  Light connection between two stories or deeper expansion
\f2 \strokec2 \

\f0\b \strokec2 OpenAI Request:
\f2\b0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf0 \strokec2 typescript
\f2 \strokec2 \

\f3 \cf11 \strokec11 const\cf4 \strokec4  response \cf12 \strokec12 =\cf4 \strokec4  \cf11 \strokec11 await\cf4 \strokec4  openai.chat.completions.\cf12 \strokec12 create\cf4 \strokec4 (\{
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0model\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 'gpt-4o'\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0temperature\cf12 \strokec12 :\cf4 \strokec4  \cf13 \strokec13 0.7\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0response_format\cf12 \strokec12 :\cf4 \strokec4  \{ type\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 'json_object'\cf4 \strokec4  \},
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0messages\cf12 \strokec12 :\cf4 \strokec4  [
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0role\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 'system'\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0content\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 `You are analyzing the first 2 stories someone has shared.
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 Generate 4 candidate prompts that either:
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 A) Expand one of these stories (like Story 1 approach)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 B) Connect these two stories (if there's a meaningful connection)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 LOOK FOR CONNECTIONS:
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 - Same person mentioned in both stories
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 - Same emotion in both stories (pride, fear, etc)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 - Same location/setting in different times
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 - Opposite outcomes (success vs failure, joy vs grief)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 - Time gap worth exploring (what happened between?)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 CONNECTION PROMPTS (if connections exist):
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 - "You mentioned [person] in both stories. Tell me about the first time you met them."
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 - "You felt [emotion] in both moments. Tell me about another time you felt that way."
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 - "Story 1 was in [year], Story 2 in [year]. What happened between those years?"
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 EXPANSION PROMPTS (if no clear connection):
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 - Use Story 1 techniques on whichever story has more expansion potential
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 - Focus on sensory details, implied people, moment before/after
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 SCORING:
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 For each prompt:
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 - recording_likelihood (0-100)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 - reasoning (1 sentence)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 Criteria:
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 - Connection prompts score higher IF connection is meaningful
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 - Expansion prompts score based on specificity and emotional resonance
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 - Avoid forced connections (if stories are unrelated, expand instead)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 Return JSON:
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0"candidates": [
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0"prompt": "...",
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0"trigger": "person_connection" | "emotion_connection" | "expansion",
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0"anchor_entity": "...",
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0"anchor_year": null,\'a0 // or specific year
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0"recording_likelihood": 0-100,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0"reasoning": "..."
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\},
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0// ... 3 more
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0]
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \}
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf14 \strokec14 Sort by recording_likelihood DESC.`
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\},
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0role\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 'user'\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0content\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 `Story 1 (\cf4 \strokec4 $\{story1Year\}\cf14 \strokec14 ):
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 $\{story1Transcript\}
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf14 \strokec14 Story 2 (\cf4 \strokec4 $\{story2Year\}\cf14 \strokec14 ):
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 $\{story2Transcript\}
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf14 \strokec14 Generate 4 prompts that either connect these stories or expand on them.`
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0]
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \});\

\f2 \cf0 \strokec2 \
\pard\pardeftab720\sa293\partightenfactor0

\f0\b\fs28 \cf0 \strokec2 6.3 Story 3 Analysis (Free Tier) - THE KILLER PROMPT
\f2\b0\fs24 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 Purpose:
\f3\b0  Generate THE BEST prompt to convince user to pay
\f2 \strokec2 \

\f0\b \strokec2 OpenAI Request:
\f2\b0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf0 \strokec2 typescript
\f2 \strokec2 \

\f3 \cf11 \strokec11 const\cf4 \strokec4  response \cf12 \strokec12 =\cf4 \strokec4  \cf11 \strokec11 await\cf4 \strokec4  openai.chat.completions.\cf12 \strokec12 create\cf4 \strokec4 (\{
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0model\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 'gpt-4o'\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0temperature\cf12 \strokec12 :\cf4 \strokec4  \cf13 \strokec13 0.8\cf4 \strokec4 , 
\f5\i \cf10 \strokec10 // Slightly higher for creativity
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0response_format\cf12 \strokec12 :\cf4 \strokec4  \{ type\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 'json_object'\cf4 \strokec4  \},
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0messages\cf12 \strokec12 :\cf4 \strokec4  [
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0role\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 'system'\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0content\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 `You are analyzing 3 stories to generate the MOST COMPELLING prompt possible.
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 This is a free user deciding whether to pay $149/year. This prompt must be EXCEPTIONAL.
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 Generate 5 candidate prompts. We will show ONLY the best one.
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 PRIORITY ORDER:
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 1. STRONG PATTERN (if exists)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0- Same person in 2+ stories \uc0\u8594  Ask about that relationship
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0- Same emotion in 2+ stories \uc0\u8594  Ask about that feeling's origin
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0- Recurring theme/value \uc0\u8594  Surface it directly
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0Example: "Your father appears in all 3 stories but you've never told me about him directly. Tell me about your father."
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 2. COMPELLING GAP (if exists)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0- 30+ year gap between stories \uc0\u8594  Ask what happened in between
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0- All positive \uc0\u8594  Ask about challenge/failure
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0- All about work \uc0\u8594  Ask about family/love
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0Example: "You've shared stories from 1955, 1960, and 1995. What happened in the 1970s and 80s?"
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 3. DEEP EXPANSION (fallback)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0- Pick the most emotionally resonant story
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0- Ask about implied moment that carries weight
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0Example: "That workshop you keep mentioning - tell me about the last time you were there with your father."
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 THE GOAL:
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 Make them think: "Holy shit, this thing GETS me. I need to pay for this."
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 SCORING:
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 Each prompt gets:
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 - recording_likelihood (0-100)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 - conversion_likelihood (0-100) \uc0\u8592  NEW: Will this make them pay?
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 - reasoning (1-2 sentences)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 Criteria for conversion_likelihood:
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 - Shows AI "read between the lines" (not obvious)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 - Personal (couldn't ask this of anyone else)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 - Emotionally resonant (touches something deep)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 - Creates curiosity ("I want to know what else it found")
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 AVOID:
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 - Generic questions that could apply to anyone
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 - "Why" questions (too analytical)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 - Abstract themes without specific anchors
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 - Anything that feels like therapy instead of curiosity
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 Return JSON:
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0"candidates": [
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0"prompt": "...",
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0"trigger": "strong_pattern" | "compelling_gap" | "deep_expansion",
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0"anchor_entity": "...",
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0"anchor_year": null,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0"recording_likelihood": 0-100,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0"conversion_likelihood": 0-100,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0"reasoning": "..."
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\},
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0// ... 4 more
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0]
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \}
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf14 \strokec14 Sort by: conversion_likelihood DESC, then recording_likelihood DESC.`
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\},
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0role\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 'user'\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0content\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 `Story 1 (\cf4 \strokec4 $\{story1Year\}\cf14 \strokec14 ):
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 $\{story1Transcript\}
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf14 \strokec14 Story 2 (\cf4 \strokec4 $\{story2Year\}\cf14 \strokec14 ):
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 $\{story2Transcript\}
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf14 \strokec14 Story 3 (\cf4 \strokec4 $\{story3Year\}\cf14 \strokec14 ):
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 $\{story3Transcript\}
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf14 \strokec14 Generate 5 prompts. We need THE BEST one to show before the paywall.`
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0]
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \});\

\f2 \cf0 \strokec2 \
\pard\pardeftab720\sa293\partightenfactor0

\f0\b\fs28 \cf0 \strokec2 6.4 Tier 2 On-Demand (Paid Users)
\f2\b0\fs24 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 Purpose:
\f3\b0  Generate prompts when inventory is empty
\f2 \strokec2 \

\f0\b \strokec2 OpenAI Request:
\f2\b0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf0 \strokec2 typescript
\f2 \strokec2 \

\f3 \cf11 \strokec11 const\cf4 \strokec4  response \cf12 \strokec12 =\cf4 \strokec4  \cf11 \strokec11 await\cf4 \strokec4  openai.chat.completions.\cf12 \strokec12 create\cf4 \strokec4 (\{
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0model\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 'gpt-4o'\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0temperature\cf12 \strokec12 :\cf4 \strokec4  \cf13 \strokec13 0.7\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0response_format\cf12 \strokec12 :\cf4 \strokec4  \{ type\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 'json_object'\cf4 \strokec4  \},
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0messages\cf12 \strokec12 :\cf4 \strokec4  [
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0role\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 'system'\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0content\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 `You are a memory activation specialist helping seniors remember forgotten life stories.
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 Your job: Generate 5 prompts that trigger SPECIFIC memories they haven't recorded yet.
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 You have access to their last 3-5 stories. Find what's IMPLIED but not told.
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 LOOK FOR:
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 1. PEOPLE MENTIONED IN PASSING
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0- Name appears but no dedicated story
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0- "My brother said..." \uc0\u8594  Ask about brother's full story
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0- "Mrs. Henderson taught me..." \uc0\u8594  Ask about first day in her class
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 2. OBJECTS WITH BACKSTORIES
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0- "That old watch" \uc0\u8594  Where did it come from?
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0- "The family car" \uc0\u8594  First time driving it?
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0- Any possession mentioned without origin story
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 3. PLACES THAT HOLD MEMORIES
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0- "The workshop" \uc0\u8594  What did it smell like?
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0- "Our apartment" \uc0\u8594  Describe the kitchen
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0- Locations referenced but not fully described
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 4. MOMENTS IMPLIED BUT NOT TOLD
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0- "After we got married..." \uc0\u8594  What about the wedding day?
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0- "When I left medical school..." \uc0\u8594  What about the decision moment?
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0- Any before/after gap
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 5. SENSORY OR EMOTIONAL SPIKES
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0- "I was terrified" \uc0\u8594  What did fear feel like in your body?
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0- "The smell of sawdust..." \uc0\u8594  What else triggers that memory?
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0- Strong emotions or senses mentioned without full context
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 6. TIME GAPS
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0- Stories from 1955 and 1995 \uc0\u8594  What about the decades in between?
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0- All stories from one era \uc0\u8594  Ask about different decade
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 GENERATE 5 PROMPTS THAT:
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9989  Use specific details from THEIR stories (names, places, years)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9989  Ask about concrete moments, not abstract themes
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9989  Trigger sensory memory (sight, sound, smell, touch, taste)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9989  Feel like a curious grandchild, not a therapist
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \uc0\u9989  High probability of "Oh! I should record that!"
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 SCORING:
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 - recording_likelihood (0-100)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 - specificity_score (0-100) \uc0\u8592  How specific vs generic
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 - reasoning (1 sentence)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 EXAMPLES OF GOOD PROMPTS:
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 - "You mentioned your father's workshop in two stories. What tool did he use most?" (Score: 85)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 - "Mrs. Henderson - what did her classroom smell like?" (Score: 82)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 - "That rejection letter from medical school - where were you when you opened it?" (Score: 88)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 EXAMPLES OF BAD PROMPTS:
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 - "Tell me about your relationship with your father" (Too broad)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 - "What did family mean to you?" (Too abstract)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 - "Why did you become a teacher?" (Too analytical)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 Return JSON:
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0"candidates": [
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0"prompt": "...",
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0"trigger": "implied_person" | "object_backstory" | "missing_sensory" | etc,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0"anchor_entity": "...",
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0"anchor_year": null,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0"recording_likelihood": 0-100,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0"specificity_score": 0-100,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0"reasoning": "..."
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\},
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0// ... 4 more
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0]
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \}
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf14 \strokec14 Sort by recording_likelihood DESC.`
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\},
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0role\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 'user'\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0content\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 `Recent stories:
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 $\{recentStories.\cf12 \strokec12 map\cf4 \strokec4 ((s, i) \cf12 \strokec12 =>\cf4 \strokec4  \cf14 \strokec14 `Story \cf4 \strokec4 $\{i\cf12 \strokec12 +\cf13 \strokec13 1\cf4 \strokec4 \}\cf14 \strokec14  (\cf4 \strokec4 $\{s.year\}\cf14 \strokec14 ):
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 $\{s.transcript.\cf12 \strokec12 slice\cf4 \strokec4 (\cf13 \strokec13 0\cf4 \strokec4 , \cf13 \strokec13 800\cf4 \strokec4 )\}\cf14 \strokec14 ...`\cf4 \strokec4 ).\cf12 \strokec12 join\cf4 \strokec4 (\cf14 \strokec14 '\\n\\n'\cf4 \strokec4 )\}
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf14 \strokec14 Generate 5 prompts based on these stories.`
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0]
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \});
\f2 \cf0 \strokec2 \
\
\pard\pardeftab720\sa106\partightenfactor0

\f0\b\fs34\fsmilli17333 \cf0 \strokec2 6.6 Combined Milestone Analysis (Prompts + Character + Lesson Enhancement)
\f1\fs28 \
\pard\pardeftab720\sa320\partightenfactor0

\f0\fs24 \cf0 Purpose: Single API call for all analysis at milestones New section - maximizes efficiency
\f2\b0 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 typescript
\f2\b0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf6 \strokec6 const\cf3 \strokec3  response \cf7 \strokec7 =\cf3 \strokec3  \cf6 \strokec6 await\cf3 \strokec3  openai.chat.completions.\cf7 \strokec7 create\cf3 \strokec3 (\{
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf3 \strokec3 \'a0\'a0model\cf7 \strokec7 :\cf3 \strokec3  \cf8 \strokec8 'gpt-4o'\cf3 \strokec3 ,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0temperature\cf7 \strokec7 :\cf3 \strokec3  \cf9 \strokec9 0.7\cf3 \strokec3 ,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0response_format\cf7 \strokec7 :\cf3 \strokec3  \{ type\cf7 \strokec7 :\cf3 \strokec3  \cf8 \strokec8 'json_object'\cf3 \strokec3  \},
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0messages\cf7 \strokec7 :\cf3 \strokec3  [
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\{
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0role\cf7 \strokec7 :\cf3 \strokec3  \cf8 \strokec8 'system'\cf3 \strokec3 ,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0content\cf7 \strokec7 :\cf3 \strokec3  \cf8 \strokec8 `You are analyzing \cf3 \strokec3 $\{storyCount\}\cf8 \strokec8  stories to perform three tasks:
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a01. Generate memory prompts for future recordings
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a02. Extract character insights and patterns
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a03. Identify core lessons and wisdom
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0
\cf0 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf8 \strokec8 \'a0\'a0\'a0\'a0\'a0\'a0This person has shared \cf3 \strokec3 $\{storyCount\}\cf8 \strokec8  stories with you. Analyze them comprehensively.`
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\},
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\{
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0role\cf7 \strokec7 :\cf3 \strokec3  \cf8 \strokec8 'user'\cf3 \strokec3 ,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0content\cf7 \strokec7 :\cf3 \strokec3  \cf8 \strokec8 `
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 PART A: PROMPT GENERATION
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf8 \strokec8 Generate \cf3 \strokec3 $\{promptCount\}\cf8 \strokec8  prompts that will trigger new memories.
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf3 \strokec3 [Use logic from sections 6.1-6.5 based on story count]
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0
\cf0 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf3 \strokec3 PART B: CHARACTER ANALYSIS
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf8 \strokec8 From ALL \cf3 \strokec3 $\{storyCount\}\cf8 \strokec8  stories, extract:
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0
\cf0 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf3 \strokec3 1. CHARACTER TRAITS (3-5 core traits)
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0- Each trait needs evidence from specific stories
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0- Confidence score (0-1) based on repetition
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0- Direct quotes that demonstrate the trait
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0
\cf0 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf3 \strokec3 2. INVISIBLE RULES (2-3 principles they live by)
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0- Patterns in their decision-making
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0- Unspoken values that guide them
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0- Rules they follow but may not articulate
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0
\cf0 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf3 \strokec3 3. CONTRADICTIONS (if any exist)
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0- Values they state vs behaviors they show
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0- Tensions in their character
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0- Unresolved conflicts in their worldview
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0
\cf0 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf3 \strokec3 4. CORE LESSONS (distilled wisdom)
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0- What would they tell their younger self?
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0- What did life teach them?
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0- What wisdom emerges from their stories?
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0
\cf0 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf3 \strokec3 Stories to analyze:
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 $\{stories.\cf7 \strokec7 map\cf3 \strokec3 ((s, i) \cf7 \strokec7 =>\cf3 \strokec3  \cf8 \strokec8 `
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf8 \strokec8 Story \cf3 \strokec3 $\{i\cf7 \strokec7 +\cf9 \strokec9 1\cf3 \strokec3 \}\cf8 \strokec8  (Year \cf3 \strokec3 $\{s.year\}\cf8 \strokec8 ):
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf3 \strokec3 $\{s.transcript\}
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf8 \strokec8 Lesson they wrote: \cf3 \strokec3 $\{s.lessonLearned\}
\f2\b0 \cf0 \strokec2 \

\f0\b \cf8 \strokec8 `\cf3 \strokec3 ).\cf7 \strokec7 join\cf3 \strokec3 (\cf8 \strokec8 '\\n---\\n'\cf3 \strokec3 )\}
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0
\cf0 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf8 \strokec8 Return comprehensive JSON with all findings.`
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\}
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0],
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0messages\cf7 \strokec7 :\cf3 \strokec3  [
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\{
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0role\cf7 \strokec7 :\cf3 \strokec3  \cf8 \strokec8 'assistant'\cf3 \strokec3 ,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0content\cf7 \strokec7 :\cf3 \strokec3  \cf8 \strokec8 `\{
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0"prompts": [
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\{
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0"prompt": "You mentioned your father's workshop in 3 stories. Tell me about the last time you were there.",
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0"trigger": "recurring_location",
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0"anchor_entity": "father's workshop",
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0"recording_likelihood": 88,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0"reasoning": "Strong emotional anchor appearing multiple times"
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\},
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0// ... more prompts based on story count
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0],
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0"characterInsights": \{
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0"traits": [
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\{
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0"trait": "resilience",
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0"confidence": 0.85,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0"evidence": [
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0"Story 1: 'I just kept going, what else could I do?'",
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0"Story 3: 'Giving up was never an option'",
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0"Story 7: 'You fall down seven times, get up eight'"
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0]
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\},
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\{
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0"trait": "duty-before-desire",
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0"confidence": 0.72,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0"evidence": [
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0"Story 2: Chose family business over art school",
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0"Story 5: Worked weekends to support family"
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0]
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\}
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0],
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0"invisibleRules": [
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0"Never let them see you sweat",
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0"Family comes first, even when it costs you",
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0"If you're not 15 minutes early, you're late"
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0],
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0"contradictions": [
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\{
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0"stated": "Money doesn't matter",
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0"lived": "Worked 80-hour weeks for 30 years",
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0"tension": "Financial security was actually paramount"
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\}
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0],
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0"coreLessons": [
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0"The things you sacrifice for family are never really lost",
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0"Sometimes the hardest thing and the right thing are the same",
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0"You can't go back, but you can always start over"
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0]
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\}
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf8 \strokec8 \}`
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\}
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0]
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \});
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0
\cf0 \
\pard\pardeftab720\sa240\partightenfactor0

\f4\i\b \cf5 \strokec5 // Process the combined response
\f2\i0\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf6 \strokec6 async\cf3 \strokec3  \cf6 \strokec6 function\cf3 \strokec3  \cf7 \strokec7 processMilestoneAnalysis\cf3 \strokec3 (response) \{
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 const\cf3 \strokec3  data \cf7 \strokec7 =\cf3 \strokec3  \cf9 \strokec9 JSON\cf3 \strokec3 .\cf7 \strokec7 parse\cf3 \strokec3 (response.choices[\cf9 \strokec9 0\cf3 \strokec3 ].message.content);
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f4\i \cf5 \strokec5 // Store prompts
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 for\cf3 \strokec3  (\cf6 \strokec6 const\cf3 \strokec3  prompt \cf6 \strokec6 of\cf3 \strokec3  data.prompts) \{
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\cf6 \strokec6 await\cf3 \strokec3  \cf7 \strokec7 storePrompt\cf3 \strokec3 (userId, prompt, \cf9 \strokec9 3\cf3 \strokec3 , isLocked);
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\}
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f4\i \cf5 \strokec5 // Store character insights
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 await\cf3 \strokec3  db.character_evolution.\cf7 \strokec7 create\cf3 \strokec3 (\{
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0userId,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0storyCount,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0traits\cf7 \strokec7 :\cf3 \strokec3  data.characterInsights.traits,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0invisibleRules\cf7 \strokec7 :\cf3 \strokec3  data.characterInsights.invisibleRules,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0contradictions\cf7 \strokec7 :\cf3 \strokec3  data.characterInsights.contradictions,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0analyzedAt\cf7 \strokec7 :\cf3 \strokec3  \cf6 \strokec6 new\cf3 \strokec3  \cf9 \strokec9 Date\cf3 \strokec3 (),
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0modelVersion\cf7 \strokec7 :\cf3 \strokec3  \cf8 \strokec8 'gpt-4o'
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\});
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f4\i \cf5 \strokec5 // Update story with enhanced insights
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 await\cf3 \strokec3  db.stories.\cf7 \strokec7 update\cf3 \strokec3 (storyId, \{
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0characterInsights\cf7 \strokec7 :\cf3 \strokec3  data.characterInsights
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\});
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 return\cf3 \strokec3  data;
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa160\partightenfactor0

\f0\b \cf3 \strokec3 \}\

\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa106\partightenfactor0

\f0\b\fs45\fsmilli22667 \cf0 7. BUSINESS LOGIC & ALGORITHMS
\f1\fs36 \
\pard\pardeftab720\sa293\partightenfactor0

\f0\fs28 \cf0 7.1 Tier 1 Template Generation
\f2\b0\fs24 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 Function:
\f3\b0  Extract entities and match templates
\f2 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf0 \strokec2 typescript
\f2 \strokec2 \

\f5\i \cf10 \strokec10 // ============================================================================
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 // ENTITY EXTRACTION
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 // ============================================================================
\f2\i0 \cf0 \strokec2 \

\f3 \cf11 \strokec11 interface\cf4 \strokec4  \cf13 \strokec13 ExtractedEntities\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0people\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 string\cf4 \strokec4 [];
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0places\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 string\cf4 \strokec4 [];
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0objects\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 string\cf4 \strokec4 [];
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0emotions\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 string\cf4 \strokec4 [];
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0temporalBoundaries\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 string\cf4 \strokec4 [];
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \}
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf11 \strokec11 function\cf4 \strokec4  \cf12 \strokec12 extractEntities\cf4 \strokec4 (transcript\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 string\cf4 \strokec4 )\cf12 \strokec12 :\cf4 \strokec4  ExtractedEntities \{
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // Normalize text (case-insensitive matching)
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  normalized \cf12 \strokec12 =\cf4 \strokec4  transcript.\cf12 \strokec12 toLowerCase\cf4 \strokec4 ();
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // Extract people (proper nouns followed by action verbs)
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  peoplePatterns \cf12 \strokec12 =\cf4 \strokec4  [
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf14 \strokec14 /\\b([A-Z][a-z]+(?:\\s+[A-Z][a-z]+)?)\\s+(said|told|taught|showed|gave|asked|wanted|helped|loved)/gi\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf14 \strokec14 /my\\s+(?:friend|teacher|father|mother|brother|sister|boss|mentor)\\s+([A-Z][a-z]+)/gi
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0];
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  people \cf12 \strokec12 =\cf4 \strokec4  \cf11 \strokec11 new\cf4 \strokec4  \cf13 \strokec13 Set\cf12 \strokec12 <\cf14 \strokec14 string\cf12 \strokec12 >\cf4 \strokec4 ();
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0peoplePatterns.\cf12 \strokec12 forEach\cf4 \strokec4 (pattern \cf12 \strokec12 =>\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  matches \cf12 \strokec12 =\cf4 \strokec4  transcript.\cf12 \strokec12 matchAll\cf4 \strokec4 (pattern);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 for\cf4 \strokec4  (\cf11 \strokec11 const\cf4 \strokec4  match \cf11 \strokec11 of\cf4 \strokec4  matches) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0people.\cf12 \strokec12 add\cf4 \strokec4 (match[\cf13 \strokec13 1\cf4 \strokec4 ]);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\});
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // Extract places (prepositions + capitalized locations)
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  placePatterns \cf12 \strokec12 =\cf4 \strokec4  [
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf14 \strokec14 /\\b(?:at|in|near|by|to)\\s+([A-Z][a-z]+(?:\\s+[A-Z][a-z]+)?)/g\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf14 \strokec14 /\\b(?:the)\\s+(workshop|office|house|apartment|school|church|hospital|factory)/gi
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0];
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  places \cf12 \strokec12 =\cf4 \strokec4  \cf11 \strokec11 new\cf4 \strokec4  \cf13 \strokec13 Set\cf12 \strokec12 <\cf14 \strokec14 string\cf12 \strokec12 >\cf4 \strokec4 ();
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0placePatterns.\cf12 \strokec12 forEach\cf4 \strokec4 (pattern \cf12 \strokec12 =>\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  matches \cf12 \strokec12 =\cf4 \strokec4  transcript.\cf12 \strokec12 matchAll\cf4 \strokec4 (pattern);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 for\cf4 \strokec4  (\cf11 \strokec11 const\cf4 \strokec4  match \cf11 \strokec11 of\cf4 \strokec4  matches) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0places.\cf12 \strokec12 add\cf4 \strokec4 (match[\cf13 \strokec13 1\cf4 \strokec4 ]);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\});
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // Extract objects (possessives + concrete nouns)
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  objectPatterns \cf12 \strokec12 =\cf4 \strokec4  [
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf14 \strokec14 /\\b(?:my|his|her|our|their|the)\\s+([\\w\\s]+?)\\s+(?:that|which|was|had|sat|hung)/gi
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0];
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  objects \cf12 \strokec12 =\cf4 \strokec4  \cf11 \strokec11 new\cf4 \strokec4  \cf13 \strokec13 Set\cf12 \strokec12 <\cf14 \strokec14 string\cf12 \strokec12 >\cf4 \strokec4 ();
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0objectPatterns.\cf12 \strokec12 forEach\cf4 \strokec4 (pattern \cf12 \strokec12 =>\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  matches \cf12 \strokec12 =\cf4 \strokec4  normalized.\cf12 \strokec12 matchAll\cf4 \strokec4 (pattern);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 for\cf4 \strokec4  (\cf11 \strokec11 const\cf4 \strokec4  match \cf11 \strokec11 of\cf4 \strokec4  matches) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  obj \cf12 \strokec12 =\cf4 \strokec4  match[\cf13 \strokec13 1\cf4 \strokec4 ].\cf12 \strokec12 trim\cf4 \strokec4 ();
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0
\f5\i \cf10 \strokec10 // Filter out common words
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf11 \strokec11 if\cf4 \strokec4  (obj.length \cf12 \strokec12 >\cf4 \strokec4  \cf13 \strokec13 3\cf4 \strokec4  \cf12 \strokec12 &&\cf4 \strokec4  \cf12 \strokec12 !\cf4 \strokec4 [\cf14 \strokec14 'that'\cf4 \strokec4 , \cf14 \strokec14 'this'\cf4 \strokec4 , \cf14 \strokec14 'there'\cf4 \strokec4 , \cf14 \strokec14 'thing'\cf4 \strokec4 ].\cf12 \strokec12 includes\cf4 \strokec4 (obj)) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0objects.\cf12 \strokec12 add\cf4 \strokec4 (obj);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\});
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // Extract emotions
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  emotionWords \cf12 \strokec12 =\cf4 \strokec4  [
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf14 \strokec14 'proud'\cf4 \strokec4 , \cf14 \strokec14 'scared'\cf4 \strokec4 , \cf14 \strokec14 'angry'\cf4 \strokec4 , \cf14 \strokec14 'happy'\cf4 \strokec4 , \cf14 \strokec14 'sad'\cf4 \strokec4 , \cf14 \strokec14 'disappointed'\cf4 \strokec4 ,\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf14 \strokec14 'excited'\cf4 \strokec4 , \cf14 \strokec14 'nervous'\cf4 \strokec4 , \cf14 \strokec14 'ashamed'\cf4 \strokec4 , \cf14 \strokec14 'relieved'\cf4 \strokec4 , \cf14 \strokec14 'terrified'\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf14 \strokec14 'joyful'\cf4 \strokec4 , \cf14 \strokec14 'anxious'\cf4 \strokec4 , \cf14 \strokec14 'grateful'\cf4 \strokec4 , \cf14 \strokec14 'regretful'
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0];
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  emotions \cf12 \strokec12 =\cf4 \strokec4  emotionWords.\cf12 \strokec12 filter\cf4 \strokec4 (emotion \cf12 \strokec12 =>\cf4 \strokec4 \'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0normalized.\cf12 \strokec12 includes\cf4 \strokec4 (emotion)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // Extract temporal boundaries
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  temporalPatterns \cf12 \strokec12 =\cf4 \strokec4  [
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf14 \strokec14 /(first|last|only)\\s+time/gi
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0];
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  temporalBoundaries\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 string\cf4 \strokec4 [] \cf12 \strokec12 =\cf4 \strokec4  [];
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0temporalPatterns.\cf12 \strokec12 forEach\cf4 \strokec4 (pattern \cf12 \strokec12 =>\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  matches \cf12 \strokec12 =\cf4 \strokec4  transcript.\cf12 \strokec12 matchAll\cf4 \strokec4 (pattern);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 for\cf4 \strokec4  (\cf11 \strokec11 const\cf4 \strokec4  match \cf11 \strokec11 of\cf4 \strokec4  matches) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0temporalBoundaries.\cf12 \strokec12 push\cf4 \strokec4 (match[\cf13 \strokec13 0\cf4 \strokec4 ]);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\});
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 return\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0people\cf12 \strokec12 :\cf4 \strokec4  \cf13 \strokec13 Array\cf4 \strokec4 .\cf11 \strokec11 from\cf4 \strokec4 (people),
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0places\cf12 \strokec12 :\cf4 \strokec4  \cf13 \strokec13 Array\cf4 \strokec4 .\cf11 \strokec11 from\cf4 \strokec4 (places),
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0objects\cf12 \strokec12 :\cf4 \strokec4  \cf13 \strokec13 Array\cf4 \strokec4 .\cf11 \strokec11 from\cf4 \strokec4 (objects),
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0emotions,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0temporalBoundaries
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\};
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \}\

\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f5\i \cf10 \strokec10 // ============================================================================
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 // TEMPLATE LIBRARY
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 // ============================================================================
\f2\i0 \cf0 \strokec2 \

\f3 \cf11 \strokec11 interface\cf4 \strokec4  \cf13 \strokec13 PromptTemplate\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0trigger\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 string\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0patterns\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 string\cf4 \strokec4 [];
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0context\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 string\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0priority\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 number\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \}
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf11 \strokec11 const\cf4 \strokec4  \cf13 \strokec13 TEMPLATE_LIBRARY\cf12 \strokec12 :\cf4 \strokec4  Record\cf12 \strokec12 <\cf14 \strokec14 string\cf4 \strokec4 , PromptTemplate\cf12 \strokec12 >\cf4 \strokec4  \cf12 \strokec12 =\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0person_expansion\cf12 \strokec12 :\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0trigger\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 'person_mentioned'\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0patterns\cf12 \strokec12 :\cf4 \strokec4  [
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf14 \strokec14 "Tell me about the first time you met \{person\}."\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf14 \strokec14 "What's the clearest memory you have of \{person\}?"\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf14 \strokec14 "\{person\} sounds important. What did they teach you?"\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf14 \strokec14 "What did \{person\} look like? Describe them."\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf14 \strokec14 "What's something \{person\} said that you've never forgotten?"
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0],
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0context\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 "You mentioned \{person\} in your recent story"\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0priority\cf12 \strokec12 :\cf4 \strokec4  \cf13 \strokec13 90
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\},
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0object_origin\cf12 \strokec12 :\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0trigger\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 'object_mentioned'\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0patterns\cf12 \strokec12 :\cf4 \strokec4  [
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf14 \strokec14 "Where did your \{object\} come from?"\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf14 \strokec14 "Tell me the story of how you got \{object\}."\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf14 \strokec14 "Do you still have \{object\}? What happened to it?"\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf14 \strokec14 "Who gave you \{object\}?"\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf14 \strokec14 "What's the first memory you have with \{object\}?"
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0],
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0context\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 "You mentioned \{object\}"\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0priority\cf12 \strokec12 :\cf4 \strokec4  \cf13 \strokec13 85
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\},
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0place_memory\cf12 \strokec12 :\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0trigger\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 'place_mentioned'\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0patterns\cf12 \strokec12 :\cf4 \strokec4  [
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf14 \strokec14 "What's your first memory of \{place\}?"\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf14 \strokec14 "Describe \{place\}. If I walked in, what would I see?"\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf14 \strokec14 "What did \{place\} smell like?"\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf14 \strokec14 "Who else was usually at \{place\}?"\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf14 \strokec14 "Tell me about the last time you were at \{place\}."
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0],
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0context\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 "You mentioned \{place\}"\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0priority\cf12 \strokec12 :\cf4 \strokec4  \cf13 \strokec13 88
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\},
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0emotion_expansion\cf12 \strokec12 :\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0trigger\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 'emotion_detected'\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0patterns\cf12 \strokec12 :\cf4 \strokec4  [
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf14 \strokec14 "Tell me about another time you felt \{emotion\} like that."\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf14 \strokec14 "What's the most \{emotion\} you've ever been?"\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf14 \strokec14 "Who else was there when you felt \{emotion\}?"\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf14 \strokec14 "Where in your body did you feel that \{emotion\}?"
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0],
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0context\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 "You felt \{emotion\}"\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0priority\cf12 \strokec12 :\cf4 \strokec4  \cf13 \strokec13 75
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\},
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0temporal_sequence\cf12 \strokec12 :\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0trigger\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 'temporal_boundary'\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0patterns\cf12 \strokec12 :\cf4 \strokec4  [
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf14 \strokec14 "What happened right after that \{temporal\} time?"\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf14 \strokec14 "Tell me about the \{opposite_temporal\} time."\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf14 \strokec14 "What led up to that \{temporal\} time?"
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0],
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0context\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 "You mentioned a \{temporal\} time"\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0priority\cf12 \strokec12 :\cf4 \strokec4  \cf13 \strokec13 70
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \};\

\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f5\i \cf10 \strokec10 // ============================================================================
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 // TEMPLATE MATCHING
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 // ============================================================================
\f2\i0 \cf0 \strokec2 \

\f3 \cf11 \strokec11 interface\cf4 \strokec4  \cf13 \strokec13 Tier1Prompt\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0text\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 string\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0context\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 string\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0entity\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 string\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0type\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 string\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0anchorHash\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 string\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \}
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf11 \strokec11 function\cf4 \strokec4  \cf12 \strokec12 generateTier1Template\cf4 \strokec4 (
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0transcript\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 string\cf4 \strokec4 ,\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0storyYear\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 number
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 )\cf12 \strokec12 :\cf4 \strokec4  Tier1Prompt \cf12 \strokec12 |\cf4 \strokec4  \cf11 \strokec11 null\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  entities \cf12 \strokec12 =\cf4 \strokec4  \cf12 \strokec12 extractEntities\cf4 \strokec4 (transcript);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // Priority order (most likely to trigger recording)
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 if\cf4 \strokec4  (entities.people.length \cf12 \strokec12 >\cf4 \strokec4  \cf13 \strokec13 0\cf4 \strokec4 ) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  person \cf12 \strokec12 =\cf4 \strokec4  entities.people[\cf13 \strokec13 0\cf4 \strokec4 ];
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  template \cf12 \strokec12 =\cf4 \strokec4  \cf13 \strokec13 TEMPLATE_LIBRARY\cf4 \strokec4 .person_expansion;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  pattern \cf12 \strokec12 =\cf4 \strokec4  template.patterns[\cf13 \strokec13 Math\cf4 \strokec4 .\cf12 \strokec12 floor\cf4 \strokec4 (\cf13 \strokec13 Math\cf4 \strokec4 .\cf12 \strokec12 random\cf4 \strokec4 () \cf12 \strokec12 *\cf4 \strokec4  template.patterns.length)];
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 return\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0text\cf12 \strokec12 :\cf4 \strokec4  pattern.\cf12 \strokec12 replace\cf4 \strokec4 (\cf14 \strokec14 '\{person\}'\cf4 \strokec4 , person),
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0context\cf12 \strokec12 :\cf4 \strokec4  template.context.\cf12 \strokec12 replace\cf4 \strokec4 (\cf14 \strokec14 '\{person\}'\cf4 \strokec4 , person),
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0entity\cf12 \strokec12 :\cf4 \strokec4  person,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0type\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 'person_expansion'\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0anchorHash\cf12 \strokec12 :\cf4 \strokec4  \cf12 \strokec12 generateAnchorHash\cf4 \strokec4 (\cf14 \strokec14 'person_expansion'\cf4 \strokec4 , person, storyYear)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\};
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 if\cf4 \strokec4  (entities.objects.length \cf12 \strokec12 >\cf4 \strokec4  \cf13 \strokec13 0\cf4 \strokec4 ) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  object \cf12 \strokec12 =\cf4 \strokec4  entities.objects[\cf13 \strokec13 0\cf4 \strokec4 ];
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  template \cf12 \strokec12 =\cf4 \strokec4  \cf13 \strokec13 TEMPLATE_LIBRARY\cf4 \strokec4 .object_origin;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  pattern \cf12 \strokec12 =\cf4 \strokec4  template.patterns[\cf13 \strokec13 Math\cf4 \strokec4 .\cf12 \strokec12 floor\cf4 \strokec4 (\cf13 \strokec13 Math\cf4 \strokec4 .\cf12 \strokec12 random\cf4 \strokec4 () \cf12 \strokec12 *\cf4 \strokec4  template.patterns.length)];
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 return\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0text\cf12 \strokec12 :\cf4 \strokec4  pattern.\cf12 \strokec12 replace\cf4 \strokec4 (\cf14 \strokec14 '\{object\}'\cf4 \strokec4 , object),
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0context\cf12 \strokec12 :\cf4 \strokec4  template.context.\cf12 \strokec12 replace\cf4 \strokec4 (\cf14 \strokec14 '\{object\}'\cf4 \strokec4 , object),
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0entity\cf12 \strokec12 :\cf4 \strokec4  object,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0type\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 'object_origin'\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0anchorHash\cf12 \strokec12 :\cf4 \strokec4  \cf12 \strokec12 generateAnchorHash\cf4 \strokec4 (\cf14 \strokec14 'object_origin'\cf4 \strokec4 , object, storyYear)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\};
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 if\cf4 \strokec4  (entities.places.length \cf12 \strokec12 >\cf4 \strokec4  \cf13 \strokec13 0\cf4 \strokec4 ) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  place \cf12 \strokec12 =\cf4 \strokec4  entities.places[\cf13 \strokec13 0\cf4 \strokec4 ];
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  template \cf12 \strokec12 =\cf4 \strokec4  \cf13 \strokec13 TEMPLATE_LIBRARY\cf4 \strokec4 .place_memory;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  pattern \cf12 \strokec12 =\cf4 \strokec4  template.patterns[\cf13 \strokec13 Math\cf4 \strokec4 .\cf12 \strokec12 floor\cf4 \strokec4 (\cf13 \strokec13 Math\cf4 \strokec4 .\cf12 \strokec12 random\cf4 \strokec4 () \cf12 \strokec12 *\cf4 \strokec4  template.patterns.length)];
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 return\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0text\cf12 \strokec12 :\cf4 \strokec4  pattern.\cf12 \strokec12 replace\cf4 \strokec4 (\cf14 \strokec14 '\{place\}'\cf4 \strokec4 , place),
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0context\cf12 \strokec12 :\cf4 \strokec4  template.context.\cf12 \strokec12 replace\cf4 \strokec4 (\cf14 \strokec14 '\{place\}'\cf4 \strokec4 , place),
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0entity\cf12 \strokec12 :\cf4 \strokec4  place,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0type\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 'place_memory'\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0anchorHash\cf12 \strokec12 :\cf4 \strokec4  \cf12 \strokec12 generateAnchorHash\cf4 \strokec4 (\cf14 \strokec14 'place_memory'\cf4 \strokec4 , place, storyYear)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\};
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 if\cf4 \strokec4  (entities.emotions.length \cf12 \strokec12 >\cf4 \strokec4  \cf13 \strokec13 0\cf4 \strokec4 ) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  emotion \cf12 \strokec12 =\cf4 \strokec4  entities.emotions[\cf13 \strokec13 0\cf4 \strokec4 ];
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  template \cf12 \strokec12 =\cf4 \strokec4  \cf13 \strokec13 TEMPLATE_LIBRARY\cf4 \strokec4 .emotion_expansion;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  pattern \cf12 \strokec12 =\cf4 \strokec4  template.patterns[\cf13 \strokec13 Math\cf4 \strokec4 .\cf12 \strokec12 floor\cf4 \strokec4 (\cf13 \strokec13 Math\cf4 \strokec4 .\cf12 \strokec12 random\cf4 \strokec4 () \cf12 \strokec12 *\cf4 \strokec4  template.patterns.length)];
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 return\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0text\cf12 \strokec12 :\cf4 \strokec4  pattern.\cf12 \strokec12 replace\cf4 \strokec4 (\cf14 \strokec14 '\{emotion\}'\cf4 \strokec4 , emotion),
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0context\cf12 \strokec12 :\cf4 \strokec4  template.context.\cf12 \strokec12 replace\cf4 \strokec4 (\cf14 \strokec14 '\{emotion\}'\cf4 \strokec4 , emotion),
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0entity\cf12 \strokec12 :\cf4 \strokec4  emotion,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0type\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 'emotion_expansion'\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0anchorHash\cf12 \strokec12 :\cf4 \strokec4  \cf12 \strokec12 generateAnchorHash\cf4 \strokec4 (\cf14 \strokec14 'emotion_expansion'\cf4 \strokec4 , emotion, storyYear)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\};
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // Fallback: decade-based generic
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  decade \cf12 \strokec12 =\cf4 \strokec4  \cf13 \strokec13 Math\cf4 \strokec4 .\cf12 \strokec12 floor\cf4 \strokec4 (storyYear \cf12 \strokec12 /\cf4 \strokec4  \cf13 \strokec13 10\cf4 \strokec4 ) \cf12 \strokec12 *\cf4 \strokec4  \cf13 \strokec13 10\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 return\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0text\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 `What was a typical Saturday like in the \cf4 \strokec4 $\{decade\}\cf14 \strokec14 s?`\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0context\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 `Based on your \cf4 \strokec4 $\{storyYear\}\cf14 \strokec14  story`\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0entity\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 `\cf4 \strokec4 $\{decade\}\cf14 \strokec14 s`\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0type\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 'decade_context'\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0anchorHash\cf12 \strokec12 :\cf4 \strokec4  \cf12 \strokec12 generateAnchorHash\cf4 \strokec4 (\cf14 \strokec14 'decade_context'\cf4 \strokec4 , \cf14 \strokec14 `\cf4 \strokec4 $\{decade\}\cf14 \strokec14 s`\cf4 \strokec4 , decade)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\};
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \}\

\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f5\i \cf10 \strokec10 // ============================================================================
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 // ANCHOR HASH GENERATION
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 // ============================================================================
\f2\i0 \cf0 \strokec2 \

\f3 \cf11 \strokec11 function\cf4 \strokec4  \cf12 \strokec12 generateAnchorHash\cf4 \strokec4 (
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0type\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 string\cf4 \strokec4 ,\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0entity\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 string\cf4 \strokec4 ,\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0year\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 number\cf4 \strokec4  \cf12 \strokec12 |\cf4 \strokec4  \cf11 \strokec11 null
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 )\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 string\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  crypto \cf12 \strokec12 =\cf4 \strokec4  \cf11 \strokec11 require\cf4 \strokec4 (\cf14 \strokec14 'crypto'\cf4 \strokec4 );
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  normalized \cf12 \strokec12 =\cf4 \strokec4  entity.\cf12 \strokec12 toLowerCase\cf4 \strokec4 ().\cf12 \strokec12 trim\cf4 \strokec4 ();
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  yearStr \cf12 \strokec12 =\cf4 \strokec4  year \cf12 \strokec12 ?\cf4 \strokec4  year.\cf12 \strokec12 toString\cf4 \strokec4 () \cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 'NA'\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  input \cf12 \strokec12 =\cf4 \strokec4  \cf14 \strokec14 `\cf4 \strokec4 $\{\cf11 \strokec11 type\cf4 \strokec4 \}\cf14 \strokec14 |\cf4 \strokec4 $\{normalized\}\cf14 \strokec14 |\cf4 \strokec4 $\{yearStr\}\cf14 \strokec14 `\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 return\cf4 \strokec4  crypto.\cf12 \strokec12 createHash\cf4 \strokec4 (\cf14 \strokec14 'sha1'\cf4 \strokec4 ).\cf12 \strokec12 update\cf4 \strokec4 (input).\cf12 \strokec12 digest\cf4 \strokec4 (\cf14 \strokec14 'hex'\cf4 \strokec4 );
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \}\

\f2 \cf0 \strokec2 \
\pard\pardeftab720\sa293\partightenfactor0

\f0\b\fs28 \cf0 \strokec2 7.2 Generate-and-Filter Algorithm
\f2\b0\fs24 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 Function:
\f3\b0  Generate multiple candidates, score, filter, store best
\f2 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf0 \strokec2 typescript
\f2 \strokec2 \

\f5\i \cf10 \strokec10 // ============================================================================
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 // SCORE FILTERING
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 // ============================================================================
\f2\i0 \cf0 \strokec2 \

\f3 \cf11 \strokec11 interface\cf4 \strokec4  \cf13 \strokec13 ScoredPrompt\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0prompt\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 string\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0trigger\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 string\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0anchorEntity\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 string\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0anchorYear\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 number\cf4 \strokec4  \cf12 \strokec12 |\cf4 \strokec4  \cf11 \strokec11 null\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0recordingLikelihood\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 number\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0reasoning\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 string\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \}
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf11 \strokec11 async\cf4 \strokec4  \cf11 \strokec11 function\cf4 \strokec4  \cf12 \strokec12 generateAndFilterPrompts\cf4 \strokec4 (
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0userId\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 string\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0tier\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 number\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0context\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 any
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 )\cf12 \strokec12 :\cf4 \strokec4  \cf13 \strokec13 Promise\cf12 \strokec12 <\cf11 \strokec11 void\cf12 \strokec12 >\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // 1. Generate candidates based on tier
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 let\cf4 \strokec4  candidates\cf12 \strokec12 :\cf4 \strokec4  ScoredPrompt[];
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 if\cf4 \strokec4  (tier \cf12 \strokec12 ===\cf4 \strokec4  \cf13 \strokec13 1\cf4 \strokec4 ) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0
\f5\i \cf10 \strokec10 // Template generation (handled separately)
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 return\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\} \cf11 \strokec11 else\cf4 \strokec4  \cf11 \strokec11 if\cf4 \strokec4  (tier \cf12 \strokec12 ===\cf4 \strokec4  \cf13 \strokec13 2\cf4 \strokec4 ) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0
\f5\i \cf10 \strokec10 // On-demand generation
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0candidates \cf12 \strokec12 =\cf4 \strokec4  \cf11 \strokec11 await\cf4 \strokec4  \cf12 \strokec12 generateTier2Candidates\cf4 \strokec4 (userId);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\} \cf11 \strokec11 else\cf4 \strokec4  \cf11 \strokec11 if\cf4 \strokec4  (tier \cf12 \strokec12 ===\cf4 \strokec4  \cf13 \strokec13 3\cf4 \strokec4 ) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0
\f5\i \cf10 \strokec10 // Milestone generation
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0candidates \cf12 \strokec12 =\cf4 \strokec4  \cf11 \strokec11 await\cf4 \strokec4  \cf12 \strokec12 generateTier3Candidates\cf4 \strokec4 (userId, context.storyCount);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // 2. Filter by minimum score threshold
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  \cf13 \strokec13 MIN_SCORE\cf4 \strokec4  \cf12 \strokec12 =\cf4 \strokec4  \cf13 \strokec13 50\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  filtered \cf12 \strokec12 =\cf4 \strokec4  candidates.\cf12 \strokec12 filter\cf4 \strokec4 (c \cf12 \strokec12 =>\cf4 \strokec4  c.recordingLikelihood \cf12 \strokec12 >=\cf4 \strokec4  \cf13 \strokec13 MIN_SCORE\cf4 \strokec4 );
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 if\cf4 \strokec4  (filtered.length \cf12 \strokec12 ===\cf4 \strokec4  \cf13 \strokec13 0\cf4 \strokec4 ) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0
\f5\i \cf10 \strokec10 // All candidates scored too low - retry with different approach
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf13 \strokec13 console\cf4 \strokec4 .\cf12 \strokec12 warn\cf4 \strokec4 (\cf14 \strokec14 `All candidates scored below \cf4 \strokec4 $\{\cf13 \strokec13 MIN_SCORE\cf4 \strokec4 \}\cf14 \strokec14  for user \cf4 \strokec4 $\{userId\}\cf14 \strokec14 `\cf4 \strokec4 );
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 if\cf4 \strokec4  (tier \cf12 \strokec12 ===\cf4 \strokec4  \cf13 \strokec13 3\cf4 \strokec4  \cf12 \strokec12 &&\cf4 \strokec4  context.isFreeTier) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0
\f5\i \cf10 \strokec10 // Free tier failure is critical - retry once with sensory focus
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0candidates \cf12 \strokec12 =\cf4 \strokec4  \cf11 \strokec11 await\cf4 \strokec4  \cf12 \strokec12 generateTier3Candidates\cf4 \strokec4 (userId, context.storyCount, \cf14 \strokec14 'sensory_only'\cf4 \strokec4 );
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  retryFiltered \cf12 \strokec12 =\cf4 \strokec4  candidates.\cf12 \strokec12 filter\cf4 \strokec4 (c \cf12 \strokec12 =>\cf4 \strokec4  c.recordingLikelihood \cf12 \strokec12 >=\cf4 \strokec4  \cf13 \strokec13 MIN_SCORE\cf4 \strokec4 );
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf11 \strokec11 if\cf4 \strokec4  (retryFiltered.length \cf12 \strokec12 ===\cf4 \strokec4  \cf13 \strokec13 0\cf4 \strokec4 ) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0
\f5\i \cf10 \strokec10 // Still failed - use decade fallback
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  fallback \cf12 \strokec12 =\cf4 \strokec4  \cf11 \strokec11 await\cf4 \strokec4  \cf12 \strokec12 generateDecadeFallback\cf4 \strokec4 (userId);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\cf11 \strokec11 await\cf4 \strokec4  \cf12 \strokec12 storePrompt\cf4 \strokec4 (userId, fallback, tier);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\cf11 \strokec11 return\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0filtered.\cf12 \strokec12 push\cf4 \strokec4 (\cf12 \strokec12 ...\cf4 \strokec4 retryFiltered);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\} \cf11 \strokec11 else\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0
\f5\i \cf10 \strokec10 // Paid tier failure - just use decade fallback
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  fallback \cf12 \strokec12 =\cf4 \strokec4  \cf11 \strokec11 await\cf4 \strokec4  \cf12 \strokec12 generateDecadeFallback\cf4 \strokec4 (userId);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf11 \strokec11 await\cf4 \strokec4  \cf12 \strokec12 storePrompt\cf4 \strokec4 (userId, fallback, tier);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf11 \strokec11 return\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // 3. Sort by score descending
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0filtered.\cf12 \strokec12 sort\cf4 \strokec4 ((a, b) \cf12 \strokec12 =>\cf4 \strokec4  b.recordingLikelihood \cf12 \strokec12 -\cf4 \strokec4  a.recordingLikelihood);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // 4. Determine how many to store
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 let\cf4 \strokec4  countToStore \cf12 \strokec12 =\cf4 \strokec4  \cf13 \strokec13 1\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 if\cf4 \strokec4  (tier \cf12 \strokec12 ===\cf4 \strokec4  \cf13 \strokec13 3\cf4 \strokec4 ) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 if\cf4 \strokec4  (context.storyCount \cf12 \strokec12 ===\cf4 \strokec4  \cf13 \strokec13 3\cf4 \strokec4 ) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0
\f5\i \cf10 \strokec10 // Story 3 special case: store top 4 (1 shown, 3 locked)
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0countToStore \cf12 \strokec12 =\cf4 \strokec4  \cf13 \strokec13 4\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\} \cf11 \strokec11 else\cf4 \strokec4  \cf11 \strokec11 if\cf4 \strokec4  (context.storyCount \cf12 \strokec12 <=\cf4 \strokec4  \cf13 \strokec13 20\cf4 \strokec4 ) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0countToStore \cf12 \strokec12 =\cf4 \strokec4  \cf13 \strokec13 3\cf4 \strokec4 ; 
\f5\i \cf10 \strokec10 // Early milestones
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\} \cf11 \strokec11 else\cf4 \strokec4  \cf11 \strokec11 if\cf4 \strokec4  (context.storyCount \cf12 \strokec12 <=\cf4 \strokec4  \cf13 \strokec13 50\cf4 \strokec4 ) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0countToStore \cf12 \strokec12 =\cf4 \strokec4  \cf13 \strokec13 2\cf4 \strokec4 ; 
\f5\i \cf10 \strokec10 // Mid milestones
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\} \cf11 \strokec11 else\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0countToStore \cf12 \strokec12 =\cf4 \strokec4  \cf13 \strokec13 1\cf4 \strokec4 ; 
\f5\i \cf10 \strokec10 // Late milestones
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\} \cf11 \strokec11 else\cf4 \strokec4  \cf11 \strokec11 if\cf4 \strokec4  (tier \cf12 \strokec12 ===\cf4 \strokec4  \cf13 \strokec13 2\cf4 \strokec4 ) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0countToStore \cf12 \strokec12 =\cf4 \strokec4  \cf13 \strokec13 2\cf4 \strokec4 ; 
\f5\i \cf10 \strokec10 // On-demand generates 2
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  toStore \cf12 \strokec12 =\cf4 \strokec4  filtered.\cf12 \strokec12 slice\cf4 \strokec4 (\cf13 \strokec13 0\cf4 \strokec4 , countToStore);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // 5. Store prompts
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 for\cf4 \strokec4  (\cf11 \strokec11 let\cf4 \strokec4  i \cf12 \strokec12 =\cf4 \strokec4  \cf13 \strokec13 0\cf4 \strokec4 ; i \cf12 \strokec12 <\cf4 \strokec4  toStore.length; i\cf12 \strokec12 ++\cf4 \strokec4 ) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  candidate \cf12 \strokec12 =\cf4 \strokec4  toStore[i];
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  isLocked \cf12 \strokec12 =\cf4 \strokec4  (tier \cf12 \strokec12 ===\cf4 \strokec4  \cf13 \strokec13 3\cf4 \strokec4  \cf12 \strokec12 &&\cf4 \strokec4  context.storyCount \cf12 \strokec12 ===\cf4 \strokec4  \cf13 \strokec13 3\cf4 \strokec4  \cf12 \strokec12 &&\cf4 \strokec4  i \cf12 \strokec12 >\cf4 \strokec4  \cf13 \strokec13 0\cf4 \strokec4 ); 
\f5\i \cf10 \strokec10 // Lock premium seed
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 await\cf4 \strokec4  \cf12 \strokec12 storePrompt\cf4 \strokec4 (userId, candidate, tier, isLocked);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \}\

\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f5\i \cf10 \strokec10 // ============================================================================
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 // STORE PROMPT
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 // ============================================================================
\f2\i0 \cf0 \strokec2 \

\f3 \cf11 \strokec11 async\cf4 \strokec4  \cf11 \strokec11 function\cf4 \strokec4  \cf12 \strokec12 storePrompt\cf4 \strokec4 (
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0userId\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 string\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0prompt\cf12 \strokec12 :\cf4 \strokec4  ScoredPrompt,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0tier\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 number\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0isLocked\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 boolean\cf4 \strokec4  \cf12 \strokec12 =\cf4 \strokec4  \cf13 \strokec13 false
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 )\cf12 \strokec12 :\cf4 \strokec4  \cf13 \strokec13 Promise\cf12 \strokec12 <\cf11 \strokec11 void\cf12 \strokec12 >\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  anchorHash \cf12 \strokec12 =\cf4 \strokec4  \cf12 \strokec12 generateAnchorHash\cf4 \strokec4 (
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0prompt.trigger,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0prompt.anchorEntity,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0prompt.anchorYear
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // Determine expiry based on tier
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 let\cf4 \strokec4  expiryDays\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 number\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 if\cf4 \strokec4  (isLocked) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0expiryDays \cf12 \strokec12 =\cf4 \strokec4  \cf13 \strokec13 0\cf4 \strokec4 ; 
\f5\i \cf10 \strokec10 // NULL (set on unlock)
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\} \cf11 \strokec11 else\cf4 \strokec4  \cf11 \strokec11 if\cf4 \strokec4  (tier \cf12 \strokec12 ===\cf4 \strokec4  \cf13 \strokec13 1\cf4 \strokec4 ) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0expiryDays \cf12 \strokec12 =\cf4 \strokec4  \cf13 \strokec13 7\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\} \cf11 \strokec11 else\cf4 \strokec4  \cf11 \strokec11 if\cf4 \strokec4  (tier \cf12 \strokec12 ===\cf4 \strokec4  \cf13 \strokec13 2\cf4 \strokec4 ) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0expiryDays \cf12 \strokec12 =\cf4 \strokec4  \cf13 \strokec13 14\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\} \cf11 \strokec11 else\cf4 \strokec4  \cf11 \strokec11 if\cf4 \strokec4  (tier \cf12 \strokec12 ===\cf4 \strokec4  \cf13 \strokec13 3\cf4 \strokec4 ) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0expiryDays \cf12 \strokec12 =\cf4 \strokec4  \cf13 \strokec13 30\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\} \cf11 \strokec11 else\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0expiryDays \cf12 \strokec12 =\cf4 \strokec4  \cf13 \strokec13 7\cf4 \strokec4 ; 
\f5\i \cf10 \strokec10 // Fallback
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  expiresAt \cf12 \strokec12 =\cf4 \strokec4  isLocked\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf12 \strokec12 ?\cf4 \strokec4  \cf11 \strokec11 null\cf4 \strokec4 \'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf12 \strokec12 :\cf4 \strokec4  \cf11 \strokec11 new\cf4 \strokec4  \cf13 \strokec13 Date\cf4 \strokec4 (\cf13 \strokec13 Date\cf4 \strokec4 .\cf12 \strokec12 now\cf4 \strokec4 () \cf12 \strokec12 +\cf4 \strokec4  expiryDays \cf12 \strokec12 *\cf4 \strokec4  \cf13 \strokec13 24\cf4 \strokec4  \cf12 \strokec12 *\cf4 \strokec4  \cf13 \strokec13 60\cf4 \strokec4  \cf12 \strokec12 *\cf4 \strokec4  \cf13 \strokec13 60\cf4 \strokec4  \cf12 \strokec12 *\cf4 \strokec4  \cf13 \strokec13 1000\cf4 \strokec4 );
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // Check if prompt already exists (deduplication)
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  existing \cf12 \strokec12 =\cf4 \strokec4  \cf11 \strokec11 await\cf4 \strokec4  db.active_prompts.\cf12 \strokec12 findOne\cf4 \strokec4 (\{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0where\cf12 \strokec12 :\cf4 \strokec4  \{ userId, anchorHash \}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\});
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 if\cf4 \strokec4  (existing) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf13 \strokec13 console\cf4 \strokec4 .\cf12 \strokec12 log\cf4 \strokec4 (\cf14 \strokec14 `Duplicate prompt detected for user \cf4 \strokec4 $\{userId\}\cf14 \strokec14 , skipping:`\cf4 \strokec4 , prompt.prompt);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 return\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // Insert
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 await\cf4 \strokec4  db.active_prompts.\cf12 \strokec12 create\cf4 \strokec4 (\{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0userId,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0promptText\cf12 \strokec12 :\cf4 \strokec4  prompt.prompt,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0contextNote\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 `Based on your \cf4 \strokec4 $\{prompt.anchorYear \cf12 \strokec12 ||\cf4 \strokec4  \cf14 \strokec14 'stories'\cf4 \strokec4 \}\cf14 \strokec14 `\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0anchorEntity\cf12 \strokec12 :\cf4 \strokec4  prompt.anchorEntity,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0anchorYear\cf12 \strokec12 :\cf4 \strokec4  prompt.anchorYear,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0anchorHash,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0tier,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0memoryType\cf12 \strokec12 :\cf4 \strokec4  prompt.trigger,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0promptScore\cf12 \strokec12 :\cf4 \strokec4  prompt.recordingLikelihood,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0scoreReason\cf12 \strokec12 :\cf4 \strokec4  prompt.reasoning,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0modelVersion\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 'gpt-4o'\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0expiresAt,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0isLocked
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\});
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \}\

\f2 \cf0 \strokec2 \
\pard\pardeftab720\sa293\partightenfactor0

\f0\b\fs28 \cf0 \strokec2 7.3 Decade Fallback Generator
\f2\b0\fs24 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 Function:
\f3\b0  Generate safe fallback when AI fails or inventory is empty
\f2 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf0 \strokec2 typescript
\f2 \strokec2 \

\f3 \cf11 \strokec11 async\cf4 \strokec4  \cf11 \strokec11 function\cf4 \strokec4  \cf12 \strokec12 generateDecadeFallback\cf4 \strokec4 (userId\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 string\cf4 \strokec4 )\cf12 \strokec12 :\cf4 \strokec4  \cf13 \strokec13 Promise\cf12 \strokec12 <\cf4 \strokec4 ScoredPrompt\cf12 \strokec12 >\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  user \cf12 \strokec12 =\cf4 \strokec4  \cf11 \strokec11 await\cf4 \strokec4  db.users.\cf12 \strokec12 findById\cf4 \strokec4 (userId);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  stories \cf12 \strokec12 =\cf4 \strokec4  \cf11 \strokec11 await\cf4 \strokec4  db.stories.\cf12 \strokec12 find\cf4 \strokec4 (\{ userId \});
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // Find decades the user has lived through but hasn't recorded from
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  currentYear \cf12 \strokec12 =\cf4 \strokec4  \cf11 \strokec11 new\cf4 \strokec4  \cf13 \strokec13 Date\cf4 \strokec4 ().\cf12 \strokec12 getFullYear\cf4 \strokec4 ();
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  birthYear \cf12 \strokec12 =\cf4 \strokec4  user.birthYear;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  age \cf12 \strokec12 =\cf4 \strokec4  currentYear \cf12 \strokec12 -\cf4 \strokec4  birthYear;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // All decades they've lived through
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  livedDecades\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 number\cf4 \strokec4 [] \cf12 \strokec12 =\cf4 \strokec4  [];
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 for\cf4 \strokec4  (\cf11 \strokec11 let\cf4 \strokec4  year \cf12 \strokec12 =\cf4 \strokec4  birthYear; year \cf12 \strokec12 <=\cf4 \strokec4  currentYear; year \cf12 \strokec12 +=\cf4 \strokec4  \cf13 \strokec13 10\cf4 \strokec4 ) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  decade \cf12 \strokec12 =\cf4 \strokec4  \cf13 \strokec13 Math\cf4 \strokec4 .\cf12 \strokec12 floor\cf4 \strokec4 (year \cf12 \strokec12 /\cf4 \strokec4  \cf13 \strokec13 10\cf4 \strokec4 ) \cf12 \strokec12 *\cf4 \strokec4  \cf13 \strokec13 10\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 if\cf4 \strokec4  (\cf12 \strokec12 !\cf4 \strokec4 livedDecades.\cf12 \strokec12 includes\cf4 \strokec4 (decade)) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0livedDecades.\cf12 \strokec12 push\cf4 \strokec4 (decade);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // Decades with existing stories
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  recordedDecades \cf12 \strokec12 =\cf4 \strokec4  \cf11 \strokec11 new\cf4 \strokec4  \cf13 \strokec13 Set\cf4 \strokec4 (
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0stories.\cf12 \strokec12 map\cf4 \strokec4 (s \cf12 \strokec12 =>\cf4 \strokec4  \cf13 \strokec13 Math\cf4 \strokec4 .\cf12 \strokec12 floor\cf4 \strokec4 (s.storyYear \cf12 \strokec12 /\cf4 \strokec4  \cf13 \strokec13 10\cf4 \strokec4 ) \cf12 \strokec12 *\cf4 \strokec4  \cf13 \strokec13 10\cf4 \strokec4 )
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // Unrecorded decades
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  unrecordedDecades \cf12 \strokec12 =\cf4 \strokec4  livedDecades.\cf12 \strokec12 filter\cf4 \strokec4 (d \cf12 \strokec12 =>\cf4 \strokec4  \cf12 \strokec12 !\cf4 \strokec4 recordedDecades.\cf12 \strokec12 has\cf4 \strokec4 (d));
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // Pick random unrecorded decade
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 let\cf4 \strokec4  decade\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 number\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 if\cf4 \strokec4  (unrecordedDecades.length \cf12 \strokec12 >\cf4 \strokec4  \cf13 \strokec13 0\cf4 \strokec4 ) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0decade \cf12 \strokec12 =\cf4 \strokec4  unrecordedDecades[\cf13 \strokec13 Math\cf4 \strokec4 .\cf12 \strokec12 floor\cf4 \strokec4 (\cf13 \strokec13 Math\cf4 \strokec4 .\cf12 \strokec12 random\cf4 \strokec4 () \cf12 \strokec12 *\cf4 \strokec4  unrecordedDecades.length)];
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\} \cf11 \strokec11 else\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0
\f5\i \cf10 \strokec10 // All decades covered - pick random decade they lived through
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0decade \cf12 \strokec12 =\cf4 \strokec4  livedDecades[\cf13 \strokec13 Math\cf4 \strokec4 .\cf12 \strokec12 floor\cf4 \strokec4 (\cf13 \strokec13 Math\cf4 \strokec4 .\cf12 \strokec12 random\cf4 \strokec4 () \cf12 \strokec12 *\cf4 \strokec4  livedDecades.length)];
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // Generate decade-based prompt
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  prompts \cf12 \strokec12 =\cf4 \strokec4  [
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf14 \strokec14 `Tell me about a typical Saturday in the \cf4 \strokec4 $\{decade\}\cf14 \strokec14 s.`\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf14 \strokec14 `What was your favorite thing about the \cf4 \strokec4 $\{decade\}\cf14 \strokec14 s?`\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf14 \strokec14 `What do you remember most about \cf4 \strokec4 $\{decade\}\cf14 \strokec14 ?`\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf14 \strokec14 `Tell me a story from the \cf4 \strokec4 $\{decade\}\cf14 \strokec14 s that makes you smile.`\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf14 \strokec14 `What was happening in your life in \cf4 \strokec4 $\{decade\}\cf14 \strokec14 ?`
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0];
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  promptText \cf12 \strokec12 =\cf4 \strokec4  prompts[\cf13 \strokec13 Math\cf4 \strokec4 .\cf12 \strokec12 floor\cf4 \strokec4 (\cf13 \strokec13 Math\cf4 \strokec4 .\cf12 \strokec12 random\cf4 \strokec4 () \cf12 \strokec12 *\cf4 \strokec4  prompts.length)];
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 return\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0prompt\cf12 \strokec12 :\cf4 \strokec4  promptText,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0trigger\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 'decade_fallback'\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0anchorEntity\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 `\cf4 \strokec4 $\{decade\}\cf14 \strokec14 s`\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0anchorYear\cf12 \strokec12 :\cf4 \strokec4  decade,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0recordingLikelihood\cf12 \strokec12 :\cf4 \strokec4  \cf13 \strokec13 60\cf4 \strokec4 , 
\f5\i \cf10 \strokec10 // Lower score for generic prompts
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0reasoning\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 'Decade-based fallback prompt'
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\};
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \}
\f2 \cf0 \strokec2 \
\
\pard\pardeftab720\sa106\partightenfactor0

\f0\b\fs34\fsmilli17333 \cf0 \strokec2 7.4 Lesson Extraction Logic
\f1\fs28 \
\pard\pardeftab720\sa320\partightenfactor0

\f0\fs24 \cf0 New section - handles immediate lesson generation
\f2\b0 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 typescript
\f2\b0 \strokec2 \

\f4\i\b \cf5 \strokec5 // ============================================================================
\f2\i0\b0 \cf0 \strokec2 \

\f4\i\b \cf5 \strokec5 // LESSON EXTRACTION FOR REVIEW SCREEN
\f2\i0\b0 \cf0 \strokec2 \

\f4\i\b \cf5 \strokec5 // ============================================================================
\f2\i0\b0 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0
\cf0 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf6 \strokec6 interface\cf3 \strokec3  \cf9 \strokec9 LessonOptions\cf3 \strokec3  \{
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf3 \strokec3 \'a0\'a0practical\cf7 \strokec7 :\cf3 \strokec3  \cf8 \strokec8 string\cf3 \strokec3 ;\'a0 \'a0 
\f4\i \cf5 \strokec5 // What to DO
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0emotional\cf7 \strokec7 :\cf3 \strokec3  \cf8 \strokec8 string\cf3 \strokec3 ;\'a0 \'a0 
\f4\i \cf5 \strokec5 // What to FEEL
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0character\cf7 \strokec7 :\cf3 \strokec3  \cf8 \strokec8 string\cf3 \strokec3 ;\'a0 \'a0 
\f4\i \cf5 \strokec5 // Who to BE
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0selected\cf7 \strokec7 ?:\cf3 \strokec3  \cf8 \strokec8 string\cf3 \strokec3 ;\'a0 \'a0 
\f4\i \cf5 \strokec5 // Which one user chose
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \}
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0
\cf0 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf6 \strokec6 async\cf3 \strokec3  \cf6 \strokec6 function\cf3 \strokec3  \cf7 \strokec7 extractLessons\cf3 \strokec3 (transcript\cf7 \strokec7 :\cf3 \strokec3  \cf8 \strokec8 string\cf3 \strokec3 )\cf7 \strokec7 :\cf3 \strokec3  \cf9 \strokec9 Promise\cf7 \strokec7 <\cf3 \strokec3 LessonOptions\cf7 \strokec7 >\cf3 \strokec3  \{
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf3 \strokec3 \'a0\'a0
\f4\i \cf5 \strokec5 // Called during transcription processing (parallel with formatting)
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 const\cf3 \strokec3  completion \cf7 \strokec7 =\cf3 \strokec3  \cf6 \strokec6 await\cf3 \strokec3  openai.chat.completions.\cf7 \strokec7 create\cf3 \strokec3 (\{
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0model\cf7 \strokec7 :\cf3 \strokec3  \cf8 \strokec8 'gpt-4o'\cf3 \strokec3 , 
\f4\i \cf5 \strokec5 // Best quality for wisdom extraction
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0messages\cf7 \strokec7 :\cf3 \strokec3  [
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\{
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0role\cf7 \strokec7 :\cf3 \strokec3  \cf8 \strokec8 'system'\cf3 \strokec3 ,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0content\cf7 \strokec7 :\cf3 \strokec3  \cf8 \strokec8 `You are extracting life lessons from personal stories.
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Your goal is to find the wisdom that can be passed to future generations.
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Each lesson should be 15-20 words, clear, and meaningful.
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Avoid:
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0- Generic platitudes ("Be yourself", "Follow your heart")
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0- Overly specific details that won't apply to others
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0- Negative framing ("Don't trust people")
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0- Abstract philosophy
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Focus on:
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0- Universal truths discovered through personal experience
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0- Practical wisdom that guides decisions
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0- Character insights that shape who we become
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf8 \strokec8 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0- The cost and value of choices made`
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\},
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\{
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0role\cf7 \strokec7 :\cf3 \strokec3  \cf8 \strokec8 'user'\cf3 \strokec3 ,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0content\cf7 \strokec7 :\cf3 \strokec3  \cf8 \strokec8 `From this story, extract 3 different types of lessons:
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a01. PRACTICAL LESSON (what to DO in similar situations)
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a02. EMOTIONAL TRUTH (what to FEEL or how to process emotions)
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a03. CHARACTER INSIGHT (who to BE or what kind of person to become)
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf8 \strokec8 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Story: "\cf3 \strokec3 $\{transcript\}\cf8 \strokec8 "
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf8 \strokec8 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Return exactly 3 lessons, each 15-20 words.`
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\}
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0],
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0temperature\cf7 \strokec7 :\cf3 \strokec3  \cf9 \strokec9 0.8\cf3 \strokec3 , 
\f4\i \cf5 \strokec5 // Higher for more creative, insightful responses
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0max_tokens\cf7 \strokec7 :\cf3 \strokec3  \cf9 \strokec9 150
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\});
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f4\i \cf5 \strokec5 // Parse the response
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 const\cf3 \strokec3  lessons \cf7 \strokec7 =\cf3 \strokec3  \cf7 \strokec7 parseGPTLessons\cf3 \strokec3 (completion.choices[\cf9 \strokec9 0\cf3 \strokec3 ].message.content);
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 return\cf3 \strokec3  \{
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0practical\cf7 \strokec7 :\cf3 \strokec3  lessons[\cf9 \strokec9 0\cf3 \strokec3 ] \cf7 \strokec7 ||\cf3 \strokec3  \cf8 \strokec8 "Every experience teaches something if you're willing to learn from it"\cf3 \strokec3 ,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0emotional\cf7 \strokec7 :\cf3 \strokec3  lessons[\cf9 \strokec9 1\cf3 \strokec3 ] \cf7 \strokec7 ||\cf3 \strokec3  \cf8 \strokec8 "The heart remembers what the mind forgets"\cf3 \strokec3 ,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0character\cf7 \strokec7 :\cf3 \strokec3  lessons[\cf9 \strokec9 2\cf3 \strokec3 ] \cf7 \strokec7 ||\cf3 \strokec3  \cf8 \strokec8 "Who you become matters more than what you achieve"
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\};
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \}
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0
\cf0 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf6 \strokec6 function\cf3 \strokec3  \cf7 \strokec7 parseGPTLessons\cf3 \strokec3 (content\cf7 \strokec7 :\cf3 \strokec3  \cf8 \strokec8 string\cf3 \strokec3 )\cf7 \strokec7 :\cf3 \strokec3  \cf8 \strokec8 string\cf3 \strokec3 [] \{
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf3 \strokec3 \'a0\'a0
\f4\i \cf5 \strokec5 // Extract lessons from GPT response
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 const\cf3 \strokec3  lines \cf7 \strokec7 =\cf3 \strokec3  content.\cf7 \strokec7 split\cf3 \strokec3 (\cf8 \strokec8 '\\n'\cf3 \strokec3 )
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0.\cf7 \strokec7 map\cf3 \strokec3 (line \cf7 \strokec7 =>\cf3 \strokec3  line.\cf7 \strokec7 trim\cf3 \strokec3 ())
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0.\cf7 \strokec7 filter\cf3 \strokec3 (line \cf7 \strokec7 =>\cf3 \strokec3  line.length \cf7 \strokec7 >\cf3 \strokec3  \cf9 \strokec9 0\cf3 \strokec3 );
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 const\cf3 \strokec3  lessons \cf7 \strokec7 =\cf3 \strokec3  lines
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0.\cf7 \strokec7 filter\cf3 \strokec3 (line \cf7 \strokec7 =>\cf3 \strokec3  \{
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0
\f4\i \cf5 \strokec5 // Look for numbered items or lessons
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\cf6 \strokec6 return\cf3 \strokec3  \cf8 \strokec8 /^[1-3][\\.\\):]/\cf3 \strokec3 .\cf7 \strokec7 test\cf3 \strokec3 (line) \cf7 \strokec7 ||\cf3 \strokec3 \'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0line.\cf7 \strokec7 toLowerCase\cf3 \strokec3 ().\cf7 \strokec7 includes\cf3 \strokec3 (\cf8 \strokec8 'lesson'\cf3 \strokec3 ) \cf7 \strokec7 ||
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0line.length \cf7 \strokec7 >\cf3 \strokec3  \cf9 \strokec9 10\cf3 \strokec3 ;
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\})
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0.\cf7 \strokec7 map\cf3 \strokec3 (line \cf7 \strokec7 =>\cf3 \strokec3  \{
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0
\f4\i \cf5 \strokec5 // Clean up numbering and labels
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\cf6 \strokec6 return\cf3 \strokec3  line.\cf7 \strokec7 replace\cf3 \strokec3 (\cf8 \strokec8 /^[1-3][\\.\\):]\\s*/\cf3 \strokec3 , \cf8 \strokec8 ''\cf3 \strokec3 )
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0.\cf7 \strokec7 replace\cf3 \strokec3 (\cf8 \strokec8 /^(PRACTICAL|EMOTIONAL|CHARACTER)[:\\s]*/i\cf3 \strokec3 , \cf8 \strokec8 ''\cf3 \strokec3 )
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0.\cf7 \strokec7 replace\cf3 \strokec3 (\cf8 \strokec8 /^LESSON[:\\s]*/i\cf3 \strokec3 , \cf8 \strokec8 ''\cf3 \strokec3 )
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0.\cf7 \strokec7 trim\cf3 \strokec3 ();
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\})
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0.\cf7 \strokec7 filter\cf3 \strokec3 (lesson \cf7 \strokec7 =>\cf3 \strokec3  lesson.length \cf7 \strokec7 >\cf3 \strokec3  \cf9 \strokec9 10\cf3 \strokec3  \cf7 \strokec7 &&\cf3 \strokec3  lesson.length \cf7 \strokec7 <\cf3 \strokec3  \cf9 \strokec9 150\cf3 \strokec3 );
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 return\cf3 \strokec3  lessons.\cf7 \strokec7 slice\cf3 \strokec3 (\cf9 \strokec9 0\cf3 \strokec3 , \cf9 \strokec9 3\cf3 \strokec3 );
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \}
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0
\cf0 \
\pard\pardeftab720\sa240\partightenfactor0

\f4\i\b \cf5 \strokec5 // ============================================================================
\f2\i0\b0 \cf0 \strokec2 \

\f4\i\b \cf5 \strokec5 // QUALITY SCORING FOR LESSONS
\f2\i0\b0 \cf0 \strokec2 \

\f4\i\b \cf5 \strokec5 // ============================================================================
\f2\i0\b0 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0
\cf0 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf6 \strokec6 function\cf3 \strokec3  \cf7 \strokec7 scoreLessonQuality\cf3 \strokec3 (lesson\cf7 \strokec7 :\cf3 \strokec3  \cf8 \strokec8 string\cf3 \strokec3 , transcript\cf7 \strokec7 :\cf3 \strokec3  \cf8 \strokec8 string\cf3 \strokec3 )\cf7 \strokec7 :\cf3 \strokec3  \cf8 \strokec8 number\cf3 \strokec3  \{
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 let\cf3 \strokec3  score \cf7 \strokec7 =\cf3 \strokec3  \cf9 \strokec9 50\cf3 \strokec3 ; 
\f4\i \cf5 \strokec5 // Base score
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f4\i \cf5 \strokec5 // Specificity bonus (mentions specific elements from story)
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 const\cf3 \strokec3  storyWords \cf7 \strokec7 =\cf3 \strokec3  \cf7 \strokec7 extractKeywords\cf3 \strokec3 (transcript);
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 const\cf3 \strokec3  lessonWords \cf7 \strokec7 =\cf3 \strokec3  lesson.\cf7 \strokec7 toLowerCase\cf3 \strokec3 ().\cf7 \strokec7 split\cf3 \strokec3 (\cf8 \strokec8 ' '\cf3 \strokec3 );
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 const\cf3 \strokec3  overlap \cf7 \strokec7 =\cf3 \strokec3  lessonWords.\cf7 \strokec7 filter\cf3 \strokec3 (word \cf7 \strokec7 =>\cf3 \strokec3  storyWords.\cf7 \strokec7 includes\cf3 \strokec3 (word)).length;
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0score \cf7 \strokec7 +=\cf3 \strokec3  overlap \cf7 \strokec7 *\cf3 \strokec3  \cf9 \strokec9 10\cf3 \strokec3 ;
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f4\i \cf5 \strokec5 // Length penalty (too short or too long)
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 const\cf3 \strokec3  wordCount \cf7 \strokec7 =\cf3 \strokec3  lesson.\cf7 \strokec7 split\cf3 \strokec3 (\cf8 \strokec8 ' '\cf3 \strokec3 ).length;
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 if\cf3 \strokec3  (wordCount \cf7 \strokec7 <\cf3 \strokec3  \cf9 \strokec9 10\cf3 \strokec3 ) score \cf7 \strokec7 -=\cf3 \strokec3  \cf9 \strokec9 20\cf3 \strokec3 ;
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 if\cf3 \strokec3  (wordCount \cf7 \strokec7 >\cf3 \strokec3  \cf9 \strokec9 25\cf3 \strokec3 ) score \cf7 \strokec7 -=\cf3 \strokec3  \cf9 \strokec9 10\cf3 \strokec3 ;
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 if\cf3 \strokec3  (wordCount \cf7 \strokec7 >=\cf3 \strokec3  \cf9 \strokec9 15\cf3 \strokec3  \cf7 \strokec7 &&\cf3 \strokec3  wordCount \cf7 \strokec7 <=\cf3 \strokec3  \cf9 \strokec9 20\cf3 \strokec3 ) score \cf7 \strokec7 +=\cf3 \strokec3  \cf9 \strokec9 10\cf3 \strokec3 ;
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f4\i \cf5 \strokec5 // Clich\'e9 penalty
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 const\cf3 \strokec3  cliches \cf7 \strokec7 =\cf3 \strokec3  [
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\cf8 \strokec8 'follow your heart'\cf3 \strokec3 , \cf8 \strokec8 'be yourself'\cf3 \strokec3 , \cf8 \strokec8 'everything happens'\cf3 \strokec3 ,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\cf8 \strokec8 'time heals'\cf3 \strokec3 , \cf8 \strokec8 'what doesn\\'t kill'\cf3 \strokec3 , \cf8 \strokec8 'when one door'
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0];
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 if\cf3 \strokec3  (cliches.\cf7 \strokec7 some\cf3 \strokec3 (cliche \cf7 \strokec7 =>\cf3 \strokec3  lesson.\cf7 \strokec7 toLowerCase\cf3 \strokec3 ().\cf7 \strokec7 includes\cf3 \strokec3 (cliche))) \{
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0score \cf7 \strokec7 -=\cf3 \strokec3  \cf9 \strokec9 30\cf3 \strokec3 ;
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\}
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f4\i \cf5 \strokec5 // Action words bonus
\f2\i0\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 const\cf3 \strokec3  actionWords \cf7 \strokec7 =\cf3 \strokec3  [\cf8 \strokec8 'choose'\cf3 \strokec3 , \cf8 \strokec8 'build'\cf3 \strokec3 , \cf8 \strokec8 'create'\cf3 \strokec3 , \cf8 \strokec8 'fight'\cf3 \strokec3 , \cf8 \strokec8 'protect'\cf3 \strokec3 , \cf8 \strokec8 'learn'\cf3 \strokec3 ];
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 if\cf3 \strokec3  (actionWords.\cf7 \strokec7 some\cf3 \strokec3 (word \cf7 \strokec7 =>\cf3 \strokec3  lesson.\cf7 \strokec7 toLowerCase\cf3 \strokec3 ().\cf7 \strokec7 includes\cf3 \strokec3 (word))) \{
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0score \cf7 \strokec7 +=\cf3 \strokec3  \cf9 \strokec9 15\cf3 \strokec3 ;
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\}
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf6 \strokec6 return\cf3 \strokec3  \cf9 \strokec9 Math\cf3 \strokec3 .\cf7 \strokec7 max\cf3 \strokec3 (\cf9 \strokec9 0\cf3 \strokec3 , \cf9 \strokec9 Math\cf3 \strokec3 .\cf7 \strokec7 min\cf3 \strokec3 (\cf9 \strokec9 100\cf3 \strokec3 , score));
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa160\partightenfactor0

\f0\b \cf3 \strokec3 \}
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0
\cf0 \strokec2 \
\pard\pardeftab720\sa293\partightenfactor0

\f0\b\fs36 \cf0 \strokec2 8. EDGE CASES & FALLBACKS
\f2\b0\fs24 \
\pard\pardeftab720\sa293\partightenfactor0

\f0\b\fs28 \cf0 8.1 Empty Inventory Loop Prevention
\f2\b0\fs24 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 Scenario:
\f3\b0  User opens timeline, no active prompts, Tier 2 generates nothing
\f2 \strokec2 \

\f0\b \strokec2 Solution:
\f3\b0  Circuit breaker with rate limit + fallback
\f2 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf0 \strokec2 typescript
\f2 \strokec2 \

\f3 \cf11 \strokec11 async\cf4 \strokec4  \cf11 \strokec11 function\cf4 \strokec4  \cf12 \strokec12 getNextPromptWithCircuitBreaker\cf4 \strokec4 (userId\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 string\cf4 \strokec4 ) \{
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // 1. Try to fetch existing prompt
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 let\cf4 \strokec4  prompt \cf12 \strokec12 =\cf4 \strokec4  \cf11 \strokec11 await\cf4 \strokec4  \cf12 \strokec12 fetchActivePrompt\cf4 \strokec4 (userId);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 if\cf4 \strokec4  (prompt) \cf11 \strokec11 return\cf4 \strokec4  prompt;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // 2. Check Tier 2 rate limit (max 1 per 24 hours)
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  user \cf12 \strokec12 =\cf4 \strokec4  \cf11 \strokec11 await\cf4 \strokec4  db.users.\cf12 \strokec12 findById\cf4 \strokec4 (userId);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  lastAttempt \cf12 \strokec12 =\cf4 \strokec4  user.last_tier2_attempt;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  hoursSinceLast \cf12 \strokec12 =\cf4 \strokec4  lastAttempt\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf12 \strokec12 ?\cf4 \strokec4  (\cf13 \strokec13 Date\cf4 \strokec4 .\cf12 \strokec12 now\cf4 \strokec4 () \cf12 \strokec12 -\cf4 \strokec4  lastAttempt.\cf12 \strokec12 getTime\cf4 \strokec4 ()) \cf12 \strokec12 /\cf4 \strokec4  (\cf13 \strokec13 1000\cf4 \strokec4  \cf12 \strokec12 *\cf4 \strokec4  \cf13 \strokec13 60\cf4 \strokec4  \cf12 \strokec12 *\cf4 \strokec4  \cf13 \strokec13 60\cf4 \strokec4 )
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf12 \strokec12 :\cf4 \strokec4  \cf13 \strokec13 999\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 if\cf4 \strokec4  (hoursSinceLast \cf12 \strokec12 <\cf4 \strokec4  \cf13 \strokec13 24\cf4 \strokec4 ) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0
\f5\i \cf10 \strokec10 // Rate limited - immediate fallback
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 return\cf4 \strokec4  \cf11 \strokec11 await\cf4 \strokec4  \cf12 \strokec12 generateDecadeFallback\cf4 \strokec4 (userId);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // 3. Try Tier 2 generation
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 try\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 await\cf4 \strokec4  db.users.\cf12 \strokec12 update\cf4 \strokec4 (userId, \{ last_tier2_attempt\cf12 \strokec12 :\cf4 \strokec4  \cf11 \strokec11 new\cf4 \strokec4  \cf13 \strokec13 Date\cf4 \strokec4 () \});
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  tier2Prompt \cf12 \strokec12 =\cf4 \strokec4  \cf11 \strokec11 await\cf4 \strokec4  \cf12 \strokec12 generateTier2Prompt\cf4 \strokec4 (userId);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 if\cf4 \strokec4  (tier2Prompt) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf11 \strokec11 return\cf4 \strokec4  tier2Prompt;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\} \cf11 \strokec11 else\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0
\f5\i \cf10 \strokec10 // Generation returned nothing - fallback
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf11 \strokec11 return\cf4 \strokec4  \cf11 \strokec11 await\cf4 \strokec4  \cf12 \strokec12 generateDecadeFallback\cf4 \strokec4 (userId);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\} \cf11 \strokec11 catch\cf4 \strokec4  (error) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0
\f5\i \cf10 \strokec10 // API error - fallback
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf13 \strokec13 console\cf4 \strokec4 .\cf12 \strokec12 error\cf4 \strokec4 (\cf14 \strokec14 'Tier 2 generation failed:'\cf4 \strokec4 , error);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 return\cf4 \strokec4  \cf11 \strokec11 await\cf4 \strokec4  \cf12 \strokec12 generateDecadeFallback\cf4 \strokec4 (userId);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \}\

\f2 \cf0 \strokec2 \
\pard\pardeftab720\sa293\partightenfactor0

\f0\b\fs28 \cf0 \strokec2 8.2 Story 3 Low Quality Scores
\f2\b0\fs24 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 Scenario:
\f3\b0  All 5 Story 3 candidates score < 50 (too low to show)
\f2 \strokec2 \

\f0\b \strokec2 Solution:
\f3\b0  Retry with sensory-only focus, then fallback
\f2 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf0 \strokec2 typescript
\f2 \strokec2 \

\f3 \cf11 \strokec11 async\cf4 \strokec4  \cf11 \strokec11 function\cf4 \strokec4  \cf12 \strokec12 generateStory3PromptWithRetry\cf4 \strokec4 (userId\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 string\cf4 \strokec4 )\cf12 \strokec12 :\cf4 \strokec4  \cf13 \strokec13 Promise\cf12 \strokec12 <\cf11 \strokec11 void\cf12 \strokec12 >\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // First attempt: standard Story 3 analysis
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  candidates \cf12 \strokec12 =\cf4 \strokec4  \cf11 \strokec11 await\cf4 \strokec4  \cf12 \strokec12 generateStory3Candidates\cf4 \strokec4 (userId);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  filtered \cf12 \strokec12 =\cf4 \strokec4  candidates.\cf12 \strokec12 filter\cf4 \strokec4 (c \cf12 \strokec12 =>\cf4 \strokec4  c.recordingLikelihood \cf12 \strokec12 >=\cf4 \strokec4  \cf13 \strokec13 50\cf4 \strokec4 );
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 if\cf4 \strokec4  (filtered.length \cf12 \strokec12 >=\cf4 \strokec4  \cf13 \strokec13 1\cf4 \strokec4 ) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0
\f5\i \cf10 \strokec10 // Success - store as normal
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 await\cf4 \strokec4  \cf12 \strokec12 storeStory3Prompts\cf4 \strokec4 (userId, filtered);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 return\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // All candidates failed - retry with sensory focus
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf13 \strokec13 console\cf4 \strokec4 .\cf12 \strokec12 warn\cf4 \strokec4 (\cf14 \strokec14 `Story 3 candidates all scored < 50 for user \cf4 \strokec4 $\{userId\}\cf14 \strokec14 , retrying...`\cf4 \strokec4 );
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  retryPrompt \cf12 \strokec12 =\cf4 \strokec4  \cf14 \strokec14 `
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0The previous 5 candidates scored too low. Try again with ONLY sensory detail prompts.
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0Focus EXCLUSIVELY on:
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0- "What did X smell like?"
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0- "What color was X?"
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0- "What did you hear when X happened?"
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0- "Describe the room where X happened"
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0Generate 3 sensory-focused candidates.
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf14 \strokec14 \'a0\'a0`\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  retryCandidates \cf12 \strokec12 =\cf4 \strokec4  \cf11 \strokec11 await\cf4 \strokec4  \cf12 \strokec12 callOpenAI\cf4 \strokec4 (retryPrompt);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  retryFiltered \cf12 \strokec12 =\cf4 \strokec4  retryCandidates.\cf12 \strokec12 filter\cf4 \strokec4 (c \cf12 \strokec12 =>\cf4 \strokec4  c.recordingLikelihood \cf12 \strokec12 >=\cf4 \strokec4  \cf13 \strokec13 50\cf4 \strokec4 );
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 if\cf4 \strokec4  (retryFiltered.length \cf12 \strokec12 >=\cf4 \strokec4  \cf13 \strokec13 1\cf4 \strokec4 ) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0
\f5\i \cf10 \strokec10 // Retry succeeded
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 await\cf4 \strokec4  \cf12 \strokec12 storeStory3Prompts\cf4 \strokec4 (userId, retryFiltered);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 return\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // Still failed - use decade fallback as last resort
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf13 \strokec13 console\cf4 \strokec4 .\cf12 \strokec12 error\cf4 \strokec4 (\cf14 \strokec14 `Story 3 retry also failed for user \cf4 \strokec4 $\{userId\}\cf14 \strokec14 , using fallback`\cf4 \strokec4 );
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  fallback \cf12 \strokec12 =\cf4 \strokec4  \cf11 \strokec11 await\cf4 \strokec4  \cf12 \strokec12 generateDecadeFallback\cf4 \strokec4 (userId);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 await\cf4 \strokec4  \cf12 \strokec12 storePrompt\cf4 \strokec4 (userId, fallback, \cf13 \strokec13 3\cf4 \strokec4 , \cf13 \strokec13 false\cf4 \strokec4 );
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // Also create 3 generic locked prompts for premium seed
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 for\cf4 \strokec4  (\cf11 \strokec11 let\cf4 \strokec4  i \cf12 \strokec12 =\cf4 \strokec4  \cf13 \strokec13 0\cf4 \strokec4 ; i \cf12 \strokec12 <\cf4 \strokec4  \cf13 \strokec13 3\cf4 \strokec4 ; i\cf12 \strokec12 ++\cf4 \strokec4 ) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  genericFallback \cf12 \strokec12 =\cf4 \strokec4  \cf11 \strokec11 await\cf4 \strokec4  \cf12 \strokec12 generateDecadeFallback\cf4 \strokec4 (userId);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 await\cf4 \strokec4  \cf12 \strokec12 storePrompt\cf4 \strokec4 (userId, genericFallback, \cf13 \strokec13 3\cf4 \strokec4 , \cf13 \strokec13 true\cf4 \strokec4 ); 
\f5\i \cf10 \strokec10 // Locked
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \}\

\f2 \cf0 \strokec2 \
\pard\pardeftab720\sa293\partightenfactor0

\f0\b\fs28 \cf0 \strokec2 8.3 Payment Failure After Story 3
\f2\b0\fs24 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 Scenario:
\f3\b0  User sees Story 3 killer prompt, clicks "See What I Found", but payment fails
\f2 \strokec2 \

\f0\b \strokec2 Solution:
\f3\b0  Keep prompts locked, send recovery email
\f2 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf0 \strokec2 typescript
\f2 \strokec2 \

\f5\i \cf10 \strokec10 // Stripe webhook handler
\f2\i0 \cf0 \strokec2 \

\f3 \cf11 \strokec11 async\cf4 \strokec4  \cf11 \strokec11 function\cf4 \strokec4  \cf12 \strokec12 handleStripeWebhook\cf4 \strokec4 (event) \{
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 if\cf4 \strokec4  (event.type \cf12 \strokec12 ===\cf4 \strokec4  \cf14 \strokec14 'checkout.session.expired'\cf4 \strokec4 ) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  userId \cf12 \strokec12 =\cf4 \strokec4  event.data.object.client_reference_id;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0
\f5\i \cf10 \strokec10 // Payment failed or abandoned
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0
\f5\i \cf10 \strokec10 // Prompts remain locked
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0
\f5\i \cf10 \strokec10 // Send recovery email
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 await\cf4 \strokec4  \cf12 \strokec12 sendEmail\cf4 \strokec4 (\{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0to\cf12 \strokec12 :\cf4 \strokec4  user.email,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0subject\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 "Your Story Analysis is Still Waiting"\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0body\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 `
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf14 \strokec14 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Hi \cf4 \strokec4 $\{user.firstName\}\cf14 \strokec14 ,
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0I've analyzed your first 3 stories and found 3 specific memories\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0you should record. Your personalized prompts are ready whenever\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0you're ready to continue.
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0[Complete Your Subscription - $149/year]
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0Your prompts will be waiting for you.
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf14 \strokec14 \'a0\'a0\'a0\'a0\'a0\'a0`
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\});
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 return\cf4 \strokec4  \{ received\cf12 \strokec12 :\cf4 \strokec4  \cf13 \strokec13 true\cf4 \strokec4  \};
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \}\

\f2 \cf0 \strokec2 \
\pard\pardeftab720\sa293\partightenfactor0

\f0\b\fs28 \cf0 \strokec2 8.4 User Deletes Story That Generated Prompts
\f2\b0\fs24 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 Scenario:
\f3\b0  User deletes Story 2, which generated prompts about "father's workshop"
\f2 \strokec2 \

\f0\b \strokec2 Solution:
\f3\b0  Prompts remain valid (they reference the story, but don't require it)
\f2 \strokec2 \

\f0\b \strokec2 No action needed
\f3\b0  - prompts are independent of source story. If user asks "What story is this based on?" and can't find it, that's a rare edge case.
\f2 \strokec2 \

\f0\b \strokec2 Alternative:
\f3\b0  Mark prompts as 
\fs26\fsmilli13333 source_story_deleted
\fs24  if you want to handle it:
\f2 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf0 \strokec2 typescript
\f2 \strokec2 \

\f3 \cf11 \strokec11 async\cf4 \strokec4  \cf11 \strokec11 function\cf4 \strokec4  \cf12 \strokec12 handleStoryDelete\cf4 \strokec4 (storyId\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 string\cf4 \strokec4 , userId\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 string\cf4 \strokec4 ) \{
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // Delete story
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 await\cf4 \strokec4  db.stories.\cf12 \strokec12 delete\cf4 \strokec4 (storyId);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // Optional: Mark related prompts
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 await\cf4 \strokec4  db.active_prompts.\cf12 \strokec12 updateMany\cf4 \strokec4 (
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0userId,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0sourceStoryIds\cf12 \strokec12 :\cf4 \strokec4  \{ $contains\cf12 \strokec12 :\cf4 \strokec4  [storyId] \}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\},
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0metadata\cf12 \strokec12 :\cf4 \strokec4  \{ sourceStoryDeleted\cf12 \strokec12 :\cf4 \strokec4  \cf13 \strokec13 true\cf4 \strokec4  \}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \}\

\f2 \cf0 \strokec2 \
\pard\pardeftab720\sa293\partightenfactor0

\f0\b\fs28 \cf0 \strokec2 8.5 User Maxes Out do_not_ask Topics
\f2\b0\fs24 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 Scenario:
\f3\b0  User has blocked 20 topics in do_not_ask, AI can't find anything to ask
\f2 \strokec2 \

\f0\b \strokec2 Solution:
\f3\b0  Decade fallback + notification
\f2 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf0 \strokec2 typescript
\f2 \strokec2 \

\f3 \cf11 \strokec11 async\cf4 \strokec4  \cf11 \strokec11 function\cf4 \strokec4  \cf12 \strokec12 generateWithSafetyFilter\cf4 \strokec4 (userId\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 string\cf4 \strokec4 ) \{
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  user \cf12 \strokec12 =\cf4 \strokec4  \cf11 \strokec11 await\cf4 \strokec4  db.users.\cf12 \strokec12 findById\cf4 \strokec4 (userId);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  bannedTopics \cf12 \strokec12 =\cf4 \strokec4  user.do_not_ask \cf12 \strokec12 ||\cf4 \strokec4  [];
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 if\cf4 \strokec4  (bannedTopics.length \cf12 \strokec12 >\cf4 \strokec4  \cf13 \strokec13 15\cf4 \strokec4 ) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf13 \strokec13 console\cf4 \strokec4 .\cf12 \strokec12 warn\cf4 \strokec4 (\cf14 \strokec14 `User \cf4 \strokec4 $\{userId\}\cf14 \strokec14  has \cf4 \strokec4 $\{bannedTopics.length\}\cf14 \strokec14  blocked topics`\cf4 \strokec4 );
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // Generate candidates
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  candidates \cf12 \strokec12 =\cf4 \strokec4  \cf11 \strokec11 await\cf4 \strokec4  \cf12 \strokec12 generateCandidates\cf4 \strokec4 (userId);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // Filter out banned topics
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  safe \cf12 \strokec12 =\cf4 \strokec4  candidates.\cf12 \strokec12 filter\cf4 \strokec4 (c \cf12 \strokec12 =>\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  lowerPrompt \cf12 \strokec12 =\cf4 \strokec4  c.prompt.\cf12 \strokec12 toLowerCase\cf4 \strokec4 ();
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 return\cf4 \strokec4  \cf12 \strokec12 !\cf4 \strokec4 bannedTopics.\cf12 \strokec12 some\cf4 \strokec4 (topic \cf12 \strokec12 =>\cf4 \strokec4  lowerPrompt.\cf12 \strokec12 includes\cf4 \strokec4 (topic.\cf12 \strokec12 toLowerCase\cf4 \strokec4 ()));
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\});
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 if\cf4 \strokec4  (safe.length \cf12 \strokec12 ===\cf4 \strokec4  \cf13 \strokec13 0\cf4 \strokec4 ) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0
\f5\i \cf10 \strokec10 // All prompts blocked - use decade fallback
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 return\cf4 \strokec4  \cf11 \strokec11 await\cf4 \strokec4  \cf12 \strokec12 generateDecadeFallback\cf4 \strokec4 (userId);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 return\cf4 \strokec4  safe;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \}\

\f2 \cf0 \strokec2 \
\pard\pardeftab720\sa293\partightenfactor0

\f0\b\fs36 \cf0 \strokec2 9. SAFETY & COMPLIANCE
\f2\b0\fs24 \
\pard\pardeftab720\sa293\partightenfactor0

\f0\b\fs28 \cf0 9.1 do_not_ask Implementation
\f2\b0\fs24 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 Purpose:
\f3\b0  User-controlled topic blocking
\f2 \strokec2 \

\f0\b \strokec2 Storage:
\f2\b0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf0 \strokec2 sql
\f2 \strokec2 \

\f5\i \cf10 \strokec10 -- In users table
\f2\i0 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 do_not_ask JSONB \cf11 \strokec11 DEFAULT\cf4 \strokec4  \cf14 \strokec14 '[]'\cf4 \strokec4 ::jsonb
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f5\i \cf10 \strokec10 -- Example value:
\f2\i0 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 [\cf14 \strokec14 "divorce"\cf4 \strokec4 , \cf14 \strokec14 "mother's death"\cf4 \strokec4 , \cf14 \strokec14 "bankruptcy"\cf4 \strokec4 , \cf14 \strokec14 "cancer"\cf4 \strokec4 ]
\f2 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 \strokec2 UI Flow:
\f2\b0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 User clicks "I don't want to be asked about this" on a prompt
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 Modal: "What topic should I avoid?"
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 User types: "my divorce"
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 UPDATE users SET do_not_ask = do_not_ask || '["divorce"]'
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 WHERE id = $userId
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 Delete any active prompts containing "divorce"
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\uc0\u8595 
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 Future prompts filtered before insertion
\f2 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 \strokec2 Implementation:
\f2\b0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf0 \strokec2 typescript
\f2 \strokec2 \

\f3 \cf11 \strokec11 async\cf4 \strokec4  \cf11 \strokec11 function\cf4 \strokec4  \cf12 \strokec12 addToDoNotAsk\cf4 \strokec4 (userId\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 string\cf4 \strokec4 , topic\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 string\cf4 \strokec4 )\cf12 \strokec12 :\cf4 \strokec4  \cf13 \strokec13 Promise\cf12 \strokec12 <\cf11 \strokec11 void\cf12 \strokec12 >\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // Normalize topic
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  normalized \cf12 \strokec12 =\cf4 \strokec4  topic.\cf12 \strokec12 toLowerCase\cf4 \strokec4 ().\cf12 \strokec12 trim\cf4 \strokec4 ();
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // Add to user's do_not_ask list
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 await\cf4 \strokec4  db.\cf12 \strokec12 query\cf4 \strokec4 (\cf14 \strokec14 `
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0UPDATE users
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0SET do_not_ask =\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0CASE\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0WHEN do_not_ask IS NULL THEN $2::jsonb
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0ELSE do_not_ask || $2::jsonb
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0END
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0WHERE id = $1
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf14 \strokec14 \'a0\'a0`\cf4 \strokec4 , [userId, \cf13 \strokec13 JSON\cf4 \strokec4 .\cf12 \strokec12 stringify\cf4 \strokec4 ([normalized])]);
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // Delete any active prompts containing this topic
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  prompts \cf12 \strokec12 =\cf4 \strokec4  \cf11 \strokec11 await\cf4 \strokec4  db.active_prompts.\cf12 \strokec12 find\cf4 \strokec4 (\{ userId \});
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 for\cf4 \strokec4  (\cf11 \strokec11 const\cf4 \strokec4  prompt \cf11 \strokec11 of\cf4 \strokec4  prompts) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 if\cf4 \strokec4  (prompt.prompt_text.\cf12 \strokec12 toLowerCase\cf4 \strokec4 ().\cf12 \strokec12 includes\cf4 \strokec4 (normalized)) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf11 \strokec11 await\cf4 \strokec4  db.active_prompts.\cf12 \strokec12 delete\cf4 \strokec4 (prompt.id);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf13 \strokec13 console\cf4 \strokec4 .\cf12 \strokec12 log\cf4 \strokec4 (\cf14 \strokec14 `Removed prompt containing banned topic "\cf4 \strokec4 $\{topic\}\cf14 \strokec14 ":`\cf4 \strokec4 , prompt.prompt_text);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \}
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf11 \strokec11 async\cf4 \strokec4  \cf11 \strokec11 function\cf4 \strokec4  \cf12 \strokec12 filterBannedTopics\cf4 \strokec4 (
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0userId\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 string\cf4 \strokec4 ,\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0candidates\cf12 \strokec12 :\cf4 \strokec4  ScoredPrompt[]
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 )\cf12 \strokec12 :\cf4 \strokec4  \cf13 \strokec13 Promise\cf12 \strokec12 <\cf4 \strokec4 ScoredPrompt[]\cf12 \strokec12 >\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  user \cf12 \strokec12 =\cf4 \strokec4  \cf11 \strokec11 await\cf4 \strokec4  db.users.\cf12 \strokec12 findById\cf4 \strokec4 (userId);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  bannedTopics \cf12 \strokec12 =\cf4 \strokec4  user.do_not_ask \cf12 \strokec12 ||\cf4 \strokec4  [];
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 if\cf4 \strokec4  (bannedTopics.length \cf12 \strokec12 ===\cf4 \strokec4  \cf13 \strokec13 0\cf4 \strokec4 ) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 return\cf4 \strokec4  candidates;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 return\cf4 \strokec4  candidates.\cf12 \strokec12 filter\cf4 \strokec4 (c \cf12 \strokec12 =>\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  lowerPrompt \cf12 \strokec12 =\cf4 \strokec4  c.prompt.\cf12 \strokec12 toLowerCase\cf4 \strokec4 ();
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  containsBanned \cf12 \strokec12 =\cf4 \strokec4  bannedTopics.\cf12 \strokec12 some\cf4 \strokec4 (topic \cf12 \strokec12 =>\cf4 \strokec4 \'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0lowerPrompt.\cf12 \strokec12 includes\cf4 \strokec4 (topic.\cf12 \strokec12 toLowerCase\cf4 \strokec4 ())
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 return\cf4 \strokec4  \cf12 \strokec12 !\cf4 \strokec4 containsBanned;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\});
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \}\

\f2 \cf0 \strokec2 \
\pard\pardeftab720\sa293\partightenfactor0

\f0\b\fs28 \cf0 \strokec2 9.2 Content Safety Classifier
\f2\b0\fs24 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 Purpose:
\f3\b0  Block sensitive topics before insertion
\f2 \strokec2 \

\f0\b \strokec2 Blocked Topics:
\f2\b0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf0 \strokec2 typescript
\f2 \strokec2 \

\f3 \cf11 \strokec11 const\cf4 \strokec4  \cf13 \strokec13 SENSITIVE_TOPICS\cf4 \strokec4  \cf12 \strokec12 =\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0trauma\cf12 \strokec12 :\cf4 \strokec4  [
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf14 \strokec14 'abuse'\cf4 \strokec4 , \cf14 \strokec14 'assault'\cf4 \strokec4 , \cf14 \strokec14 'molest'\cf4 \strokec4 , \cf14 \strokec14 'rape'\cf4 \strokec4 , \cf14 \strokec14 'violence'\cf4 \strokec4 ,\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf14 \strokec14 'beaten'\cf4 \strokec4 , \cf14 \strokec14 'attacked'\cf4 \strokec4 , \cf14 \strokec14 'traumatized'
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0],
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0death\cf12 \strokec12 :\cf4 \strokec4  [
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf14 \strokec14 'died'\cf4 \strokec4 , \cf14 \strokec14 'death'\cf4 \strokec4 , \cf14 \strokec14 'funeral'\cf4 \strokec4 , \cf14 \strokec14 'suicide'\cf4 \strokec4 , \cf14 \strokec14 'killed'\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf14 \strokec14 'passed away'\cf4 \strokec4 , \cf14 \strokec14 'terminal'\cf4 \strokec4 , \cf14 \strokec14 'fatal'
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0],
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0addiction\cf12 \strokec12 :\cf4 \strokec4  [
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf14 \strokec14 'alcoholic'\cf4 \strokec4 , \cf14 \strokec14 'addict'\cf4 \strokec4 , \cf14 \strokec14 'overdose'\cf4 \strokec4 , \cf14 \strokec14 'rehab'\cf4 \strokec4 ,\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf14 \strokec14 'drinking problem'\cf4 \strokec4 , \cf14 \strokec14 'substance abuse'
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0],
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0financial\cf12 \strokec12 :\cf4 \strokec4  [
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf14 \strokec14 'bankruptcy'\cf4 \strokec4 , \cf14 \strokec14 'foreclosure'\cf4 \strokec4 , \cf14 \strokec14 'eviction'\cf4 \strokec4 , \cf14 \strokec14 'homeless'\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf14 \strokec14 'broke'\cf4 \strokec4 , \cf14 \strokec14 'debt'\cf4 \strokec4 , \cf14 \strokec14 'financial ruin'
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0],
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0infidelity\cf12 \strokec12 :\cf4 \strokec4  [
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf14 \strokec14 'affair'\cf4 \strokec4 , \cf14 \strokec14 'cheated'\cf4 \strokec4 , \cf14 \strokec14 'infidelity'\cf4 \strokec4 , \cf14 \strokec14 'adultery'\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf14 \strokec14 'unfaithful'\cf4 \strokec4 , \cf14 \strokec14 'mistress'\cf4 \strokec4 , \cf14 \strokec14 'lover'
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0],
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0medical\cf12 \strokec12 :\cf4 \strokec4  [
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf14 \strokec14 'cancer'\cf4 \strokec4 , \cf14 \strokec14 'diagnosis'\cf4 \strokec4 , \cf14 \strokec14 'surgery'\cf4 \strokec4 , \cf14 \strokec14 'hospital'\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf14 \strokec14 'disease'\cf4 \strokec4 , \cf14 \strokec14 'illness'\cf4 \strokec4 , \cf14 \strokec14 'treatment'
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0]
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \};\

\f2 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 \strokec2 Classification Function:
\f2\b0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf0 \strokec2 typescript
\f2 \strokec2 \

\f3 \cf11 \strokec11 function\cf4 \strokec4  \cf12 \strokec12 classifyPromptSafety\cf4 \strokec4 (promptText\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 string\cf4 \strokec4 )\cf12 \strokec12 :\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0safe\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 boolean\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0category\cf12 \strokec12 ?:\cf4 \strokec4  \cf14 \strokec14 string\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0matched\cf12 \strokec12 ?:\cf4 \strokec4  \cf14 \strokec14 string\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \} \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  lowerPrompt \cf12 \strokec12 =\cf4 \strokec4  promptText.\cf12 \strokec12 toLowerCase\cf4 \strokec4 ();
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 for\cf4 \strokec4  (\cf11 \strokec11 const\cf4 \strokec4  [category, keywords] \cf11 \strokec11 of\cf4 \strokec4  \cf13 \strokec13 Object\cf4 \strokec4 .\cf12 \strokec12 entries\cf4 \strokec4 (\cf13 \strokec13 SENSITIVE_TOPICS\cf4 \strokec4 )) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 for\cf4 \strokec4  (\cf11 \strokec11 const\cf4 \strokec4  keyword \cf11 \strokec11 of\cf4 \strokec4  keywords) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf11 \strokec11 if\cf4 \strokec4  (lowerPrompt.\cf12 \strokec12 includes\cf4 \strokec4 (keyword)) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\cf11 \strokec11 return\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0safe\cf12 \strokec12 :\cf4 \strokec4  \cf13 \strokec13 false\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0category,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0matched\cf12 \strokec12 :\cf4 \strokec4  keyword
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\};
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 return\cf4 \strokec4  \{ safe\cf12 \strokec12 :\cf4 \strokec4  \cf13 \strokec13 true\cf4 \strokec4  \};
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \}\

\f2 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 \strokec2 Application:
\f2\b0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf0 \strokec2 typescript
\f2 \strokec2 \

\f3 \cf11 \strokec11 async\cf4 \strokec4  \cf11 \strokec11 function\cf4 \strokec4  \cf12 \strokec12 storePromptWithSafety\cf4 \strokec4 (
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0userId\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 string\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0prompt\cf12 \strokec12 :\cf4 \strokec4  ScoredPrompt,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0tier\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 number
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 )\cf12 \strokec12 :\cf4 \strokec4  \cf13 \strokec13 Promise\cf12 \strokec12 <\cf11 \strokec11 void\cf12 \strokec12 >\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // Check safety
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  safety \cf12 \strokec12 =\cf4 \strokec4  \cf12 \strokec12 classifyPromptSafety\cf4 \strokec4 (prompt.prompt);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 if\cf4 \strokec4  (\cf12 \strokec12 !\cf4 \strokec4 safety.safe) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf13 \strokec13 console\cf4 \strokec4 .\cf12 \strokec12 warn\cf4 \strokec4 (
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf14 \strokec14 `Blocked unsafe prompt for user \cf4 \strokec4 $\{userId\}\cf14 \strokec14 :`\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf14 \strokec14 `Category: \cf4 \strokec4 $\{safety.category\}\cf14 \strokec14 , Matched: \cf4 \strokec4 $\{safety.matched\}\cf14 \strokec14 `
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 return\cf4 \strokec4 ; 
\f5\i \cf10 \strokec10 // Don't store
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // Check user's do_not_ask
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  user \cf12 \strokec12 =\cf4 \strokec4  \cf11 \strokec11 await\cf4 \strokec4  db.users.\cf12 \strokec12 findById\cf4 \strokec4 (userId);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  bannedTopics \cf12 \strokec12 =\cf4 \strokec4  user.do_not_ask \cf12 \strokec12 ||\cf4 \strokec4  [];
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 for\cf4 \strokec4  (\cf11 \strokec11 const\cf4 \strokec4  topic \cf11 \strokec11 of\cf4 \strokec4  bannedTopics) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 if\cf4 \strokec4  (prompt.prompt.\cf12 \strokec12 toLowerCase\cf4 \strokec4 ().\cf12 \strokec12 includes\cf4 \strokec4 (topic.\cf12 \strokec12 toLowerCase\cf4 \strokec4 ())) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf13 \strokec13 console\cf4 \strokec4 .\cf12 \strokec12 warn\cf4 \strokec4 (\cf14 \strokec14 `Blocked prompt matching do_not_ask topic "\cf4 \strokec4 $\{topic\}\cf14 \strokec14 "`\cf4 \strokec4 );
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf11 \strokec11 return\cf4 \strokec4 ; 
\f5\i \cf10 \strokec10 // Don't store
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // Safe - proceed with storage
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 await\cf4 \strokec4  \cf12 \strokec12 storePrompt\cf4 \strokec4 (userId, prompt, tier);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \}\

\f2 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 \strokec2 Exception:
\f3\b0  User initiates the topic
\f2 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf0 \strokec2 typescript
\f2 \strokec2 \

\f5\i \cf10 \strokec10 // If user's story mentions "cancer", it's OK to ask follow-ups about cancer
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 // The classifier only blocks UNSOLICITED sensitive prompts
\f2\i0 \cf0 \strokec2 \

\f3 \cf11 \strokec11 function\cf4 \strokec4  \cf12 \strokec12 shouldAllowSensitiveTopic\cf4 \strokec4 (
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0prompt\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 string\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0userStories\cf12 \strokec12 :\cf4 \strokec4  Story[]
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 )\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 boolean\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  safety \cf12 \strokec12 =\cf4 \strokec4  \cf12 \strokec12 classifyPromptSafety\cf4 \strokec4 (prompt);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 if\cf4 \strokec4  (safety.safe) \cf11 \strokec11 return\cf4 \strokec4  \cf13 \strokec13 true\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f5\i \cf10 \strokec10 // Check if user already discussed this topic
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  userMentionedIt \cf12 \strokec12 =\cf4 \strokec4  userStories.\cf12 \strokec12 some\cf4 \strokec4 (story \cf12 \strokec12 =>\cf4 \strokec4 \'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0story.transcript.\cf12 \strokec12 toLowerCase\cf4 \strokec4 ().\cf12 \strokec12 includes\cf4 \strokec4 (safety.matched)
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 if\cf4 \strokec4  (userMentionedIt) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf13 \strokec13 console\cf4 \strokec4 .\cf12 \strokec12 log\cf4 \strokec4 (
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf14 \strokec14 `Allowing sensitive prompt because user initiated topic: \cf4 \strokec4 $\{safety.matched\}\cf14 \strokec14 `
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0);
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 return\cf4 \strokec4  \cf13 \strokec13 true\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 return\cf4 \strokec4  \cf13 \strokec13 false\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \}\

\f2 \cf0 \strokec2 \
\pard\pardeftab720\sa293\partightenfactor0

\f0\b\fs28 \cf0 \strokec2 9.3 Recent Death Detection
\f2\b0\fs24 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 Purpose:
\f3\b0  Never ask about deaths within 1 year
\f2 \strokec2 \

\f0\b \strokec2 Implementation:
\f2\b0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf0 \strokec2 typescript
\f2 \strokec2 \

\f3 \cf11 \strokec11 function\cf4 \strokec4  \cf12 \strokec12 detectRecentDeath\cf4 \strokec4 (transcript\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 string\cf4 \strokec4 , storyYear\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 number\cf4 \strokec4 )\cf12 \strokec12 :\cf4 \strokec4  \cf14 \strokec14 boolean\cf4 \strokec4  \{
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  deathIndicators \cf12 \strokec12 =\cf4 \strokec4  [
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf14 \strokec14 /died/i\cf4 \strokec4 , \cf14 \strokec14 /passed away/i\cf4 \strokec4 , \cf14 \strokec14 /funeral/i\cf4 \strokec4 , \cf14 \strokec14 /buried/i\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf14 \strokec14 /lost (my|our) (mom|dad|mother|father|wife|husband|son|daughter)/i
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0];
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  currentYear \cf12 \strokec12 =\cf4 \strokec4  \cf11 \strokec11 new\cf4 \strokec4  \cf13 \strokec13 Date\cf4 \strokec4 ().\cf12 \strokec12 getFullYear\cf4 \strokec4 ();
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 const\cf4 \strokec4  yearsSinceDeath \cf12 \strokec12 =\cf4 \strokec4  currentYear \cf12 \strokec12 -\cf4 \strokec4  storyYear;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 if\cf4 \strokec4  (yearsSinceDeath \cf12 \strokec12 <\cf4 \strokec4  \cf13 \strokec13 1\cf4 \strokec4 ) \{
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0
\f5\i \cf10 \strokec10 // Story is from this year - check for death mentions
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 return\cf4 \strokec4  deathIndicators.\cf12 \strokec12 some\cf4 \strokec4 (pattern \cf12 \strokec12 =>\cf4 \strokec4  pattern.\cf12 \strokec12 test\cf4 \strokec4 (transcript));
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\}
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 return\cf4 \strokec4  \cf13 \strokec13 false\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \}
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f5\i \cf10 \strokec10 // In generateTier1Template:
\f2\i0 \cf0 \strokec2 \

\f3 \cf11 \strokec11 if\cf4 \strokec4  (\cf12 \strokec12 detectRecentDeath\cf4 \strokec4 (transcript, storyYear)) \{
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0\cf13 \strokec13 console\cf4 \strokec4 .\cf12 \strokec12 log\cf4 \strokec4 (\cf14 \strokec14 'Skipping Tier 1 prompt generation - recent death detected'\cf4 \strokec4 );
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 return\cf4 \strokec4  \cf11 \strokec11 null\cf4 \strokec4 ; 
\f5\i \cf10 \strokec10 // Don't generate any prompt
\f2\i0 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \}\

\f2 \cf0 \strokec2 \
\pard\pardeftab720\sa293\partightenfactor0

\f0\b\fs36 \cf0 \strokec2 10. METRICS & SUCCESS CRITERIA
\f2\b0\fs24 \
\pard\pardeftab720\sa293\partightenfactor0

\f0\b\fs28 \cf0 10.1 Primary KPIs
\f2\b0\fs24 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 Prompt \uc0\u8594  Recording Conversion Rate
\f2\b0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf0 \strokec2 sql
\f2 \strokec2 \

\f5\i \cf10 \strokec10 -- Overall conversion by tier
\f2\i0 \cf0 \strokec2 \

\f3 \cf11 \strokec11 SELECT\cf4 \strokec4 \'a0
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0tier,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf12 \strokec12 COUNT\cf4 \strokec4 (\cf11 \strokec11 CASE\cf4 \strokec4  \cf11 \strokec11 WHEN\cf4 \strokec4  outcome \cf12 \strokec12 =\cf4 \strokec4  \cf14 \strokec14 'used'\cf4 \strokec4  \cf11 \strokec11 THEN\cf4 \strokec4  \cf13 \strokec13 1\cf4 \strokec4  \cf11 \strokec11 END\cf4 \strokec4 )::\cf11 \strokec11 FLOAT\cf4 \strokec4  \cf12 \strokec12 /\cf4 \strokec4  \cf12 \strokec12 COUNT\cf4 \strokec4 (\cf12 \strokec12 *\cf4 \strokec4 ) \cf12 \strokec12 *\cf4 \strokec4  \cf13 \strokec13 100\cf4 \strokec4  \cf11 \strokec11 AS\cf4 \strokec4  conversion_rate,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf12 \strokec12 AVG\cf4 \strokec4 (shown_count) \cf11 \strokec11 AS\cf4 \strokec4  avg_shows_before_outcome
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf11 \strokec11 FROM\cf4 \strokec4  prompt_history
\f2 \cf0 \strokec2 \

\f3 \cf11 \strokec11 GROUP\cf4 \strokec4  \cf11 \strokec11 BY\cf4 \strokec4  tier
\f2 \cf0 \strokec2 \

\f3 \cf11 \strokec11 ORDER\cf4 \strokec4  \cf11 \strokec11 BY\cf4 \strokec4  tier;
\f2 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- Targets:
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- Tier 1: \uc0\u8805  50%
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- Tier 2: \uc0\u8805  70%
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- Tier 3: \uc0\u8805  80%\
\pard\pardeftab720\partightenfactor0

\f2\i0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 \strokec2 Free Tier Funnel Conversion
\f2\b0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf0 \strokec2 sql
\f2 \strokec2 \

\f5\i \cf10 \strokec10 -- Story 1 \uc0\u8594  Story 2 \u8594  Story 3 \u8594  Payment
\f2\i0 \cf0 \strokec2 \

\f3 \cf11 \strokec11 SELECT\cf4 \strokec4 \'a0
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0\cf12 \strokec12 COUNT\cf4 \strokec4 (\cf11 \strokec11 CASE\cf4 \strokec4  \cf11 \strokec11 WHEN\cf4 \strokec4  free_stories_used \cf12 \strokec12 >=\cf4 \strokec4  \cf13 \strokec13 1\cf4 \strokec4  \cf11 \strokec11 THEN\cf4 \strokec4  \cf13 \strokec13 1\cf4 \strokec4  \cf11 \strokec11 END\cf4 \strokec4 ) \cf11 \strokec11 AS\cf4 \strokec4  reached_story_1,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf12 \strokec12 COUNT\cf4 \strokec4 (\cf11 \strokec11 CASE\cf4 \strokec4  \cf11 \strokec11 WHEN\cf4 \strokec4  free_stories_used \cf12 \strokec12 >=\cf4 \strokec4  \cf13 \strokec13 2\cf4 \strokec4  \cf11 \strokec11 THEN\cf4 \strokec4  \cf13 \strokec13 1\cf4 \strokec4  \cf11 \strokec11 END\cf4 \strokec4 ) \cf11 \strokec11 AS\cf4 \strokec4  reached_story_2,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf12 \strokec12 COUNT\cf4 \strokec4 (\cf11 \strokec11 CASE\cf4 \strokec4  \cf11 \strokec11 WHEN\cf4 \strokec4  free_stories_used \cf12 \strokec12 >=\cf4 \strokec4  \cf13 \strokec13 3\cf4 \strokec4  \cf11 \strokec11 THEN\cf4 \strokec4  \cf13 \strokec13 1\cf4 \strokec4  \cf11 \strokec11 END\cf4 \strokec4 ) \cf11 \strokec11 AS\cf4 \strokec4  reached_story_3,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf12 \strokec12 COUNT\cf4 \strokec4 (\cf11 \strokec11 CASE\cf4 \strokec4  \cf11 \strokec11 WHEN\cf4 \strokec4  subscription_status \cf12 \strokec12 =\cf4 \strokec4  \cf14 \strokec14 'active'\cf4 \strokec4  \cf11 \strokec11 THEN\cf4 \strokec4  \cf13 \strokec13 1\cf4 \strokec4  \cf11 \strokec11 END\cf4 \strokec4 ) \cf11 \strokec11 AS\cf4 \strokec4  converted_to_paid,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf12 \strokec12 COUNT\cf4 \strokec4 (\cf11 \strokec11 CASE\cf4 \strokec4  \cf11 \strokec11 WHEN\cf4 \strokec4  free_stories_used \cf12 \strokec12 >=\cf4 \strokec4  \cf13 \strokec13 2\cf4 \strokec4  \cf11 \strokec11 THEN\cf4 \strokec4  \cf13 \strokec13 1\cf4 \strokec4  \cf11 \strokec11 END\cf4 \strokec4 )::\cf11 \strokec11 FLOAT\cf4 \strokec4  \cf12 \strokec12 /\cf4 \strokec4 \'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 NULLIF\cf4 \strokec4 (\cf12 \strokec12 COUNT\cf4 \strokec4 (\cf11 \strokec11 CASE\cf4 \strokec4  \cf11 \strokec11 WHEN\cf4 \strokec4  free_stories_used \cf12 \strokec12 >=\cf4 \strokec4  \cf13 \strokec13 1\cf4 \strokec4  \cf11 \strokec11 THEN\cf4 \strokec4  \cf13 \strokec13 1\cf4 \strokec4  \cf11 \strokec11 END\cf4 \strokec4 ), \cf13 \strokec13 0\cf4 \strokec4 ) \cf12 \strokec12 *\cf4 \strokec4  \cf13 \strokec13 100\cf4 \strokec4  \cf11 \strokec11 AS\cf4 \strokec4  story1_to_2_rate,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf12 \strokec12 COUNT\cf4 \strokec4 (\cf11 \strokec11 CASE\cf4 \strokec4  \cf11 \strokec11 WHEN\cf4 \strokec4  free_stories_used \cf12 \strokec12 >=\cf4 \strokec4  \cf13 \strokec13 3\cf4 \strokec4  \cf11 \strokec11 THEN\cf4 \strokec4  \cf13 \strokec13 1\cf4 \strokec4  \cf11 \strokec11 END\cf4 \strokec4 )::\cf11 \strokec11 FLOAT\cf4 \strokec4  \cf12 \strokec12 /\cf4 \strokec4 \'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 NULLIF\cf4 \strokec4 (\cf12 \strokec12 COUNT\cf4 \strokec4 (\cf11 \strokec11 CASE\cf4 \strokec4  \cf11 \strokec11 WHEN\cf4 \strokec4  free_stories_used \cf12 \strokec12 >=\cf4 \strokec4  \cf13 \strokec13 2\cf4 \strokec4  \cf11 \strokec11 THEN\cf4 \strokec4  \cf13 \strokec13 1\cf4 \strokec4  \cf11 \strokec11 END\cf4 \strokec4 ), \cf13 \strokec13 0\cf4 \strokec4 ) \cf12 \strokec12 *\cf4 \strokec4  \cf13 \strokec13 100\cf4 \strokec4  \cf11 \strokec11 AS\cf4 \strokec4  story2_to_3_rate,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf12 \strokec12 COUNT\cf4 \strokec4 (\cf11 \strokec11 CASE\cf4 \strokec4  \cf11 \strokec11 WHEN\cf4 \strokec4  subscription_status \cf12 \strokec12 =\cf4 \strokec4  \cf14 \strokec14 'active'\cf4 \strokec4  \cf11 \strokec11 THEN\cf4 \strokec4  \cf13 \strokec13 1\cf4 \strokec4  \cf11 \strokec11 END\cf4 \strokec4 )::\cf11 \strokec11 FLOAT\cf4 \strokec4  \cf12 \strokec12 /\cf4 \strokec4 \'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 NULLIF\cf4 \strokec4 (\cf12 \strokec12 COUNT\cf4 \strokec4 (\cf11 \strokec11 CASE\cf4 \strokec4  \cf11 \strokec11 WHEN\cf4 \strokec4  free_stories_used \cf12 \strokec12 >=\cf4 \strokec4  \cf13 \strokec13 3\cf4 \strokec4  \cf11 \strokec11 THEN\cf4 \strokec4  \cf13 \strokec13 1\cf4 \strokec4  \cf11 \strokec11 END\cf4 \strokec4 ), \cf13 \strokec13 0\cf4 \strokec4 ) \cf12 \strokec12 *\cf4 \strokec4  \cf13 \strokec13 100\cf4 \strokec4  \cf11 \strokec11 AS\cf4 \strokec4  story3_to_paid_rate
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf11 \strokec11 FROM\cf4 \strokec4  users
\f2 \cf0 \strokec2 \

\f3 \cf11 \strokec11 WHERE\cf4 \strokec4  created_at \cf12 \strokec12 >=\cf4 \strokec4  \cf14 \strokec14 '2025-01-01'\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- Targets:
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- Story 1 \uc0\u8594  2: \u8805  65%
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- Story 2 \uc0\u8594  3: \u8805  55%
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- Story 3 \uc0\u8594  Paid: \u8805  45%\
\pard\pardeftab720\partightenfactor0

\f2\i0 \cf0 \strokec2 \
\pard\pardeftab720\sa293\partightenfactor0

\f0\b\fs28 \cf0 \strokec2 10.2 Secondary Metrics
\f2\b0\fs24 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 Stories Per User Per Month
\f2\b0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf0 \strokec2 sql
\f2 \strokec2 \

\f3 \cf11 \strokec11 SELECT\cf4 \strokec4 \'a0
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0DATE_TRUNC(\cf14 \strokec14 'month'\cf4 \strokec4 , created_at) \cf11 \strokec11 AS\cf4 \strokec4  \cf11 \strokec11 month\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf12 \strokec12 COUNT\cf4 \strokec4 (\cf12 \strokec12 *\cf4 \strokec4 )::\cf11 \strokec11 FLOAT\cf4 \strokec4  \cf12 \strokec12 /\cf4 \strokec4  \cf12 \strokec12 COUNT\cf4 \strokec4 (\cf11 \strokec11 DISTINCT\cf4 \strokec4  user_id) \cf11 \strokec11 AS\cf4 \strokec4  avg_stories_per_user
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf11 \strokec11 FROM\cf4 \strokec4  stories
\f2 \cf0 \strokec2 \

\f3 \cf11 \strokec11 WHERE\cf4 \strokec4  created_at \cf12 \strokec12 >=\cf4 \strokec4  \cf12 \strokec12 NOW\cf4 \strokec4 () \cf12 \strokec12 -\cf4 \strokec4  \cf11 \strokec11 INTERVAL\cf4 \strokec4  \cf14 \strokec14 '6 months'
\f2 \cf0 \strokec2 \

\f3 \cf11 \strokec11 GROUP\cf4 \strokec4  \cf11 \strokec11 BY\cf4 \strokec4  \cf11 \strokec11 month
\f2 \cf0 \strokec2 \

\f3 \cf11 \strokec11 ORDER\cf4 \strokec4  \cf11 \strokec11 BY\cf4 \strokec4  \cf11 \strokec11 month\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- Target: \uc0\u8805  3 stories/user/month for active users\
\pard\pardeftab720\partightenfactor0

\f2\i0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 \strokec2 Days Between Recordings
\f2\b0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf0 \strokec2 sql
\f2 \strokec2 \

\f3 \cf11 \strokec11 WITH\cf4 \strokec4  story_gaps \cf11 \strokec11 AS\cf4 \strokec4  (
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 SELECT\cf4 \strokec4 \'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0user_id,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0created_at,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0LAG(created_at) \cf11 \strokec11 OVER\cf4 \strokec4  (\cf11 \strokec11 PARTITION\cf4 \strokec4  \cf11 \strokec11 BY\cf4 \strokec4  user_id \cf11 \strokec11 ORDER\cf4 \strokec4  \cf11 \strokec11 BY\cf4 \strokec4  created_at) \cf11 \strokec11 AS\cf4 \strokec4  prev_created_at,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0EXTRACT(EPOCH \cf11 \strokec11 FROM\cf4 \strokec4  (created_at \cf12 \strokec12 -\cf4 \strokec4  LAG(created_at) \cf11 \strokec11 OVER\cf4 \strokec4  (\cf11 \strokec11 PARTITION\cf4 \strokec4  \cf11 \strokec11 BY\cf4 \strokec4  user_id \cf11 \strokec11 ORDER\cf4 \strokec4  \cf11 \strokec11 BY\cf4 \strokec4  created_at))) \cf12 \strokec12 /\cf4 \strokec4  \cf13 \strokec13 86400\cf4 \strokec4  \cf11 \strokec11 AS\cf4 \strokec4  days_since_last
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 FROM\cf4 \strokec4  stories
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 )
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf11 \strokec11 SELECT\cf4 \strokec4 \'a0
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0\cf12 \strokec12 AVG\cf4 \strokec4 (days_since_last) \cf11 \strokec11 AS\cf4 \strokec4  avg_days_between_stories,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0PERCENTILE_CONT(\cf13 \strokec13 0.5\cf4 \strokec4 ) \cf11 \strokec11 WITHIN\cf4 \strokec4  \cf11 \strokec11 GROUP\cf4 \strokec4  (\cf11 \strokec11 ORDER\cf4 \strokec4  \cf11 \strokec11 BY\cf4 \strokec4  days_since_last) \cf11 \strokec11 AS\cf4 \strokec4  median_days
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf11 \strokec11 FROM\cf4 \strokec4  story_gaps
\f2 \cf0 \strokec2 \

\f3 \cf11 \strokec11 WHERE\cf4 \strokec4  days_since_last \cf12 \strokec12 IS\cf4 \strokec4  \cf12 \strokec12 NOT\cf4 \strokec4  \cf13 \strokec13 NULL\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- Target: \uc0\u8804  10 days average\
\pard\pardeftab720\partightenfactor0

\f2\i0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 \strokec2 Prompt Skip Rate
\f2\b0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf0 \strokec2 sql
\f2 \strokec2 \

\f3 \cf11 \strokec11 SELECT\cf4 \strokec4 \'a0
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0tier,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0memory_type,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf12 \strokec12 COUNT\cf4 \strokec4 (\cf12 \strokec12 *\cf4 \strokec4 ) \cf11 \strokec11 AS\cf4 \strokec4  total_skipped,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf12 \strokec12 AVG\cf4 \strokec4 (shown_count) \cf11 \strokec11 AS\cf4 \strokec4  avg_shows_before_skip
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf11 \strokec11 FROM\cf4 \strokec4  prompt_history
\f2 \cf0 \strokec2 \

\f3 \cf11 \strokec11 WHERE\cf4 \strokec4  outcome \cf12 \strokec12 =\cf4 \strokec4  \cf14 \strokec14 'skipped'
\f2 \cf0 \strokec2 \

\f3 \cf11 \strokec11 GROUP\cf4 \strokec4  \cf11 \strokec11 BY\cf4 \strokec4  tier, memory_type
\f2 \cf0 \strokec2 \

\f3 \cf11 \strokec11 ORDER\cf4 \strokec4  \cf11 \strokec11 BY\cf4 \strokec4  total_skipped \cf11 \strokec11 DESC\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- Target: < 2 skips before use\
\pard\pardeftab720\partightenfactor0

\f2\i0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 \strokec2 Active Prompt Inventory Health
\f2\b0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf0 \strokec2 sql
\f2 \strokec2 \

\f3 \cf11 \strokec11 SELECT\cf4 \strokec4 \'a0
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0user_id,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf12 \strokec12 COUNT\cf4 \strokec4 (\cf12 \strokec12 *\cf4 \strokec4 ) \cf11 \strokec11 AS\cf4 \strokec4  active_prompts,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf12 \strokec12 AVG\cf4 \strokec4 (prompt_score) \cf11 \strokec11 AS\cf4 \strokec4  avg_score,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf12 \strokec12 MAX\cf4 \strokec4 (expires_at) \cf11 \strokec11 AS\cf4 \strokec4  furthest_expiry
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf11 \strokec11 FROM\cf4 \strokec4  active_prompts
\f2 \cf0 \strokec2 \

\f3 \cf11 \strokec11 WHERE\cf4 \strokec4  expires_at \cf12 \strokec12 >\cf4 \strokec4  \cf12 \strokec12 NOW\cf4 \strokec4 ()
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0\cf12 \strokec12 AND\cf4 \strokec4  is_locked \cf12 \strokec12 =\cf4 \strokec4  \cf13 \strokec13 false
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf11 \strokec11 GROUP\cf4 \strokec4  \cf11 \strokec11 BY\cf4 \strokec4  user_id
\f2 \cf0 \strokec2 \

\f3 \cf11 \strokec11 HAVING\cf4 \strokec4  \cf12 \strokec12 COUNT\cf4 \strokec4 (\cf12 \strokec12 *\cf4 \strokec4 ) \cf12 \strokec12 >\cf4 \strokec4  \cf13 \strokec13 5\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- Target: 1-5 active prompts per user (not >5)\
\pard\pardeftab720\partightenfactor0

\f2\i0 \cf0 \strokec2 \
\pard\pardeftab720\sa293\partightenfactor0

\f0\b\fs28 \cf0 \strokec2 10.3 Quality Metrics
\f2\b0\fs24 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 Prompt Score Correlation with Conversion
\f2\b0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf0 \strokec2 sql
\f2 \strokec2 \

\f5\i \cf10 \strokec10 -- Does higher prompt_score actually lead to more "used" outcomes?
\f2\i0 \cf0 \strokec2 \

\f3 \cf11 \strokec11 SELECT\cf4 \strokec4 \'a0
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 CASE\cf4 \strokec4 \'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 WHEN\cf4 \strokec4  prompt_score \cf12 \strokec12 >=\cf4 \strokec4  \cf13 \strokec13 80\cf4 \strokec4  \cf11 \strokec11 THEN\cf4 \strokec4  \cf14 \strokec14 '80-100'
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 WHEN\cf4 \strokec4  prompt_score \cf12 \strokec12 >=\cf4 \strokec4  \cf13 \strokec13 60\cf4 \strokec4  \cf11 \strokec11 THEN\cf4 \strokec4  \cf14 \strokec14 '60-79'
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 WHEN\cf4 \strokec4  prompt_score \cf12 \strokec12 >=\cf4 \strokec4  \cf13 \strokec13 40\cf4 \strokec4  \cf11 \strokec11 THEN\cf4 \strokec4  \cf14 \strokec14 '40-59'
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 ELSE\cf4 \strokec4  \cf14 \strokec14 '0-39'
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 END\cf4 \strokec4  \cf11 \strokec11 AS\cf4 \strokec4  score_bucket,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf12 \strokec12 COUNT\cf4 \strokec4 (\cf11 \strokec11 CASE\cf4 \strokec4  \cf11 \strokec11 WHEN\cf4 \strokec4  outcome \cf12 \strokec12 =\cf4 \strokec4  \cf14 \strokec14 'used'\cf4 \strokec4  \cf11 \strokec11 THEN\cf4 \strokec4  \cf13 \strokec13 1\cf4 \strokec4  \cf11 \strokec11 END\cf4 \strokec4 )::\cf11 \strokec11 FLOAT\cf4 \strokec4  \cf12 \strokec12 /\cf4 \strokec4  \cf12 \strokec12 COUNT\cf4 \strokec4 (\cf12 \strokec12 *\cf4 \strokec4 ) \cf12 \strokec12 *\cf4 \strokec4  \cf13 \strokec13 100\cf4 \strokec4  \cf11 \strokec11 AS\cf4 \strokec4  conversion_rate
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf11 \strokec11 FROM\cf4 \strokec4  prompt_history
\f2 \cf0 \strokec2 \

\f3 \cf11 \strokec11 WHERE\cf4 \strokec4  tier \cf12 \strokec12 IN\cf4 \strokec4  (\cf13 \strokec13 2\cf4 \strokec4 , \cf13 \strokec13 3\cf4 \strokec4 )\'a0 
\f5\i \cf10 \strokec10 -- Only AI-generated prompts
\f2\i0 \cf0 \strokec2 \

\f3 \cf11 \strokec11 GROUP\cf4 \strokec4  \cf11 \strokec11 BY\cf4 \strokec4  score_bucket
\f2 \cf0 \strokec2 \

\f3 \cf11 \strokec11 ORDER\cf4 \strokec4  \cf11 \strokec11 BY\cf4 \strokec4  score_bucket \cf11 \strokec11 DESC\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- Expected: Higher scores \uc0\u8594  higher conversion
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- If not, scorer needs refinement\
\pard\pardeftab720\partightenfactor0

\f2\i0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 \strokec2 Tier Effectiveness
\f2\b0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf0 \strokec2 sql
\f2 \strokec2 \

\f3 \cf11 \strokec11 SELECT\cf4 \strokec4 \'a0
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0tier,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf12 \strokec12 COUNT\cf4 \strokec4 (\cf12 \strokec12 *\cf4 \strokec4 ) \cf11 \strokec11 AS\cf4 \strokec4  total_generated,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf12 \strokec12 COUNT\cf4 \strokec4 (\cf11 \strokec11 CASE\cf4 \strokec4  \cf11 \strokec11 WHEN\cf4 \strokec4  outcome \cf12 \strokec12 =\cf4 \strokec4  \cf14 \strokec14 'used'\cf4 \strokec4  \cf11 \strokec11 THEN\cf4 \strokec4  \cf13 \strokec13 1\cf4 \strokec4  \cf11 \strokec11 END\cf4 \strokec4 ) \cf11 \strokec11 AS\cf4 \strokec4  used,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf12 \strokec12 COUNT\cf4 \strokec4 (\cf11 \strokec11 CASE\cf4 \strokec4  \cf11 \strokec11 WHEN\cf4 \strokec4  outcome \cf12 \strokec12 =\cf4 \strokec4  \cf14 \strokec14 'skipped'\cf4 \strokec4  \cf11 \strokec11 THEN\cf4 \strokec4  \cf13 \strokec13 1\cf4 \strokec4  \cf11 \strokec11 END\cf4 \strokec4 ) \cf11 \strokec11 AS\cf4 \strokec4  skipped,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf12 \strokec12 COUNT\cf4 \strokec4 (\cf11 \strokec11 CASE\cf4 \strokec4  \cf11 \strokec11 WHEN\cf4 \strokec4  outcome \cf12 \strokec12 =\cf4 \strokec4  \cf14 \strokec14 'expired'\cf4 \strokec4  \cf11 \strokec11 THEN\cf4 \strokec4  \cf13 \strokec13 1\cf4 \strokec4  \cf11 \strokec11 END\cf4 \strokec4 ) \cf11 \strokec11 AS\cf4 \strokec4  expired,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf12 \strokec12 AVG\cf4 \strokec4 (prompt_score) \cf11 \strokec11 AS\cf4 \strokec4  avg_score
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf11 \strokec11 FROM\cf4 \strokec4  prompt_history
\f2 \cf0 \strokec2 \

\f3 \cf11 \strokec11 GROUP\cf4 \strokec4  \cf11 \strokec11 BY\cf4 \strokec4  tier
\f2 \cf0 \strokec2 \

\f3 \cf11 \strokec11 ORDER\cf4 \strokec4  \cf11 \strokec11 BY\cf4 \strokec4  tier;
\f2 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- Insights:
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- High expiry rate \uc0\u8594  increase expiry window
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- High skip rate \uc0\u8594  improve prompt quality
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- Low usage \uc0\u8594  wrong prompts being generated
\f2\i0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 \strokec2 Memory Type Performance
\f2\b0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf0 \strokec2 sql
\f2 \strokec2 \

\f3 \cf11 \strokec11 SELECT\cf4 \strokec4 \'a0
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0memory_type,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf12 \strokec12 COUNT\cf4 \strokec4 (\cf12 \strokec12 *\cf4 \strokec4 ) \cf11 \strokec11 AS\cf4 \strokec4  total,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf12 \strokec12 COUNT\cf4 \strokec4 (\cf11 \strokec11 CASE\cf4 \strokec4  \cf11 \strokec11 WHEN\cf4 \strokec4  outcome \cf12 \strokec12 =\cf4 \strokec4  \cf14 \strokec14 'used'\cf4 \strokec4  \cf11 \strokec11 THEN\cf4 \strokec4  \cf13 \strokec13 1\cf4 \strokec4  \cf11 \strokec11 END\cf4 \strokec4 )::\cf11 \strokec11 FLOAT\cf4 \strokec4  \cf12 \strokec12 /\cf4 \strokec4  \cf12 \strokec12 COUNT\cf4 \strokec4 (\cf12 \strokec12 *\cf4 \strokec4 ) \cf12 \strokec12 *\cf4 \strokec4  \cf13 \strokec13 100\cf4 \strokec4  \cf11 \strokec11 AS\cf4 \strokec4  conversion_rate,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf12 \strokec12 AVG\cf4 \strokec4 (prompt_score) \cf11 \strokec11 AS\cf4 \strokec4  avg_score
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf11 \strokec11 FROM\cf4 \strokec4  prompt_history
\f2 \cf0 \strokec2 \

\f3 \cf11 \strokec11 WHERE\cf4 \strokec4  tier \cf12 \strokec12 =\cf4 \strokec4  \cf13 \strokec13 1\cf4 \strokec4 \'a0 
\f5\i \cf10 \strokec10 -- Templates only
\f2\i0 \cf0 \strokec2 \

\f3 \cf11 \strokec11 GROUP\cf4 \strokec4  \cf11 \strokec11 BY\cf4 \strokec4  memory_type
\f2 \cf0 \strokec2 \

\f3 \cf11 \strokec11 ORDER\cf4 \strokec4  \cf11 \strokec11 BY\cf4 \strokec4  conversion_rate \cf11 \strokec11 DESC\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- Identifies which template types work best
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- Retire low-performing templates\
\pard\pardeftab720\partightenfactor0

\f2\i0 \cf0 \strokec2 \
\pard\pardeftab720\sa293\partightenfactor0

\f0\b\fs28 \cf0 \strokec2 10.4 Business Impact Metrics
\f2\b0\fs24 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 Incremental Revenue from AI Prompts
\f2\b0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf0 \strokec2 sql
\f2 \strokec2 \

\f5\i \cf10 \strokec10 -- Compare conversion rates: users who saw AI prompts vs control
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- (Requires A/B test setup)
\f2\i0 \cf0 \strokec2 \

\f3 \cf11 \strokec11 SELECT\cf4 \strokec4 \'a0
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 CASE\cf4 \strokec4  \cf11 \strokec11 WHEN\cf4 \strokec4  saw_tier3_prompt \cf11 \strokec11 THEN\cf4 \strokec4  \cf14 \strokec14 'With AI'\cf4 \strokec4  \cf11 \strokec11 ELSE\cf4 \strokec4  \cf14 \strokec14 'Control'\cf4 \strokec4  \cf11 \strokec11 END\cf4 \strokec4  \cf11 \strokec11 AS\cf4 \strokec4  cohort,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf12 \strokec12 COUNT\cf4 \strokec4 (\cf12 \strokec12 *\cf4 \strokec4 ) \cf11 \strokec11 AS\cf4 \strokec4  users,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf12 \strokec12 COUNT\cf4 \strokec4 (\cf11 \strokec11 CASE\cf4 \strokec4  \cf11 \strokec11 WHEN\cf4 \strokec4  subscription_status \cf12 \strokec12 =\cf4 \strokec4  \cf14 \strokec14 'active'\cf4 \strokec4  \cf11 \strokec11 THEN\cf4 \strokec4  \cf13 \strokec13 1\cf4 \strokec4  \cf11 \strokec11 END\cf4 \strokec4 ) \cf11 \strokec11 AS\cf4 \strokec4  conversions,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf12 \strokec12 COUNT\cf4 \strokec4 (\cf11 \strokec11 CASE\cf4 \strokec4  \cf11 \strokec11 WHEN\cf4 \strokec4  subscription_status \cf12 \strokec12 =\cf4 \strokec4  \cf14 \strokec14 'active'\cf4 \strokec4  \cf11 \strokec11 THEN\cf4 \strokec4  \cf13 \strokec13 1\cf4 \strokec4  \cf11 \strokec11 END\cf4 \strokec4 )::\cf11 \strokec11 FLOAT\cf4 \strokec4  \cf12 \strokec12 /\cf4 \strokec4  \cf12 \strokec12 COUNT\cf4 \strokec4 (\cf12 \strokec12 *\cf4 \strokec4 ) \cf12 \strokec12 *\cf4 \strokec4  \cf13 \strokec13 100\cf4 \strokec4  \cf11 \strokec11 AS\cf4 \strokec4  conversion_rate
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf11 \strokec11 FROM\cf4 \strokec4  (
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 SELECT\cf4 \strokec4 \'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0u.id,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0u.subscription_status,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 EXISTS\cf4 \strokec4 (
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf11 \strokec11 SELECT\cf4 \strokec4  \cf13 \strokec13 1\cf4 \strokec4  \cf11 \strokec11 FROM\cf4 \strokec4  prompt_history ph\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\cf11 \strokec11 WHERE\cf4 \strokec4  ph.user_id \cf12 \strokec12 =\cf4 \strokec4  u.id \cf12 \strokec12 AND\cf4 \strokec4  ph.tier \cf12 \strokec12 =\cf4 \strokec4  \cf13 \strokec13 3\cf4 \strokec4  \cf12 \strokec12 AND\cf4 \strokec4  ph.outcome \cf12 \strokec12 =\cf4 \strokec4  \cf14 \strokec14 'used'
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0) \cf11 \strokec11 AS\cf4 \strokec4  saw_tier3_prompt
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 FROM\cf4 \strokec4  users u
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf11 \strokec11 WHERE\cf4 \strokec4  u.created_at \cf12 \strokec12 >=\cf4 \strokec4  \cf14 \strokec14 '2025-01-01'
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 ) cohorts
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf11 \strokec11 GROUP\cf4 \strokec4  \cf11 \strokec11 BY\cf4 \strokec4  cohort;
\f2 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- Calculate lift:
\f2\i0 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- (With AI conversion rate - Control conversion rate) / Control conversion rate * 100\
\pard\pardeftab720\partightenfactor0

\f2\i0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 \strokec2 Cost Per Conversion
\f2\b0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf0 \strokec2 sql
\f2 \strokec2 \

\f5\i \cf10 \strokec10 -- Assume $1,757 annual AI cost for 1,000 paid users
\f2\i0 \cf0 \strokec2 \

\f3 \cf11 \strokec11 SELECT\cf4 \strokec4 \'a0
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0\cf12 \strokec12 COUNT\cf4 \strokec4 (\cf11 \strokec11 CASE\cf4 \strokec4  \cf11 \strokec11 WHEN\cf4 \strokec4  subscription_status \cf12 \strokec12 =\cf4 \strokec4  \cf14 \strokec14 'active'\cf4 \strokec4  \cf11 \strokec11 THEN\cf4 \strokec4  \cf13 \strokec13 1\cf4 \strokec4  \cf11 \strokec11 END\cf4 \strokec4 ) \cf11 \strokec11 AS\cf4 \strokec4  paid_users,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf13 \strokec13 1757.0\cf4 \strokec4  \cf12 \strokec12 /\cf4 \strokec4  \cf11 \strokec11 NULLIF\cf4 \strokec4 (\cf12 \strokec12 COUNT\cf4 \strokec4 (\cf11 \strokec11 CASE\cf4 \strokec4  \cf11 \strokec11 WHEN\cf4 \strokec4  subscription_status \cf12 \strokec12 =\cf4 \strokec4  \cf14 \strokec14 'active'\cf4 \strokec4  \cf11 \strokec11 THEN\cf4 \strokec4  \cf13 \strokec13 1\cf4 \strokec4  \cf11 \strokec11 END\cf4 \strokec4 ), \cf13 \strokec13 0\cf4 \strokec4 ) \cf11 \strokec11 AS\cf4 \strokec4  cost_per_paid_user
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf11 \strokec11 FROM\cf4 \strokec4  users;
\f2 \cf0 \strokec2 \

\f5\i \cf10 \strokec10 -- Target: < $2.00 per paid user\
\pard\pardeftab720\partightenfactor0

\f2\i0 \cf0 \strokec2 \
\pard\pardeftab720\sa293\partightenfactor0

\f0\b\fs28 \cf0 \strokec2 10.5 Dashboard Queries
\f2\b0\fs24 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 Weekly Health Check
\f2\b0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf0 \strokec2 sql
\f2 \strokec2 \

\f5\i \cf10 \strokec10 -- Run every Monday
\f2\i0 \cf0 \strokec2 \

\f3 \cf11 \strokec11 SELECT\cf4 \strokec4 \'a0
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0\cf14 \strokec14 'Prompt Conversion'\cf4 \strokec4  \cf11 \strokec11 AS\cf4 \strokec4  metric,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0(\cf11 \strokec11 SELECT\cf4 \strokec4  \cf12 \strokec12 AVG\cf4 \strokec4 (\cf11 \strokec11 CASE\cf4 \strokec4  \cf11 \strokec11 WHEN\cf4 \strokec4  outcome \cf12 \strokec12 =\cf4 \strokec4  \cf14 \strokec14 'used'\cf4 \strokec4  \cf11 \strokec11 THEN\cf4 \strokec4  \cf13 \strokec13 1.0\cf4 \strokec4  \cf11 \strokec11 ELSE\cf4 \strokec4  \cf13 \strokec13 0.0\cf4 \strokec4  \cf11 \strokec11 END\cf4 \strokec4 ) \cf12 \strokec12 *\cf4 \strokec4  \cf13 \strokec13 100\cf4 \strokec4 \'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\cf11 \strokec11 FROM\cf4 \strokec4  prompt_history\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\cf11 \strokec11 WHERE\cf4 \strokec4  created_at \cf12 \strokec12 >=\cf4 \strokec4  \cf12 \strokec12 NOW\cf4 \strokec4 () \cf12 \strokec12 -\cf4 \strokec4  \cf11 \strokec11 INTERVAL\cf4 \strokec4  \cf14 \strokec14 '7 days'\cf4 \strokec4 ) \cf11 \strokec11 AS\cf4 \strokec4  \cf11 \strokec11 value\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf13 \strokec13 70.0\cf4 \strokec4  \cf11 \strokec11 AS\cf4 \strokec4  target
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf11 \strokec11 UNION\cf4 \strokec4  \cf11 \strokec11 ALL
\f2 \cf0 \strokec2 \

\f3 \cf11 \strokec11 SELECT\cf4 \strokec4 \'a0
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0\cf14 \strokec14 'Free Tier Conversion'\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0(\cf11 \strokec11 SELECT\cf4 \strokec4  \cf12 \strokec12 COUNT\cf4 \strokec4 (\cf11 \strokec11 CASE\cf4 \strokec4  \cf11 \strokec11 WHEN\cf4 \strokec4  subscription_status \cf12 \strokec12 =\cf4 \strokec4  \cf14 \strokec14 'active'\cf4 \strokec4  \cf11 \strokec11 THEN\cf4 \strokec4  \cf13 \strokec13 1\cf4 \strokec4  \cf11 \strokec11 END\cf4 \strokec4 )::\cf11 \strokec11 FLOAT\cf4 \strokec4  \cf12 \strokec12 /\cf4 \strokec4 \'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\cf11 \strokec11 NULLIF\cf4 \strokec4 (\cf12 \strokec12 COUNT\cf4 \strokec4 (\cf11 \strokec11 CASE\cf4 \strokec4  \cf11 \strokec11 WHEN\cf4 \strokec4  free_stories_used \cf12 \strokec12 >=\cf4 \strokec4  \cf13 \strokec13 3\cf4 \strokec4  \cf11 \strokec11 THEN\cf4 \strokec4  \cf13 \strokec13 1\cf4 \strokec4  \cf11 \strokec11 END\cf4 \strokec4 ), \cf13 \strokec13 0\cf4 \strokec4 ) \cf12 \strokec12 *\cf4 \strokec4  \cf13 \strokec13 100
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\cf11 \strokec11 FROM\cf4 \strokec4  users\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\cf11 \strokec11 WHERE\cf4 \strokec4  created_at \cf12 \strokec12 >=\cf4 \strokec4  \cf12 \strokec12 NOW\cf4 \strokec4 () \cf12 \strokec12 -\cf4 \strokec4  \cf11 \strokec11 INTERVAL\cf4 \strokec4  \cf14 \strokec14 '7 days'\cf4 \strokec4 ),
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf13 \strokec13 45.0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf11 \strokec11 UNION\cf4 \strokec4  \cf11 \strokec11 ALL
\f2 \cf0 \strokec2 \

\f3 \cf11 \strokec11 SELECT\cf4 \strokec4 \'a0
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0\cf14 \strokec14 'Stories Per User'\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0(\cf11 \strokec11 SELECT\cf4 \strokec4  \cf12 \strokec12 COUNT\cf4 \strokec4 (\cf12 \strokec12 *\cf4 \strokec4 )::\cf11 \strokec11 FLOAT\cf4 \strokec4  \cf12 \strokec12 /\cf4 \strokec4  \cf11 \strokec11 NULLIF\cf4 \strokec4 (\cf12 \strokec12 COUNT\cf4 \strokec4 (\cf11 \strokec11 DISTINCT\cf4 \strokec4  user_id), \cf13 \strokec13 0\cf4 \strokec4 )
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\cf11 \strokec11 FROM\cf4 \strokec4  stories\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\cf11 \strokec11 WHERE\cf4 \strokec4  created_at \cf12 \strokec12 >=\cf4 \strokec4  \cf12 \strokec12 NOW\cf4 \strokec4 () \cf12 \strokec12 -\cf4 \strokec4  \cf11 \strokec11 INTERVAL\cf4 \strokec4  \cf14 \strokec14 '30 days'\cf4 \strokec4 ),
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf13 \strokec13 3.0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf11 \strokec11 UNION\cf4 \strokec4  \cf11 \strokec11 ALL
\f2 \cf0 \strokec2 \

\f3 \cf11 \strokec11 SELECT\cf4 \strokec4 \'a0
\f2 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0

\f3 \cf4 \strokec4 \'a0\'a0\cf14 \strokec14 'Active Prompts'\cf4 \strokec4 ,
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0(\cf11 \strokec11 SELECT\cf4 \strokec4  \cf12 \strokec12 AVG\cf4 \strokec4 (cnt) \cf11 \strokec11 FROM\cf4 \strokec4  (
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 SELECT\cf4 \strokec4  \cf12 \strokec12 COUNT\cf4 \strokec4 (\cf12 \strokec12 *\cf4 \strokec4 ) \cf11 \strokec11 AS\cf4 \strokec4  cnt \cf11 \strokec11 FROM\cf4 \strokec4  active_prompts\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 WHERE\cf4 \strokec4  expires_at \cf12 \strokec12 >\cf4 \strokec4  \cf12 \strokec12 NOW\cf4 \strokec4 ()\'a0
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\'a0\'a0\cf11 \strokec11 GROUP\cf4 \strokec4  \cf11 \strokec11 BY\cf4 \strokec4  user_id
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0) x),
\f2 \cf0 \strokec2 \

\f3 \cf4 \strokec4 \'a0\'a0\cf13 \strokec13 3.0\cf4 \strokec4 ;
\f2 \cf0 \strokec2 \
\
\
\pard\pardeftab720\sa106\partightenfactor0

\f0\b\fs34\fsmilli17333 \cf0 \strokec2 10.6 Lesson Quality Metrics
\f1\fs28 \
\pard\pardeftab720\sa320\partightenfactor0

\f0\fs24 \cf0 New metrics for lesson extraction feature
\f2\b0 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf0 sql
\f2\b0 \strokec2 \

\f4\i\b \cf5 \strokec5 -- Lesson acceptance rate (how often users keep AI suggestion)
\f2\i0\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf6 \strokec6 SELECT\cf3 \strokec3 \'a0
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf3 \strokec3 \'a0\'a0DATE_TRUNC(\cf8 \strokec8 'week'\cf3 \strokec3 , created_at) \cf6 \strokec6 AS\cf3 \strokec3  week,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf7 \strokec7 COUNT\cf3 \strokec3 (\cf7 \strokec7 *\cf3 \strokec3 ) \cf6 \strokec6 AS\cf3 \strokec3  total_stories,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf7 \strokec7 COUNT\cf3 \strokec3 (\cf6 \strokec6 CASE\cf3 \strokec3  \cf6 \strokec6 WHEN\cf3 \strokec3  lesson_learned \cf7 \strokec7 =\cf3 \strokec3  lesson_suggested \cf6 \strokec6 THEN\cf3 \strokec3  \cf9 \strokec9 1\cf3 \strokec3  \cf6 \strokec6 END\cf3 \strokec3 ) \cf6 \strokec6 AS\cf3 \strokec3  kept_suggestion,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf7 \strokec7 COUNT\cf3 \strokec3 (\cf6 \strokec6 CASE\cf3 \strokec3  \cf6 \strokec6 WHEN\cf3 \strokec3  lesson_learned \cf7 \strokec7 !=\cf3 \strokec3  lesson_suggested \cf6 \strokec6 THEN\cf3 \strokec3  \cf9 \strokec9 1\cf3 \strokec3  \cf6 \strokec6 END\cf3 \strokec3 ) \cf6 \strokec6 AS\cf3 \strokec3  edited,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf7 \strokec7 COUNT\cf3 \strokec3 (\cf6 \strokec6 CASE\cf3 \strokec3  \cf6 \strokec6 WHEN\cf3 \strokec3  lesson_learned \cf7 \strokec7 IS\cf3 \strokec3  \cf9 \strokec9 NULL\cf3 \strokec3  \cf6 \strokec6 THEN\cf3 \strokec3  \cf9 \strokec9 1\cf3 \strokec3  \cf6 \strokec6 END\cf3 \strokec3 ) \cf6 \strokec6 AS\cf3 \strokec3  no_lesson,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf7 \strokec7 COUNT\cf3 \strokec3 (\cf6 \strokec6 CASE\cf3 \strokec3  \cf6 \strokec6 WHEN\cf3 \strokec3  lesson_learned \cf7 \strokec7 =\cf3 \strokec3  lesson_suggested \cf6 \strokec6 THEN\cf3 \strokec3  \cf9 \strokec9 1\cf3 \strokec3  \cf6 \strokec6 END\cf3 \strokec3 )::\cf6 \strokec6 FLOAT\cf3 \strokec3  \cf7 \strokec7 /\cf3 \strokec3 \'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0\cf6 \strokec6 NULLIF\cf3 \strokec3 (\cf7 \strokec7 COUNT\cf3 \strokec3 (\cf7 \strokec7 *\cf3 \strokec3 ), \cf9 \strokec9 0\cf3 \strokec3 ) \cf7 \strokec7 *\cf3 \strokec3  \cf9 \strokec9 100\cf3 \strokec3  \cf6 \strokec6 AS\cf3 \strokec3  acceptance_rate
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\'a0\'a0
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf6 \strokec6 FROM\cf3 \strokec3  stories
\f2\b0 \cf0 \strokec2 \

\f0\b \cf6 \strokec6 WHERE\cf3 \strokec3  created_at \cf7 \strokec7 >=\cf3 \strokec3  \cf7 \strokec7 NOW\cf3 \strokec3 () \cf7 \strokec7 -\cf3 \strokec3  \cf6 \strokec6 INTERVAL\cf3 \strokec3  \cf8 \strokec8 '30 days'
\f2\b0 \cf0 \strokec2 \

\f0\b \cf6 \strokec6 GROUP\cf3 \strokec3  \cf6 \strokec6 BY\cf3 \strokec3  week
\f2\b0 \cf0 \strokec2 \

\f0\b \cf6 \strokec6 ORDER\cf3 \strokec3  \cf6 \strokec6 BY\cf3 \strokec3  week \cf6 \strokec6 DESC\cf3 \strokec3 ;
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0
\cf0 \
\pard\pardeftab720\sa240\partightenfactor0

\f4\i\b \cf5 \strokec5 -- Target: 40% keep as-is, 50% edit slightly, 10% write from scratch
\f2\i0\b0 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0
\cf0 \
\pard\pardeftab720\sa240\partightenfactor0

\f4\i\b \cf5 \strokec5 -- Character trait confidence over time
\f2\i0\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf6 \strokec6 SELECT\cf3 \strokec3 \'a0
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf3 \strokec3 \'a0\'a0user_id,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0story_count,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf7 \strokec7 AVG\cf3 \strokec3 ((traits\cf7 \strokec7 ->>\cf8 \strokec8 'confidence'\cf3 \strokec3 )::\cf6 \strokec6 FLOAT\cf3 \strokec3 ) \cf6 \strokec6 AS\cf3 \strokec3  avg_confidence,
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0\cf7 \strokec7 COUNT\cf3 \strokec3 (\cf6 \strokec6 DISTINCT\cf3 \strokec3  traits\cf7 \strokec7 ->>\cf8 \strokec8 'trait'\cf3 \strokec3 ) \cf6 \strokec6 AS\cf3 \strokec3  unique_traits
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf6 \strokec6 FROM\cf3 \strokec3  character_evolution
\f2\b0 \cf0 \strokec2 \

\f0\b \cf6 \strokec6 GROUP\cf3 \strokec3  \cf6 \strokec6 BY\cf3 \strokec3  user_id, story_count
\f2\b0 \cf0 \strokec2 \

\f0\b \cf6 \strokec6 ORDER\cf3 \strokec3  \cf6 \strokec6 BY\cf3 \strokec3  story_count;
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0
\cf0 \
\pard\pardeftab720\sa240\partightenfactor0

\f4\i\b \cf5 \strokec5 -- Target: Confidence increases with story count
\f2\i0\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa160\partightenfactor0

\f4\i\b \cf5 \strokec5 -- Story 3: 0.5-0.6, Story 10: 0.7-0.8, Story 20: 0.8-0.9\
\pard\pardeftab720\sa160\partightenfactor0

\f2\i0\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa106\partightenfactor0

\f0\b\fs45\fsmilli22667 \cf0 11. COST MODEL & BUDGET
\f1\fs36 \
\pard\pardeftab720\sa106\partightenfactor0

\f0\fs34\fsmilli17333 \cf0 11.1 Free Tier Costs
\f1\fs28 \
\pard\pardeftab720\sa320\partightenfactor0

\f0\fs24 \cf0 Updated to include lesson extraction
\f2\b0 \

\f0\b Assumptions:
\f2\b0 \
\pard\tx220\tx720\pardeftab720\li720\fi-720\partightenfactor0
\ls9\ilvl0
\f0\b \cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 10,000 signups/year\
\ls9\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 80% record Story 1 = 8,000 users\
\ls9\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 65% record Story 2 = 5,200 users\
\pard\tx220\tx720\pardeftab720\li720\fi-720\sa320\partightenfactor0
\ls9\ilvl0\cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 55% record Story 3 = 2,860 users\
\pard\pardeftab720\sa320\partightenfactor0
\cf0 OpenAI API Costs:
\f2\b0 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf3 \strokec3 Lesson Extraction (Immediate):
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0- 8,000 Story 1s \'d7 $0.002 (gpt-4o quick lesson) = $16.00
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0- 5,200 Story 2s \'d7 $0.002 = $10.40
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0- 2,860 Story 3s \'d7 $0.002 = $5.72
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0Subtotal Lessons: $32.12
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0
\cf0 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf3 \strokec3 Combined Analysis at Milestones:
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0- Story 1: 8,000 \'d7 $0.006 (prompts + character) = $48.00
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0- Story 2: 5,200 \'d7 $0.008 = $41.60
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0- Story 3: 2,860 \'d7 $0.010 = $28.60
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \'a0\'a0Subtotal Analysis: $118.20
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0
\cf0 \
\pard\pardeftab720\sa160\partightenfactor0

\f0\b \cf3 \strokec3 TOTAL FREE TIER: $150.32/year\

\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa106\partightenfactor0

\f0\b\fs34\fsmilli17333 \cf0 11.2 Paid Tier Costs
\f1\fs28 \
\pard\pardeftab720\sa320\partightenfactor0

\f0\fs24 \cf0 Updated with lesson extraction
\f2\b0 \

\f0\b Assumptions:
\f2\b0 \
\pard\tx220\tx720\pardeftab720\li720\fi-720\partightenfactor0
\ls10\ilvl0
\f0\b \cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 1,287 paid users (45% conversion from Story 3)\
\pard\tx220\tx720\pardeftab720\li720\fi-720\sa320\partightenfactor0
\ls10\ilvl0\cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Average 30 stories/user/year\
\pard\pardeftab720\sa320\partightenfactor0
\cf0 Tier 1 (Templates):
\f2\b0 \
\pard\pardeftab720\sa160\partightenfactor0

\f0\b \cf3 \strokec3 Cost: $0 (no API calls)
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa320\partightenfactor0

\f0\b \cf0 Lesson Extraction:
\f2\b0 \
\pard\pardeftab720\sa160\partightenfactor0

\f0\b \cf3 \strokec3 All stories: 1,287 users \'d7 30 stories \'d7 $0.002 = $77.22/year
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa320\partightenfactor0

\f0\b \cf0 Tier 2 (On-Demand):
\f2\b0 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf3 \strokec3 Frequency: 2-3x per month per user = ~30 calls/user/year
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 Cost per call: $0.05 (GPT-4o, 5 stories analyzed)
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa160\partightenfactor0

\f0\b \cf3 \strokec3 1,287 users \'d7 30 calls \'d7 $0.05 = $1,930.50/year
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa320\partightenfactor0

\f0\b \cf0 Tier 3 (Combined Analysis):
\f2\b0 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf3 \strokec3 Milestones per user (average):
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 - Story 4: 1,287 users \'d7 $0.012 = $15.44
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 - Story 7: 1,100 users \'d7 $0.018 = $19.80
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 - Story 10: 950 users \'d7 $0.024 = $22.80
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 - Story 15: 800 users \'d7 $0.030 = $24.00
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 - Story 20: 650 users \'d7 $0.036 = $23.40
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 - Story 30: 400 users \'d7 $0.054 = $21.60
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 - Story 50: 200 users \'d7 $0.090 = $18.00
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 - Story 100: 80 users \'d7 $0.156 = $12.48
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0
\cf0 \
\pard\pardeftab720\sa160\partightenfactor0

\f0\b \cf3 \strokec3 TOTAL TIER 3: $157.52/year
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa320\partightenfactor0

\f0\b \cf0 Total Paid Tier: $77.22 + $1,930.50 + $157.52 = $2,165.24/year
\f2\b0 \
\pard\pardeftab720\sa106\partightenfactor0

\f0\b\fs34\fsmilli17333 \cf0 11.3 Total Annual Budget
\f1\fs28 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\fs24 \cf3 \strokec3 Free Tier:\'a0 \'a0 \'a0 $150.32
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 Paid Tier:\'a0 \'a0 \'a0 $2,165.24
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \uc0\u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 TOTAL:\'a0 \'a0 \'a0 \'a0 \'a0 $2,315.56/year
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0
\cf0 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf3 \strokec3 Revenue (1,287 paid users \'d7 $149):\'a0 $191,763
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 AI Cost as % of Revenue:\'a0 \'a0 \'a0 \'a0 \'a0 \'a0 1.21%
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa160\partightenfactor0

\f0\b \cf3 \strokec3 Cost Per Paid User: \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 $1.80/year\

\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa106\partightenfactor0

\f0\b\fs34\fsmilli17333 \cf0 11.4 Scaling Projections
\f1\fs28 \
\pard\pardeftab720\sa320\partightenfactor0

\f0\fs24 \cf0 At 10,000 Paid Users:
\f2\b0 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf3 \strokec3 Free Tier (100k signups): \'a0 $1,503
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 Paid Tier (10k users):\'a0 \'a0 \'a0 $21,652
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \uc0\u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 TOTAL:\'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 $23,155/year
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0
\cf0 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf3 \strokec3 Revenue (10k \'d7 $149): \'a0 \'a0 \'a0 $1,490,000
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa160\partightenfactor0

\f0\b \cf3 \strokec3 AI Cost as % of Revenue:\'a0 \'a0 1.55%
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa320\partightenfactor0

\f0\b \cf0 At 100,000 Paid Users:
\f2\b0 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf3 \strokec3 Free Tier (1M signups): \'a0 \'a0 $15,032
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 Paid Tier (100k users): \'a0 \'a0 $216,524
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 \uc0\u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 
\f2\b0 \cf0 \strokec2 \

\f0\b \cf3 \strokec3 TOTAL:\'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 \'a0 $231,556/year
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\partightenfactor0
\cf0 \
\pard\pardeftab720\sa240\partightenfactor0

\f0\b \cf3 \strokec3 Revenue (100k \'d7 $149):\'a0 \'a0 \'a0 $14,900,000
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa160\partightenfactor0

\f0\b \cf3 \strokec3 AI Cost as % of Revenue:\'a0 \'a0 1.55%
\f2\b0 \cf0 \strokec2 \
\pard\pardeftab720\sa320\partightenfactor0

\f0\b \cf0 Cost scales linearly, never exceeds 1.6% of revenue.
\f2\b0 \
\pard\pardeftab720\sa106\partightenfactor0

\f0\b\fs34\fsmilli17333 \cf0 11.5 Cost Optimization Opportunities
\f1\fs28 \
\pard\pardeftab720\sa320\partightenfactor0

\f0\fs24 \cf0 If budget becomes a concern:
\f2\b0 \
\pard\tx220\tx720\pardeftab720\li720\fi-720\partightenfactor0
\ls11\ilvl0
\f0\b \cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	1	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Use GPT-4o-mini for formatting (keep GPT-4o for lessons)\
\pard\tx940\tx1440\pardeftab720\li1440\fi-1440\partightenfactor0
\ls11\ilvl1\cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u9702 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Saves ~$500/year at 1,287 users\
\pard\tx220\tx720\pardeftab720\li720\fi-720\partightenfactor0
\ls11\ilvl0\cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	2	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Cache common lessons for similar stories\
\pard\tx940\tx1440\pardeftab720\li1440\fi-1440\partightenfactor0
\ls11\ilvl1\cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u9702 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Saves ~$300/year at 1,287 users\
\pard\tx220\tx720\pardeftab720\li720\fi-720\partightenfactor0
\ls11\ilvl0\cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	3	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Batch milestone processing (process 2-3 users at once)\
\pard\tx940\tx1440\pardeftab720\li1440\fi-1440\sa320\partightenfactor0
\ls11\ilvl1\cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u9702 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Saves ~$200/year at 1,287 users\
\pard\pardeftab720\sa320\partightenfactor0
\cf0 Recommendation: Don't optimize yet. Current cost (1.21% of revenue) is negligible.
\f2\b0 \
\pard\pardeftab720\sa106\partightenfactor0

\f0\b\fs45\fsmilli22667 \cf0 12. IMPLEMENTATION CHECKLIST
\f1\fs36 \
\pard\pardeftab720\sa106\partightenfactor0

\f0\fs34\fsmilli17333 \cf0 Phase 1: Foundation (Week 1)
\f1\fs28 \
\pard\pardeftab720\sa320\partightenfactor0

\f0\fs24 \cf0 Database:
\f2\b0 \
\pard\tx220\tx720\pardeftab720\li720\fi-720\partightenfactor0
\ls12\ilvl0
\f0\b \cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Add active_prompts table\
\ls12\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Add prompt_history table\
\ls12\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Add character_evolution table\
\ls12\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Add columns to users table\
\ls12\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Add columns to stories table (lesson_learned, character_insights)\
\ls12\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Create indexes\
\pard\tx220\tx720\pardeftab720\li720\fi-720\sa320\partightenfactor0
\ls12\ilvl0\cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Create cleanup function\
\pard\pardeftab720\sa320\partightenfactor0
\cf0 Tier 1 Templates:
\f2\b0 \
\pard\tx220\tx720\pardeftab720\li720\fi-720\partightenfactor0
\ls13\ilvl0
\f0\b \cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Build entity extraction\
\ls13\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Build template library\
\ls13\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Build template matching function\
\ls13\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Build anchor hash generator\
\pard\tx220\tx720\pardeftab720\li720\fi-720\sa320\partightenfactor0
\ls13\ilvl0\cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Test with 10 real stories\
\pard\pardeftab720\sa320\partightenfactor0
\cf0 API Endpoints:
\f2\b0 \
\pard\tx220\tx720\pardeftab720\li720\fi-720\partightenfactor0
\ls14\ilvl0
\f0\b \cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Create POST /api/transcribe with parallel processing\
\ls14\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Update POST /api/stories to handle lessons\
\ls14\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Create GET /api/prompts/next\
\ls14\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Create POST /api/prompts/skip\
\pard\tx220\tx720\pardeftab720\li720\fi-720\sa320\partightenfactor0
\ls14\ilvl0\cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Test all endpoints\
\pard\pardeftab720\sa320\partightenfactor0
\cf0 Deliverable: Tier 1 templates + lesson extraction working
\f2\b0 \
\pard\pardeftab720\sa106\partightenfactor0

\f0\b\fs34\fsmilli17333 \cf0 Phase 2: Free Tier Magic (Week 2)
\f1\fs28 \
\pard\pardeftab720\sa320\partightenfactor0

\f0\fs24 \cf0 Immediate Processing:
\f2\b0 \
\pard\tx220\tx720\pardeftab720\li720\fi-720\partightenfactor0
\ls15\ilvl0
\f0\b \cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Implement parallel Whisper + GPT-4 calls\
\ls15\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Build lesson extraction with 3 options\
\ls15\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Test 1.7 second target time\
\pard\tx220\tx720\pardeftab720\li720\fi-720\sa320\partightenfactor0
\ls15\ilvl0\cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Integrate with review screen UI\
\pard\pardeftab720\sa320\partightenfactor0
\cf0 Story Analysis:
\f2\b0 \
\pard\tx220\tx720\pardeftab720\li720\fi-720\partightenfactor0
\ls16\ilvl0
\f0\b \cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Write OpenAI prompt for Story 1\
\ls16\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Write OpenAI prompt for Story 2\
\ls16\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Write OpenAI prompt for Story 3\
\ls16\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Build combined analysis function\
\pard\tx220\tx720\pardeftab720\li720\fi-720\sa320\partightenfactor0
\ls16\ilvl0\cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Test conversion flow end-to-end\
\pard\pardeftab720\sa320\partightenfactor0
\cf0 Deliverable: Free tier (Stories 1-3) complete
\f2\b0 \
\pard\pardeftab720\sa106\partightenfactor0

\f0\b\fs34\fsmilli17333 \cf0 Phase 3: Payment Integration (Week 2)
\f1\fs28 \
\pard\pardeftab720\sa320\partightenfactor0

\f0\fs24 \cf0 Stripe Webhook:
\f2\b0 \
\pard\tx220\tx720\pardeftab720\li720\fi-720\partightenfactor0
\ls17\ilvl0
\f0\b \cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Create POST /api/webhooks/stripe\
\ls17\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Handle checkout.session.completed\
\ls17\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Unlock premium seed prompts\
\ls17\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Send welcome email\
\pard\tx220\tx720\pardeftab720\li720\fi-720\sa320\partightenfactor0
\ls17\ilvl0\cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Test with Stripe test mode\
\pard\pardeftab720\sa320\partightenfactor0
\cf0 Grace Period:
\f2\b0 \
\pard\tx220\tx720\pardeftab720\li720\fi-720\partightenfactor0
\ls18\ilvl0
\f0\b \cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Implement 7-day read-only grace\
\ls18\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Schedule emails (Day 1, 3, 5)\
\ls18\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Lock account on Day 7\
\pard\tx220\tx720\pardeftab720\li720\fi-720\sa320\partightenfactor0
\ls18\ilvl0\cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Test full grace period flow\
\pard\pardeftab720\sa320\partightenfactor0
\cf0 Deliverable: Payment \uc0\u8594  unlock flow working
\f2\b0 \
\pard\pardeftab720\sa106\partightenfactor0

\f0\b\fs34\fsmilli17333 \cf0 Phase 4: Paid Tier (Week 3)
\f1\fs28 \
\pard\pardeftab720\sa320\partightenfactor0

\f0\fs24 \cf0 Tier 2 On-Demand:
\f2\b0 \
\pard\tx220\tx720\pardeftab720\li720\fi-720\partightenfactor0
\ls19\ilvl0
\f0\b \cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Write OpenAI prompt template\
\ls19\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Build rate limiter (24 hours)\
\ls19\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Build circuit breaker with fallback\
\pard\tx220\tx720\pardeftab720\li720\fi-720\sa320\partightenfactor0
\ls19\ilvl0\cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Test empty inventory scenario\
\pard\pardeftab720\sa320\partightenfactor0
\cf0 Tier 3 Combined Analysis:
\f2\b0 \
\pard\tx220\tx720\pardeftab720\li720\fi-720\partightenfactor0
\ls20\ilvl0
\f0\b \cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Write combined prompt template\
\ls20\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Build milestone trigger logic\
\ls20\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Integrate character evolution tracking\
\ls20\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Test all milestones\
\pard\tx220\tx720\pardeftab720\li720\fi-720\sa320\partightenfactor0
\ls20\ilvl0\cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Verify background processing\
\pard\pardeftab720\sa320\partightenfactor0
\cf0 Deliverable: Paid tier complete with character insights
\f2\b0 \
\pard\pardeftab720\sa106\partightenfactor0

\f0\b\fs34\fsmilli17333 \cf0 Phase 5: Safety & Quality (Week 3-4)
\f1\fs28 \
\pard\pardeftab720\sa320\partightenfactor0

\f0\fs24 \cf0 Safety Systems:
\f2\b0 \
\pard\tx220\tx720\pardeftab720\li720\fi-720\partightenfactor0
\ls21\ilvl0
\f0\b \cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Build content safety classifier\
\ls21\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Build do_not_ask UI and backend\
\ls21\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Build recent death detection\
\pard\tx220\tx720\pardeftab720\li720\fi-720\sa320\partightenfactor0
\ls21\ilvl0\cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Test all safety filters\
\pard\pardeftab720\sa320\partightenfactor0
\cf0 Quality Systems:
\f2\b0 \
\pard\tx220\tx720\pardeftab720\li720\fi-720\partightenfactor0
\ls22\ilvl0
\f0\b \cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Build lesson quality scoring\
\ls22\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Track lesson acceptance rates\
\ls22\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Build character confidence tracking\
\ls22\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Create weekly health dashboard\
\pard\tx220\tx720\pardeftab720\li720\fi-720\sa320\partightenfactor0
\ls22\ilvl0\cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Document all metrics queries\
\pard\pardeftab720\sa320\partightenfactor0
\cf0 Deliverable: Safety and quality systems operational
\f2\b0 \
\pard\pardeftab720\sa106\partightenfactor0

\f0\b\fs34\fsmilli17333 \cf0 Phase 6: Polish & Launch (Week 4)
\f1\fs28 \
\pard\pardeftab720\sa320\partightenfactor0

\f0\fs24 \cf0 UI/UX:
\f2\b0 \
\pard\tx220\tx720\pardeftab720\li720\fi-720\partightenfactor0
\ls23\ilvl0
\f0\b \cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Review screen with lesson options\
\ls23\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 "Next Story" card component\
\ls23\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Paywall card design\
\ls23\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Character insights display\
\pard\tx220\tx720\pardeftab720\li720\fi-720\sa320\partightenfactor0
\ls23\ilvl0\cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Mobile responsive check\
\pard\pardeftab720\sa320\partightenfactor0
\cf0 Testing:
\f2\b0 \
\pard\tx220\tx720\pardeftab720\li720\fi-720\partightenfactor0
\ls24\ilvl0
\f0\b \cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 End-to-end user journey\
\ls24\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Load testing (1000 concurrent)\
\ls24\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 OpenAI error handling\
\ls24\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Database cleanup job\
\pard\tx220\tx720\pardeftab720\li720\fi-720\sa320\partightenfactor0
\ls24\ilvl0\cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Cost tracking dashboard\
\pard\pardeftab720\sa320\partightenfactor0
\cf0 Launch:
\f2\b0 \
\pard\tx220\tx720\pardeftab720\li720\fi-720\partightenfactor0
\ls25\ilvl0
\f0\b \cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Deploy to production\
\ls25\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Monitor error logs\
\ls25\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Track conversion metrics\
\pard\tx220\tx720\pardeftab720\li720\fi-720\sa320\partightenfactor0
\ls25\ilvl0\cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	\uc0\u8226 	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 A/B test variations\
\pard\pardeftab720\sa320\partightenfactor0
\cf0 Deliverable: System in production with monitoring\

\f2\b0 \
\pard\pardeftab720\sa106\partightenfactor0

\f0\b\fs45\fsmilli22667 \cf0 FINAL NOTES
\f1\fs36 \
\pard\pardeftab720\sa106\partightenfactor0

\f0\fs34\fsmilli17333 \cf0 This Document Contains:
\f1\fs28 \
\pard\pardeftab720\sa320\partightenfactor0

\f0\fs24 \cf0 \uc0\u9989  Complete product context and business goals \u9989  Full system architecture with dual processing \u9989  Detailed user flows for free and paid tiers \u9989  Complete database schema with lesson storage \u9989  All API endpoint specifications \u9989  Parallel processing for 1.7s response time \u9989  Combined milestone analysis for efficiency \u9989  Exact OpenAI prompt templates \u9989  Business logic and algorithms \u9989  Edge case handling and fallback strategies \u9989  Safety and compliance systems \u9989  Metrics, success criteria, and dashboards \u9989  Updated cost model with lesson extraction \u9989  Implementation checklist with phases
\f2\b0 \
\pard\pardeftab720\sa106\partightenfactor0

\f0\b\fs34\fsmilli17333 \cf0 What's NOT in This Document:
\f1\fs28 \
\pard\pardeftab720\sa320\partightenfactor0

\f0\fs24 \cf0 \uc0\u10060  Frontend React code (separate spec) \u10060  Deployment/infrastructure (separate DevOps doc) \u10060  Email templates (separate marketing doc)
\f2\b0 \
\pard\pardeftab720\sa106\partightenfactor0

\f0\b\fs34\fsmilli17333 \cf0 How to Use This Document:
\f1\fs28 \
\pard\tx220\tx720\pardeftab720\li720\fi-720\partightenfactor0
\ls26\ilvl0
\f0\fs24 \cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	1	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Read Section 1 (Product Context) to understand the "why"\
\ls26\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	2	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Read Section 2 (Architecture) to understand the "how"\
\ls26\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	3	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Read Sections 3-9 to implement features\
\ls26\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	4	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Read Section 10 to track success\
\ls26\ilvl0\kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	5	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Read Section 11 to manage costs\
\pard\tx220\tx720\pardeftab720\li720\fi-720\sa320\partightenfactor0
\ls26\ilvl0\cf0 \kerning1\expnd0\expndtw0 \outl0\strokewidth0 {\listtext	6	}\expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 Read Section 12 to plan work\
\pard\pardeftab720\partightenfactor0

\f2\b0 \cf0 \strokec2 \
\
}